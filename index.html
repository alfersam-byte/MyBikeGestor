<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBikeGestor v3.0</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* ========================================
           VARIABLES DE COLORES Y TEMA
        ======================================== */
        :root {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --secondary: #3498db;
            --bg: #f5f6fa;
            --dark: #2c3e50;
            --text: #7f8c8d;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light-gray: #ecf0f1;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        /* ========================================
           ESTILOS GENERALES
        ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* ========================================
           CONTENEDOR PRINCIPAL
        ======================================== */
        #app-container {
            width: 100%;
            max-width: 420px;
            background: var(--white);
            min-height: 600px;
            box-shadow: 0 20px 60px var(--shadow);
            border-radius: 30px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========================================
           SECCIONES / PANTALLAS
        ======================================== */
        .seccion {
            display: none;
            flex-direction: column;
            padding: 30px;
            flex-grow: 1;
            animation: fadeIn 0.3s ease;
        }

        .seccion.activa {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========================================
           HEADER / ENCABEZADOS
        ======================================== */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: var(--dark);
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header .app-name {
            color: var(--primary);
            font-weight: bold;
        }

        .header p {
            color: var(--text);
            font-size: 0.9em;
        }

        /* ========================================
           FORMULARIOS
        ======================================== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ========================================
           BOTONES
        ======================================== */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-secondary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-link {
            background: transparent;
            color: var(--secondary);
            font-size: 0.9em;
            text-decoration: underline;
        }

        .btn-link:hover {
            opacity: 0.8;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* ========================================
           CARDS / TARJETAS
        ======================================== */
        .card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px var(--shadow);
            border-left: 5px solid var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: 700;
            font-size: 1.2em;
            color: var(--dark);
        }

        .card-subtitle {
            color: var(--text);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        /* ========================================
           BADGES / ETIQUETAS
        ======================================== */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge-primary {
            background: #e8f8f0;
            color: var(--primary);
        }

        .badge-secondary {
            background: #e3f2fd;
            color: var(--secondary);
        }

        /* ========================================
           LISTAS
        ======================================== */
        .lista-vacia {
            text-align: center;
            padding: 40px 20px;
            color: var(--text);
        }

        .lista-vacia-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }

        /* ========================================
           BARRA DE NAVEGACI√ìN SUPERIOR
        ======================================== */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: var(--white);
            border-bottom: 1px solid var(--light-gray);
        }

        .topbar-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--dark);
        }

        .btn-back {
            background: var(--light-gray);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: #d5dbdb;
        }

        /* ========================================
           UTILIDADES
        ======================================== */
        .text-center {
            text-align: center;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .text-muted {
            color: var(--text);
            font-size: 0.9em;
        }

        /* ========================================
           MODALES
        ======================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.activo {
            display: flex;
        }

        .modal-contenido {
            background: var(--white);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        /* ========================================
           GRID DE ACCIONES
        ======================================== */
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-grid-item {
            padding: 20px;
            border: none;
            border-radius: 16px;
            background: var(--light-gray);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn-grid-item:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }

        .btn-grid-item-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .btn-grid-item-text {
            font-weight: 600;
            color: var(--dark);
        }

        /* ========================================
           RESPONSIVE
        ======================================== */
        @media (max-width: 480px) {
            #app-container {
                border-radius: 0;
                max-width: 100%;
                min-height: 100vh;
            }

            body {
                padding: 0;
            }
        }

        /* ========================================
           SISTEMA DE NOTIFICACIONES
        ======================================== */
        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notificacion-exito {
            border-left: 4px solid var(--primary);
        }

        .notificacion-error {
            border-left: 4px solid var(--danger);
        }

        .notificacion-info {
            border-left: 4px solid var(--secondary);
        }

        .notificacion-icono {
            font-size: 1.5em;
        }

        .notificacion-texto {
            flex: 1;
            font-weight: 500;
            color: var(--dark);
        }

        /* Modal de confirmaci√≥n personalizado */
        .modal-confirmar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-confirmar.activo {
            display: flex;
        }

        .modal-confirmar-contenido {
            background: white;
            padding: 25px;
            border-radius: 16px;
            max-width: 350px;
            text-align: center;
        }

        .modal-confirmar-titulo {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .modal-confirmar-botones {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

    </style>
</head>
<body>

    <!-- ========================================
         CONTENEDOR PRINCIPAL DE LA APP
    ======================================== -->
    <div id="app-container">

        <!-- ========================================
             SECCI√ìN: LOGIN
        ======================================== -->
        <section id="sec-login" class="seccion activa">
            <!-- Logo de la aplicaci√≥n -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 200px; height: 200px; margin: 0 auto; border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    <img src="/mnt/user-data/uploads/1770839537946_logo5-generator-image__1_.png" alt="MyBikeGestor" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login-usuario" placeholder="tu@email.com">
            </div>

            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="login-password" placeholder="Escribe tu contrase√±a">
            </div>

            <button class="btn btn-primary" onclick="iniciarSesion()">Entrar</button>
            <button class="btn btn-link" onclick="abrirModalRecuperarPassword()" style="margin-top: 10px; font-size: 0.85em;">¬øOlvidaste tu contrase√±a?</button>
            <button class="btn btn-link mt-20" onclick="navegar('sec-registro')">¬øNo tienes cuenta? Reg√≠strate</button>
            
            <div style="text-align: center; margin-top: 30px; font-size: 0.75em; color: var(--text);">
                <a href="#" onclick="event.preventDefault(); navegar('sec-terminos');" style="color: var(--text); text-decoration: underline;">T√©rminos</a>
                <span style="margin: 0 10px;">¬∑</span>
                <a href="#" onclick="event.preventDefault(); navegar('sec-privacidad');" style="color: var(--text); text-decoration: underline;">Privacidad</a>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: REGISTRO
        ======================================== -->
        <section id="sec-registro" class="seccion">
            <div class="header">
                <h1>Crear cuenta</h1>
                <p>√önete a <span class="app-name">MyBikeGestor</span></p>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="reg-email" placeholder="tu@email.com">
            </div>

            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="reg-password" placeholder="M√≠nimo 6 caracteres">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: flex-start; font-weight: normal; cursor: pointer;">
                    <input type="checkbox" id="reg-terminos" style="width: auto; margin-right: 10px; margin-top: 3px; cursor: pointer;">
                    <span style="font-size: 0.85em; color: var(--text);">
                        Acepto los <a href="#" onclick="event.preventDefault(); navegar('sec-terminos');" style="color: var(--primary); text-decoration: underline;">T√©rminos y Condiciones</a> 
                        y la <a href="#" onclick="event.preventDefault(); navegar('sec-privacidad');" style="color: var(--primary); text-decoration: underline;">Pol√≠tica de Privacidad</a>
                    </span>
                </label>
            </div>

            <button class="btn btn-primary" onclick="registrarUsuario()">Crear cuenta</button>
            <button class="btn btn-link mt-20" onclick="navegar('sec-login')">Ya tengo cuenta</button>
        </section>

        <!-- ========================================
             SECCI√ìN: T√âRMINOS Y CONDICIONES
        ======================================== -->
        <section id="sec-terminos" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="history.back()">‚Üê</button>
                <div class="topbar-title">T√©rminos y Condiciones</div>
                <div style="width: 40px;"></div>
            </div>

            <div style="padding: 20px; overflow-y: auto;">
                <h2 style="color: var(--dark); margin-bottom: 15px;">T√©rminos y Condiciones de Uso</h2>
                <p style="color: var(--text); margin-bottom: 15px; font-size: 0.9em;">√öltima actualizaci√≥n: Febrero 2026</p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">1. Aceptaci√≥n de los t√©rminos</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Al acceder y utilizar MyBikeGestor, aceptas estar sujeto a estos t√©rminos y condiciones de uso.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">2. Descripci√≥n del servicio</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    MyBikeGestor es una aplicaci√≥n web que permite a los usuarios gestionar el mantenimiento de sus bicicletas, 
                    registrar componentes, kil√≥metros y llevar un historial de reparaciones.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">3. Uso de la cuenta</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Eres responsable de mantener la confidencialidad de tu contrase√±a y de todas las actividades 
                    que ocurran bajo tu cuenta. Debes notificar inmediatamente cualquier uso no autorizado de tu cuenta.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">4. Contenido del usuario</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Mantienes todos los derechos sobre los datos que introduces en la aplicaci√≥n. MyBikeGestor no 
                    reclamar√° propiedad sobre tu informaci√≥n personal ni sobre los datos de tus bicicletas.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">5. Limitaci√≥n de responsabilidad</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    MyBikeGestor se proporciona "tal cual" sin garant√≠as de ning√∫n tipo. No nos hacemos responsables 
                    de cualquier da√±o directo, indirecto, incidental o consecuente derivado del uso de la aplicaci√≥n.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">6. Modificaciones</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Nos reservamos el derecho de modificar estos t√©rminos en cualquier momento. 
                    Los cambios entrar√°n en vigor inmediatamente despu√©s de su publicaci√≥n.
                </p>

                <button class="btn btn-primary mt-20" onclick="history.back()">Cerrar</button>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: POL√çTICA DE PRIVACIDAD
        ======================================== -->
        <section id="sec-privacidad" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="history.back()">‚Üê</button>
                <div class="topbar-title">Pol√≠tica de Privacidad</div>
                <div style="width: 40px;"></div>
            </div>

            <div style="padding: 20px; overflow-y: auto;">
                <h2 style="color: var(--dark); margin-bottom: 15px;">Pol√≠tica de Privacidad y Protecci√≥n de Datos</h2>
                <p style="color: var(--text); margin-bottom: 15px; font-size: 0.9em;">√öltima actualizaci√≥n: Febrero 2026</p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">1. Responsable del tratamiento</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    El responsable del tratamiento de tus datos personales es el administrador de MyBikeGestor.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">2. Datos que recopilamos</h3>
                <p style="color: var(--text); margin-bottom: 10px; line-height: 1.6;">
                    Recopilamos y almacenamos la siguiente informaci√≥n:
                </p>
                <ul style="color: var(--text); margin-bottom: 15px; line-height: 1.6; padding-left: 20px;">
                    <li>Email (necesario para el registro y recuperaci√≥n de cuenta)</li>
                    <li>Datos de perfil (nombre, apellidos, fecha de nacimiento, datos f√≠sicos - opcional)</li>
                    <li>Informaci√≥n de tus bicicletas (marca, modelo, componentes, kil√≥metros)</li>
                    <li>Historial de mantenimiento</li>
                </ul>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">3. Finalidad del tratamiento</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Utilizamos tus datos exclusivamente para:
                </p>
                <ul style="color: var(--text); margin-bottom: 15px; line-height: 1.6; padding-left: 20px;">
                    <li>Gestionar tu cuenta de usuario</li>
                    <li>Permitirte acceder y utilizar las funcionalidades de la aplicaci√≥n</li>
                    <li>Guardar y sincronizar tus datos entre dispositivos</li>
                </ul>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">4. Base legal</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    El tratamiento de tus datos se basa en tu consentimiento expreso al registrarte y aceptar 
                    estos t√©rminos, as√≠ como en la ejecuci√≥n del contrato de prestaci√≥n del servicio.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">5. Almacenamiento de datos</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Tus datos se almacenan de forma segura en Firebase (Google Cloud Platform) con servidores 
                    ubicados en la Uni√≥n Europea (regi√≥n: europe-southwest1, Madrid).
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">6. Compartir datos con terceros</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    No compartimos, vendemos ni cedemos tus datos personales a terceros. √önicamente utilizamos 
                    Firebase/Google como proveedor de infraestructura t√©cnica.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">7. Tus derechos (RGPD)</h3>
                <p style="color: var(--text); margin-bottom: 10px; line-height: 1.6;">
                    Conforme al RGPD, tienes derecho a:
                </p>
                <ul style="color: var(--text); margin-bottom: 15px; line-height: 1.6; padding-left: 20px;">
                    <li><strong>Acceso:</strong> Conocer qu√© datos personales tenemos sobre ti</li>
                    <li><strong>Rectificaci√≥n:</strong> Corregir datos inexactos o incompletos</li>
                    <li><strong>Supresi√≥n:</strong> Solicitar la eliminaci√≥n de tus datos</li>
                    <li><strong>Portabilidad:</strong> Obtener una copia de tus datos</li>
                    <li><strong>Oposici√≥n:</strong> Oponerte al tratamiento de tus datos</li>
                    <li><strong>Limitaci√≥n:</strong> Solicitar la limitaci√≥n del tratamiento</li>
                </ul>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Para ejercer estos derechos, contacta con el administrador de la aplicaci√≥n.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">8. Seguridad</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Implementamos medidas de seguridad t√©cnicas y organizativas para proteger tus datos personales 
                    contra acceso no autorizado, p√©rdida o alteraci√≥n. Utilizamos Firebase Authentication y Firestore 
                    con cifrado en tr√°nsito y en reposo.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">9. Cookies</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    La aplicaci√≥n utiliza sessionStorage y localStorage para mantener tu sesi√≥n activa y mejorar 
                    la experiencia de usuario. No utilizamos cookies de terceros ni cookies publicitarias.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">10. Cambios en la pol√≠tica</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Podemos actualizar esta pol√≠tica de privacidad ocasionalmente. Te notificaremos de cualquier 
                    cambio significativo.
                </p>

                <button class="btn btn-primary mt-20" onclick="history.back()">Cerrar</button>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: DASHBOARD / MEN√ö PRINCIPAL
        ======================================== -->
        <section id="sec-dashboard" class="seccion">
            <div class="topbar">
                <div class="topbar-title">MyBikeGestor</div>
                <button class="btn-back" onclick="cerrarSesion()">üö™</button>
            </div>

            <!-- Perfil de usuario -->
            <div class="card" style="text-align: center; margin-top: 20px;">
                <div style="font-size: 4em; margin-bottom: 10px;">üë§</div>
                <div class="card-title" id="dashboard-usuario">Usuario</div>
                <div class="card-subtitle" id="dashboard-email">email@ejemplo.com</div>
            </div>

            <!-- Resumen de bicis -->
            <div class="card">
                <div class="card-title">üìä Resumen</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 10px;">
                        <div class="text-muted" style="font-size: 0.8em;">Bicis Activas</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--primary);" id="dashboard-bicis-activas">0</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 10px;">
                        <div class="text-muted" style="font-size: 0.8em;">KM Totales</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--secondary);" id="dashboard-km-totales">0</div>
                    </div>
                </div>
            </div>

            <!-- Botones de navegaci√≥n -->
            <div class="btn-grid">
                <button class="btn-grid-item" onclick="navegar('sec-garaje')" style="grid-column: span 2;">
                    <div class="btn-grid-item-icon">üö¥</div>
                    <div class="btn-grid-item-text">Mi Garaje</div>
                </button>
                <button class="btn-grid-item" onclick="navegar('sec-perfil')">
                    <div class="btn-grid-item-icon">üë§</div>
                    <div class="btn-grid-item-text">Mi Perfil</div>
                </button>
                <button class="btn-grid-item" onclick="mostrarNotificacion('Pr√≥ximamente: Configuraci√≥n', 'info')">
                    <div class="btn-grid-item-icon">‚öôÔ∏è</div>
                    <div class="btn-grid-item-text">Ajustes</div>
                </button>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: PERFIL DE USUARIO
        ======================================== -->
        <section id="sec-perfil" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-dashboard')">‚Üê</button>
                <div class="topbar-title">Mi Perfil</div>
                <div style="width: 40px;"></div>
            </div>

            <div style="text-align: center; margin: 20px 0 30px 0;">
                <div style="font-size: 4em;">üë§</div>
                <div style="font-size: 1.3em; font-weight: bold; color: var(--dark); margin-top: 10px;" id="perfil-nombre-completo">Usuario</div>
            </div>

            <!-- DATOS PERSONALES -->
            <div class="card">
                <div class="card-title" style="margin-bottom: 20px;">üìã Datos Personales</div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="perfil-usuario" disabled style="background: var(--light-gray);">
                </div>

                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="perfil-nombre" placeholder="Tu nombre">
                </div>

                <div class="form-group">
                    <label>Apellidos</label>
                    <input type="text" id="perfil-apellidos" placeholder="Tus apellidos">
                </div>

                <div class="form-group">
                    <label>Fecha de nacimiento</label>
                    <input type="date" id="perfil-fecha-nacimiento">
                </div>

                <!-- Edad calculada -->
                <div id="perfil-edad-display" style="background: var(--light-gray); padding: 12px; border-radius: 10px; text-align: center; display: none;">
                    <span style="color: var(--text); font-size: 0.9em;">Edad: </span>
                    <span style="font-weight: bold; color: var(--primary); font-size: 1.2em;" id="perfil-edad-valor">0 a√±os</span>
                </div>

                <div class="form-group">
                    <label>Nueva contrase√±a (dejar vac√≠o para no cambiar)</label>
                    <input type="password" id="perfil-password" placeholder="Nueva contrase√±a (m√≠nimo 6 caracteres)">
                </div>
            </div>

            <!-- DATOS F√çSICOS -->
            <div class="card mt-20">
                <div class="card-title" style="margin-bottom: 20px;">üí™ Datos F√≠sicos</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Peso (kg)</label>
                        <input type="number" id="perfil-peso" placeholder="70" step="0.1">
                    </div>

                    <div class="form-group">
                        <label>Altura (cm)</label>
                        <input type="number" id="perfil-altura" placeholder="175">
                    </div>
                </div>

                <!-- IMC calculado -->
                <div id="perfil-imc-display" style="background: var(--light-gray); padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; display: none;">
                    <div style="color: var(--text); font-size: 0.85em; margin-bottom: 5px;">√çndice de Masa Corporal (IMC)</div>
                    <div style="font-weight: bold; font-size: 1.8em; margin-bottom: 5px;" id="perfil-imc-valor">0.0</div>
                    <div style="font-size: 0.85em; font-weight: 600;" id="perfil-imc-categoria">-</div>
                </div>

                <div class="form-group">
                    <label>FTP - Potencia Umbral (W)</label>
                    <input type="number" id="perfil-ftp" placeholder="200">
                </div>

                <div class="form-group">
                    <label>FC M√°xima (ppm)</label>
                    <input type="number" id="perfil-fc-max" placeholder="190">
                </div>

                <div class="form-group">
                    <label>VO2 Max (ml/kg/min)</label>
                    <input type="number" id="perfil-vo2max" placeholder="50" step="0.1">
                </div>
            </div>

            <!-- INTEGRACI√ìN CON STRAVA -->
            <div class="card mt-20">
                <div class="card-title" style="margin-bottom: 20px;">üö¥ Conexi√≥n con Strava</div>
                
                <div id="strava-desconectado" style="display: none;">
                    <p style="color: var(--text); margin-bottom: 15px; font-size: 0.9em;">
                        Conecta tu cuenta de Strava para sincronizar autom√°ticamente los kil√≥metros de tus salidas.
                    </p>
                    <!-- Bot√≥n oficial de Strava seg√∫n brand guidelines -->
                    <button onclick="conectarStrava()" style="background: #FC4C02; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#E34402'" onmouseout="this.style.background='#FC4C02'">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169" fill="white"/>
                        </svg>
                        Connect with Strava
                    </button>
                </div>

                <div id="strava-conectado" style="display: none;">
                    <div style="background: var(--light-gray); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">‚úÖ</span>
                            <div>
                                <div style="font-weight: bold; color: var(--primary);">Conectado con Strava</div>
                                <div style="font-size: 0.85em; color: var(--text);" id="strava-atleta-nombre">Atleta</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="sincronizarStravaManual()">
                        üîÑ Sincronizar ahora
                    </button>
                    <button class="btn btn-danger mt-10" onclick="desconectarStrava()">
                        Desconectar Strava
                    </button>
                </div>

                <div id="strava-cargando" style="display: none; text-align: center; padding: 20px;">
                    <div style="font-size: 2em;">‚è≥</div>
                    <div style="margin-top: 10px; color: var(--text);">Conectando con Strava...</div>
                </div>
            </div>

            <button class="btn btn-primary mt-20" onclick="guardarPerfil()">Guardar Cambios</button>
            <button class="btn btn-secondary mt-20" onclick="navegar('sec-dashboard')">Volver</button>
        </section>

        <!-- ========================================
             SECCI√ìN: GARAJE (LISTA DE BICIS)
        ======================================== -->
        <section id="sec-garaje" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-dashboard')">‚Üê</button>
                <div class="topbar-title">Mi Garaje üö¥</div>
                <div style="width: 40px;"></div>
            </div>

            <div id="lista-bicis" class="mt-20">
                <!-- Aqu√≠ se generar√°n las tarjetas de las bicis -->
            </div>

            <button class="btn btn-primary mt-20" onclick="navegar('sec-nueva-bici')">‚ûï A√±adir Bicicleta</button>
            
            <!-- Bot√≥n para ver bicis retiradas (solo visible si hay alguna) -->
            <button id="btn-ver-retiradas" class="btn btn-secondary mt-20" style="display: none;" onclick="navegar('sec-bicis-retiradas')">
                üì¶ Ver Bicis Retiradas
            </button>
        </section>

        <!-- ========================================
             SECCI√ìN: NUEVA BICICLETA
        ======================================== -->
        <section id="sec-nueva-bici" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-garaje')">‚Üê</button>
                <div class="topbar-title">Nueva Bici</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="form-group">
                <label>Alias / Nombre</label>
                <input type="text" id="nueva-alias" placeholder="Ej: La Bestia">
            </div>

            <div class="form-group">
                <label>Marca</label>
                <select id="nueva-marca">
                    <option value="">Selecciona una marca</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Trek">Trek</option>
                    <option value="Giant">Giant</option>
                    <option value="Canyon">Canyon</option>
                    <option value="Scott">Scott</option>
                    <option value="Cannondale">Cannondale</option>
                    <option value="Cerv√©lo">Cerv√©lo</option>
                    <option value="Pinarello">Pinarello</option>
                    <option value="Bianchi">Bianchi</option>
                    <option value="BMC">BMC</option>
                    <option value="Cube">Cube</option>
                    <option value="Merida">Merida</option>
                    <option value="Orbea">Orbea</option>
                    <option value="BH">BH</option>
                    <option value="Colnago">Colnago</option>
                    <option value="Wilier">Wilier</option>
                    <option value="Focus">Focus</option>
                    <option value="Santa Cruz">Santa Cruz</option>
                    <option value="Pivot">Pivot</option>
                    <option value="Yeti">Yeti</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="nueva-modelo" placeholder="Ej: Ultimate CF SLX">
            </div>

            <div class="form-group">
                <label>Disciplina</label>
                <select id="nueva-disciplina">
                    <option value="Carretera">Carretera</option>
                    <option value="MTB">MTB</option>
                    <option value="Gravel">Gravel</option>
                    <option value="Urbana">Urbana</option>
                    <option value="El√©ctrica">El√©ctrica</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group">
                <label>Fecha de compra</label>
                <input type="date" id="nueva-fecha" value="">
            </div>

            <div class="form-group">
                <label>Kil√≥metros iniciales (opcional)</label>
                <input type="number" id="nueva-km" placeholder="0" value="0">
            </div>

            <button class="btn btn-primary" onclick="crearBicicleta()">Crear Bicicleta</button>
            <button class="btn btn-secondary mt-20" onclick="navegar('sec-garaje')">Cancelar</button>
        </section>

        <!-- ========================================
             SECCI√ìN: BICIS RETIRADAS
        ======================================== -->
        <section id="sec-bicis-retiradas" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-garaje')">‚Üê</button>
                <div class="topbar-title">Bicis Retiradas üì¶</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="text-muted text-center mb-20">
                <p>Aqu√≠ est√°n las bicis que has retirado del garaje activo</p>
            </div>

            <div id="lista-bicis-retiradas" class="mt-20">
                <!-- Aqu√≠ se generar√°n las tarjetas de las bicis retiradas -->
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: DETALLE DE BICI / TALLER
        ======================================== -->
        <section id="sec-taller" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-garaje')">‚Üê</button>
                <div class="topbar-title" id="taller-nombre-bici">Taller</div>
                <button class="btn-back" onclick="mostrarMenuBici()">‚öôÔ∏è</button>
            </div>

            <!-- Resumen de la bici -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title" id="taller-alias" style="font-size: 1.3em; font-weight: 700;"></div>
                        <div class="card-subtitle" id="taller-modelo" style="font-size: 1em; font-weight: 600; color: var(--text);"></div>
                    </div>
                    <span class="badge badge-primary" id="taller-disciplina" style="font-weight: 600;"></span>
                </div>
                
                <!-- Indicador de Strava -->
                <div id="taller-strava-vinculado" style="background: #FC4C02; color: white; padding: 8px 12px; border-radius: 8px; margin-top: 15px; font-size: 0.85em; display: none; text-align: center;">
                    üö¥ Vinculada con Strava: <span id="taller-strava-nombre" style="font-weight: bold;"></span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px;">
                        <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); margin-bottom: 5px; font-weight: 600;">Kil√≥metros</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--primary);" id="taller-km">0</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px;">
                        <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); margin-bottom: 5px; font-weight: 600;">Uso</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--primary);" id="taller-uso">0 d√≠as</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px;">
                        <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); margin-bottom: 5px; font-weight: 600;">Peso</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--secondary);" id="taller-peso">0</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px;">
                        <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); margin-bottom: 5px; font-weight: 600;">Inversi√≥n</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--warning);" id="taller-inversion">0‚Ç¨</div>
                    </div>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="btn-grid">
                <button class="btn-grid-item" onclick="navegar('sec-componentes')">
                    <div class="btn-grid-item-icon">üîß</div>
                    <div class="btn-grid-item-text">Componentes</div>
                </button>
                <button class="btn-grid-item" onclick="navegar('sec-historial')">
                    <div class="btn-grid-item-icon">üìã</div>
                    <div class="btn-grid-item-text">Historial</div>
                </button>
                <button class="btn-grid-item" onclick="abrirModalKm()">
                    <div class="btn-grid-item-icon">üìè</div>
                    <div class="btn-grid-item-text">A√±adir KM</div>
                </button>
                <button class="btn-grid-item" onclick="abrirModalVincularStrava()">
                    <div class="btn-grid-item-icon">üö¥</div>
                    <div class="btn-grid-item-text">Vincular Strava</div>
                </button>
                <button class="btn-grid-item" onclick="mostrarNotificacion('Pr√≥ximamente: Estad√≠sticas', 'info')">
                    <div class="btn-grid-item-icon">üìä</div>
                    <div class="btn-grid-item-text">Estad√≠sticas</div>
                </button>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: COMPONENTES
        ======================================== -->
        <section id="sec-componentes" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="volverATaller()">‚Üê</button>
                <div class="topbar-title">Componentes</div>
                <div style="width: 40px;"></div>
            </div>

            <p style="color: var(--text); margin: 20px 0; text-align: center;">Selecciona una secci√≥n para gestionar sus componentes</p>

            <!-- Grid de secciones -->
            <div id="grid-secciones-componentes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                <!-- Se generar√° din√°micamente seg√∫n la disciplina -->
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: LISTA COMPONENTES DE UNA SECCI√ìN
        ======================================== -->
        <section id="sec-lista-componentes-seccion" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-componentes')">‚Üê</button>
                <div class="topbar-title" id="titulo-seccion-componentes">Secci√≥n</div>
                <div style="width: 40px;"></div>
            </div>

            <div id="lista-componentes-seccion" class="mt-20">
                <!-- Se generar√° din√°micamente -->
            </div>

            <button class="btn btn-primary mt-20" onclick="abrirModalNuevoComponente()">‚ûï A√±adir Componente</button>
        </section>

        <!-- ========================================
             SECCI√ìN: DETALLE COMPONENTE
        ======================================== -->
        <section id="sec-detalle-componente" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="volverAListaComponentes()">‚Üê</button>
                <div class="topbar-title" id="titulo-detalle-componente">Componente</div>
                <div style="width: 40px;"></div>
            </div>

            <!-- Datos del componente -->
            <div class="card">
                <div class="card-title" id="detalle-comp-nombre">-</div>
                <div style="margin-top: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                        <div>
                            <span style="color: var(--text);">Marca:</span>
                            <div style="font-weight: bold;" id="detalle-comp-marca">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Modelo:</span>
                            <div style="font-weight: bold;" id="detalle-comp-modelo">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Material:</span>
                            <div style="font-weight: bold;" id="detalle-comp-material">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Peso:</span>
                            <div style="font-weight: bold;" id="detalle-comp-peso">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Km instalaci√≥n:</span>
                            <div style="font-weight: bold; color: var(--primary);" id="detalle-comp-km">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Km actuales:</span>
                            <div style="font-weight: bold; color: var(--primary);" id="detalle-comp-km-uso">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Fecha inst.:</span>
                            <div style="font-weight: bold;" id="detalle-comp-fecha">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Precio:</span>
                            <div style="font-weight: bold; color: var(--warning);" id="detalle-comp-precio">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="btn-grid" style="grid-template-columns: repeat(3, 1fr);">
                <button class="btn-grid-item" onclick="editarComponenteActual()">
                    <div class="btn-grid-item-icon">‚úèÔ∏è</div>
                    <div class="btn-grid-item-text">Editar</div>
                </button>
                <button class="btn-grid-item" onclick="repararComponenteActual()">
                    <div class="btn-grid-item-icon">üîß</div>
                    <div class="btn-grid-item-text">Reparar</div>
                </button>
                <button class="btn-grid-item" onclick="sustituirComponenteActual()">
                    <div class="btn-grid-item-icon">üîÑ</div>
                    <div class="btn-grid-item-text">Sustituir</div>
                </button>
            </div>

            <!-- Subpiezas (si las tiene) -->
            <div id="subpiezas-container" style="display: none; margin-top: 20px;">
                <div class="card">
                    <div class="card-title">Subpiezas</div>
                    <div id="lista-subpiezas" style="margin-top: 15px;">
                        <!-- Se genera din√°micamente -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: HISTORIAL
        ======================================== -->
        <section id="sec-historial" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="volverATaller()">‚Üê</button>
                <div class="topbar-title">Historial</div>
                <div style="width: 40px;"></div>
            </div>

            <div id="lista-historial" class="mt-20">
                <div class="lista-vacia">
                    <div class="lista-vacia-icon">üìã</div>
                    <p>No hay registros de mantenimiento</p>
                </div>
            </div>

            <button class="btn btn-primary mt-20" onclick="abrirModalNuevoMantenimiento()">‚ûï Registrar Mantenimiento</button>
        </section>

    </div>

    <!-- ========================================
         MODAL: A√ëADIR KIL√ìMETROS
    ======================================== -->
    <div id="modal-km" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-title">A√±adir Kil√≥metros</h2>
            </div>
            <div class="form-group">
                <label>¬øCu√°ntos km has hecho?</label>
                <input type="number" id="input-km" placeholder="Ej: 50">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cerrarModal('modal-km')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarKm()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: NUEVO COMPONENTE
    ======================================== -->
    <div id="modal-componente" class="modal">
        <div class="modal-contenido" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-componente-titulo">Nuevo Componente</h2>
            </div>
            
            <!-- Tipo de componente (select que se genera din√°micamente) -->
            <div class="form-group">
                <label>Tipo de componente</label>
                <select id="comp-tipo">
                    <option value="">-- Selecciona --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Marca</label>
                <select id="comp-marca">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Canyon">Canyon</option>
                    <option value="Campagnolo">Campagnolo</option>
                    <option value="Continental">Continental</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Fizik">Fizik</option>
                    <option value="Fox">Fox</option>
                    <option value="Garmin">Garmin</option>
                    <option value="Kodak">Kodak</option>
                    <option value="Look">Look</option>
                    <option value="Maxxis">Maxxis</option>
                    <option value="Michelin">Michelin</option>
                    <option value="Pirelli">Pirelli</option>
                    <option value="Pro">Pro</option>
                    <option value="RockShox">RockShox</option>
                    <option value="Schwalbe">Schwalbe</option>
                    <option value="Selle Italia">Selle Italia</option>
                    <option value="Shimano">Shimano</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Sram">Sram</option>
                    <option value="Varta">Varta</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group" id="comp-marca-otra-container" style="display: none;">
                <label>Especifica la marca</label>
                <input type="text" id="comp-marca-otra" placeholder="Nombre de la marca">
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="comp-modelo" placeholder="Ej: Ultegra R8100">
            </div>

            <div class="form-group">
                <label>Material</label>
                <select id="comp-material">
                    <option value="">-- Selecciona --</option>
                    <option value="Acero">Acero</option>
                    <option value="Aluminio">Aluminio</option>
                    <option value="Carbono">Carbono</option>
                    <option value="Caucho">Caucho</option>
                    <option value="Cromo">Cromo</option>
                    <option value="Pl√°stico">Pl√°stico</option>
                    <option value="TPU">TPU</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group" id="comp-material-otro-container" style="display: none;">
                <label>Especifica el material</label>
                <input type="text" id="comp-material-otro" placeholder="Nombre del material">
            </div>

            <div class="form-group">
                <label>Peso (gramos)</label>
                <input type="number" id="comp-peso" placeholder="0" step="1">
            </div>

            <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="comp-precio" placeholder="0" step="0.01">
            </div>

            <div class="form-group">
                <label>Fecha de instalaci√≥n</label>
                <input type="date" id="comp-fecha-instalacion">
            </div>

            <div class="form-group">
                <label>Km en instalaci√≥n</label>
                <input type="number" id="comp-km-instalacion" placeholder="0" step="1">
            </div>

            <!-- Campos extra seg√∫n tipo de componente -->
            <div id="comp-campos-extra">
                <!-- Se generan din√°micamente -->
            </div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cerrarModal('modal-componente')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarComponente()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: REPARAR COMPONENTE
    ======================================== -->
    <div id="modal-reparar" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-title">Reparar Componente</h2>
                <p style="color: var(--text); font-size: 0.9em; margin-top: 10px;" id="reparar-componente-nombre">-</p>
            </div>
            <div class="form-group">
                <label>Descripci√≥n de la reparaci√≥n</label>
                <textarea id="reparar-descripcion" placeholder="¬øQu√© se ha reparado?"></textarea>
            </div>
            <div class="form-group">
                <label>Lugar</label>
                <select id="reparar-lugar">
                    <option value="Taller">Taller</option>
                    <option value="En casa">En casa</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="reparar-fecha">
            </div>
            <div class="form-group">
                <label>Km actuales de la bici</label>
                <input type="number" id="reparar-km" placeholder="0" step="1">
            </div>
            <div class="form-group">
                <label>Coste (‚Ç¨)</label>
                <input type="number" id="reparar-coste" placeholder="0" step="0.01">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cerrarModal('modal-reparar')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarReparacion()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: SUSTITUIR COMPONENTE
    ======================================== -->
    <div id="modal-sustituir" class="modal">
        <div class="modal-contenido" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">Sustituir Componente</h2>
                <p style="color: var(--text); font-size: 0.9em; margin-top: 10px;">Se guardar√° el historial del componente antiguo</p>
            </div>

            <!-- Resumen componente antiguo -->
            <div class="card" style="background: var(--light-gray); margin-bottom: 20px;">
                <div style="font-size: 0.85em; color: var(--text); margin-bottom: 5px;">Componente a sustituir:</div>
                <div style="font-weight: bold;" id="sustituir-componente-viejo">-</div>
                <div style="margin-top: 10px; font-size: 0.9em;">
                    <div>Km instalaci√≥n: <strong id="sustituir-km-instalacion">-</strong></div>
                    <div>Km actuales: <strong id="sustituir-km-actual">-</strong></div>
                    <div style="color: var(--primary); font-weight: bold;">Duraci√≥n: <span id="sustituir-duracion-km">-</span> km</div>
                </div>
            </div>

            <!-- Datos del nuevo componente -->
            <p style="font-weight: bold; margin-bottom: 15px;">Datos del nuevo componente:</p>

            <div class="form-group">
                <label>Marca</label>
                <select id="sustituir-marca">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Canyon">Canyon</option>
                    <option value="Campagnolo">Campagnolo</option>
                    <option value="Continental">Continental</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Fizik">Fizik</option>
                    <option value="Fox">Fox</option>
                    <option value="Garmin">Garmin</option>
                    <option value="Kodak">Kodak</option>
                    <option value="Look">Look</option>
                    <option value="Maxxis">Maxxis</option>
                    <option value="Michelin">Michelin</option>
                    <option value="Pirelli">Pirelli</option>
                    <option value="Pro">Pro</option>
                    <option value="RockShox">RockShox</option>
                    <option value="Schwalbe">Schwalbe</option>
                    <option value="Selle Italia">Selle Italia</option>
                    <option value="Shimano">Shimano</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Sram">Sram</option>
                    <option value="Varta">Varta</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group" id="sustituir-marca-otra-container" style="display: none;">
                <label>Especifica la marca</label>
                <input type="text" id="sustituir-marca-otra" placeholder="Nombre de la marca">
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="sustituir-modelo" placeholder="Ej: Ultegra R8100">
            </div>

            <div class="form-group">
                <label>Material</label>
                <select id="sustituir-material">
                    <option value="">-- Selecciona --</option>
                    <option value="Acero">Acero</option>
                    <option value="Aluminio">Aluminio</option>
                    <option value="Carbono">Carbono</option>
                    <option value="Caucho">Caucho</option>
                    <option value="Cromo">Cromo</option>
                    <option value="Pl√°stico">Pl√°stico</option>
                    <option value="TPU">TPU</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group" id="sustituir-material-otro-container" style="display: none;">
                <label>Especifica el material</label>
                <input type="text" id="sustituir-material-otro" placeholder="Nombre del material">
            </div>

            <div class="form-group">
                <label>Peso (gramos)</label>
                <input type="number" id="sustituir-peso" placeholder="0" step="1">
            </div>

            <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="sustituir-precio" placeholder="0" step="0.01">
            </div>

            <div class="form-group">
                <label>Fecha de sustituci√≥n</label>
                <input type="date" id="sustituir-fecha">
            </div>

            <div class="form-group">
                <label>Km de la bici en la sustituci√≥n</label>
                <input type="number" id="sustituir-km" placeholder="0" step="1">
            </div>

            <!-- Campos extra seg√∫n tipo -->
            <div id="sustituir-campos-extra"></div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cerrarModal('modal-sustituir')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarSustitucion()">Sustituir</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: SUBPIEZA (A√ëADIR/EDITAR/SUSTITUIR)
    ======================================== -->
    <div id="modal-subpieza" class="modal">
        <div class="modal-contenido" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-subpieza-titulo">A√±adir Subpieza</h2>
                <p style="color: var(--text); font-size: 0.9em; margin-top: 10px;" id="modal-subpieza-subtitulo">-</p>
            </div>

            <!-- Datos heredados del padre (solo lectura visual) -->
            <div class="card" style="background: var(--light-gray); margin-bottom: 20px;" id="subpieza-datos-heredados">
                <div style="font-size: 0.85em; color: var(--text); margin-bottom: 5px;">Datos heredados del componente principal:</div>
                <div style="font-size: 0.9em;">
                    <div>Marca: <strong id="subpieza-heredada-marca">-</strong></div>
                    <div>Modelo: <strong id="subpieza-heredada-modelo">-</strong></div>
                    <div>Material: <strong id="subpieza-heredada-material">-</strong></div>
                    <div>Fecha: <strong id="subpieza-heredada-fecha">-</strong></div>
                    <div>Km: <strong id="subpieza-heredada-km">-</strong></div>
                </div>
                <div style="font-size: 0.85em; color: var(--text); margin-top: 10px;">Puedes modificar cualquier campo si es necesario</div>
            </div>

            <div class="form-group">
                <label>Marca</label>
                <select id="subpieza-marca">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Canyon">Canyon</option>
                    <option value="Campagnolo">Campagnolo</option>
                    <option value="Continental">Continental</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Fizik">Fizik</option>
                    <option value="Fox">Fox</option>
                    <option value="Garmin">Garmin</option>
                    <option value="Kodak">Kodak</option>
                    <option value="Look">Look</option>
                    <option value="Maxxis">Maxxis</option>
                    <option value="Michelin">Michelin</option>
                    <option value="Pirelli">Pirelli</option>
                    <option value="Pro">Pro</option>
                    <option value="RockShox">RockShox</option>
                    <option value="Schwalbe">Schwalbe</option>
                    <option value="Selle Italia">Selle Italia</option>
                    <option value="Shimano">Shimano</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Sram">Sram</option>
                    <option value="Varta">Varta</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group" id="subpieza-marca-otra-container" style="display: none;">
                <label>Especifica la marca</label>
                <input type="text" id="subpieza-marca-otra" placeholder="Nombre de la marca">
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="subpieza-modelo" placeholder="Ej: Ultegra R8100">
            </div>

            <div class="form-group">
                <label>Material</label>
                <select id="subpieza-material">
                    <option value="">-- Selecciona --</option>
                    <option value="Acero">Acero</option>
                    <option value="Aluminio">Aluminio</option>
                    <option value="Carbono">Carbono</option>
                    <option value="Caucho">Caucho</option>
                    <option value="Cromo">Cromo</option>
                    <option value="Pl√°stico">Pl√°stico</option>
                    <option value="TPU">TPU</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group" id="subpieza-material-otro-container" style="display: none;">
                <label>Especifica el material</label>
                <input type="text" id="subpieza-material-otro" placeholder="Nombre del material">
            </div>

            <div class="form-group">
                <label>Peso (gramos)</label>
                <input type="number" id="subpieza-peso" placeholder="0" step="1">
            </div>

            <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="subpieza-precio" placeholder="0" step="0.01">
            </div>

            <div class="form-group">
                <label>Fecha de instalaci√≥n</label>
                <input type="date" id="subpieza-fecha">
            </div>

            <div class="form-group">
                <label>Km en instalaci√≥n</label>
                <input type="number" id="subpieza-km" placeholder="0" step="1">
            </div>

            <!-- Campos espec√≠ficos seg√∫n tipo de subpieza -->
            <div id="subpieza-campos-especificos"></div>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cerrarModal('modal-subpieza')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarSubpieza()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: NUEVO MANTENIMIENTO
    ======================================== -->
    <div id="modal-mantenimiento" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-title">Registrar Mantenimiento</h2>
            </div>
            <div class="form-group">
                <label>Tipo</label>
                <select id="mant-tipo">
                    <option value="Reparaci√≥n">Reparaci√≥n</option>
                    <option value="Sustituci√≥n">Sustituci√≥n</option>
                    <option value="Mejora">Mejora</option>
                </select>
            </div>
            <div class="form-group">
                <label>Componente/Pieza</label>
                <input type="text" id="mant-pieza" placeholder="Ej: Cadena">
            </div>
            <div class="form-group">
                <label>Descripci√≥n</label>
                <textarea id="mant-descripcion" placeholder="¬øQu√© has hecho?"></textarea>
            </div>
            <div class="form-group">
                <label>Coste (‚Ç¨)</label>
                <input type="number" id="mant-coste" placeholder="0">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cerrarModal('modal-mantenimiento')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarMantenimiento()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: RECUPERAR CONTRASE√ëA
    ======================================== -->
    <div id="modal-recuperar-password" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-title">Recuperar contrase√±a</h2>
                <p style="color: var(--text); font-size: 0.9em; margin-top: 10px;">
                    Introduce tu email y te enviaremos un enlace para restablecer tu contrase√±a.
                </p>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="recuperar-email" placeholder="tu@email.com">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="cerrarModal('modal-recuperar-password')">Cancelar</button>
                <button class="btn btn-primary" onclick="enviarEmailRecuperacion()">Enviar enlace</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: VINCULAR BICI CON STRAVA
    ======================================== -->
    <div id="modal-vincular-strava" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-title">Vincular con Strava</h2>
                <p style="color: var(--text); font-size: 0.9em; margin-top: 10px;">
                    Selecciona qu√© bici de Strava corresponde a "<span id="vincular-bici-nombre"></span>"
                </p>
            </div>
            <div id="vincular-strava-no-conectado" style="display: none;">
                <p style="color: var(--text); margin-bottom: 15px;">
                    Primero debes conectar tu cuenta de Strava desde el perfil.
                </p>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="cerrarModal('modal-vincular-strava')">Cerrar</button>
                    <button class="btn btn-primary" onclick="cerrarModal('modal-vincular-strava'); navegar('sec-perfil')">Ir al perfil</button>
                </div>
            </div>
            <div id="vincular-strava-conectado" style="display: none;">
                <div class="form-group">
                    <label>Bici de Strava</label>
                    <select id="vincular-strava-select">
                        <option value="">-- No vincular / Desvincular --</option>
                    </select>
                </div>
                <div id="vincular-bici-actual" style="background: var(--light-gray); padding: 12px; border-radius: 10px; margin-bottom: 15px; display: none;">
                    <div style="font-size: 0.85em; color: var(--text); margin-bottom: 5px;">Actualmente vinculada con:</div>
                    <div style="font-weight: bold; color: var(--primary);" id="vincular-bici-actual-nombre">-</div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="cerrarModal('modal-vincular-strava')">Cancelar</button>
                    <button class="btn btn-primary" onclick="guardarVinculacionStrava()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: CONFIRMACI√ìN PERSONALIZADO
    ======================================== -->
    <div id="modal-confirmar" class="modal-confirmar">
        <div class="modal-confirmar-contenido">
            <div class="modal-confirmar-titulo" id="confirmar-titulo">¬øEst√°s seguro?</div>
            <div id="confirmar-mensaje"></div>
            <div class="modal-confirmar-botones">
                <button class="btn btn-secondary" onclick="cerrarConfirmacion()">Cancelar</button>
                <button class="btn btn-danger" id="btn-confirmar-accion">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         JAVASCRIPT - L√ìGICA DE LA APP
    ======================================== -->
    <script>
        // ========================================
        // CONFIGURACI√ìN DE FIREBASE
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDoF3qgC8a_OGyLMA4bEVgjxo8flL6TTWU",
            authDomain: "mybikegestor.firebaseapp.com",
            projectId: "mybikegestor",
            storageBucket: "mybikegestor.firebasestorage.app",
            messagingSenderId: "553350408189",
            appId: "1:553350408189:web:e16d29ca1cded704849b94"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ========================================
        // CONFIGURACI√ìN DE STRAVA
        // ========================================
        const STRAVA_CLIENT_ID = '201273';
        const STRAVA_CLIENT_SECRET = '778fd4bdc03d2ffbb57bb52f83c5ae6b4f73a776';
        const STRAVA_REDIRECT_URI = window.location.hostname === 'localhost' 
            ? 'http://localhost:5500' 
            : 'https://alfersam-byte.github.io/MyBikeGestor/';
        const STRAVA_AUTH_URL = 'https://www.strava.com/oauth/authorize';
        const STRAVA_TOKEN_URL = 'https://www.strava.com/oauth/token';
        const STRAVA_API_URL = 'https://www.strava.com/api/v3';

        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let usuarioActual = null;
        let datosUsuario = null; // Datos del usuario desde Firestore
        let biciActual = null;
        let callbackConfirmacion = null;

        // ========================================
        // FUNCIONES AUXILIARES
        // ========================================
        
        // Formatear fecha de YYYY-MM-DD a DD/MM/YYYY
        function formatearFecha(fechaISO) {
            if (!fechaISO) return '-';
            const partes = fechaISO.split('T')[0].split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        
        // Formatear duraci√≥n de d√≠as a formato aa/mm/dd
        function formatearDuracion(dias) {
            if (!dias || dias < 0) return '0d';
            
            const a√±os = Math.floor(dias / 365);
            const meses = Math.floor((dias % 365) / 30);
            const diasRestantes = Math.floor(dias % 30);
            
            const partes = [];
            if (a√±os > 0) partes.push(`${a√±os}a`);
            if (meses > 0) partes.push(`${meses}m`);
            if (diasRestantes > 0 || partes.length === 0) partes.push(`${diasRestantes}d`);
            
            return partes.join(' ');
        }

        // ========================================
        // FUNCIONES DE FIREBASE AUTH Y FIRESTORE
        // ========================================
        
        // Cargar datos del usuario actual desde Firestore
        async function cargarDatosUsuario(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    datosUsuario = { id: doc.id, ...doc.data() };
                    console.log('Datos del usuario cargados');
                } else {
                    // Si no existe, crear documento inicial
                    datosUsuario = {
                        id: uid,
                        email: auth.currentUser.email,
                        garaje: [],
                        fechaRegistro: new Date().toISOString()
                    };
                    await db.collection('usuarios').doc(uid).set(datosUsuario);
                    console.log('Documento de usuario creado');
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
                mostrarNotificacion('Error al cargar datos', 'error');
            }
        }

        // Guardar datos del usuario en Firestore
        async function guardarDatosUsuario() {
            if (!datosUsuario || !datosUsuario.id) {
                console.error('No hay datos de usuario o falta el ID');
                mostrarNotificacion('Error: No se puede guardar sin ID de usuario', 'error');
                return;
            }
            
            try {
                await db.collection('usuarios').doc(datosUsuario.id).set(datosUsuario);
                console.log('Datos guardados en Firestore con ID:', datosUsuario.id);
            } catch (error) {
                console.error('Error guardando datos:', error);
                mostrarNotificacion('Error al guardar datos. Intenta de nuevo.', 'error');
            }
        }

        // ========================================
        // SISTEMA DE NOTIFICACIONES
        // ========================================
        function mostrarNotificacion(mensaje, tipo = 'exito') {
            // Eliminar notificaci√≥n anterior si existe
            const notifAnterior = document.querySelector('.notificacion');
            if (notifAnterior) notifAnterior.remove();

            const iconos = {
                'exito': '‚úì',
                'error': '‚úó',
                'info': '‚Ñπ'
            };

            const notif = document.createElement('div');
            notif.className = `notificacion notificacion-${tipo}`;
            notif.innerHTML = `
                <div class="notificacion-icono">${iconos[tipo]}</div>
                <div class="notificacion-texto">${mensaje}</div>
            `;

            document.body.appendChild(notif);

            // Auto-eliminar despu√©s de 3 segundos
            setTimeout(() => {
                notif.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function confirmar(titulo, mensaje, callback) {
            document.getElementById('confirmar-titulo').textContent = titulo;
            document.getElementById('confirmar-mensaje').textContent = mensaje;
            document.getElementById('modal-confirmar').classList.add('activo');
            
            // Guardar el callback para ejecutarlo si confirma
            callbackConfirmacion = callback;
            
            // Asignar el evento al bot√≥n
            document.getElementById('btn-confirmar-accion').onclick = () => {
                if (callbackConfirmacion) callbackConfirmacion();
                cerrarConfirmacion();
            };
        }

        function cerrarConfirmacion() {
            document.getElementById('modal-confirmar').classList.remove('activo');
            callbackConfirmacion = null;
        }

        // ========================================
        // SISTEMA DE NAVEGACI√ìN
        // ========================================
        function navegar(seccionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(sec => {
                sec.classList.remove('activa');
            });

            // Mostrar la secci√≥n seleccionada
            document.getElementById(seccionId).classList.add('activa');

            // Cargar datos seg√∫n la secci√≥n
            if (seccionId === 'sec-dashboard') {
                cargarDashboard();
            } else if (seccionId === 'sec-garaje') {
                cargarGaraje();
            } else if (seccionId === 'sec-taller') {
                cargarTaller();
            } else if (seccionId === 'sec-componentes') {
                cargarSeccionesComponentes();
            } else if (seccionId === 'sec-historial') {
                cargarHistorial();
            } else if (seccionId === 'sec-bicis-retiradas') {
                cargarBicisRetiradas();
            } else if (seccionId === 'sec-perfil') {
                cargarPerfil();
            }
        }

        // ========================================
        // DASHBOARD
        // ========================================
        function cargarDashboard() {
            if (!usuarioActual || !datosUsuario) return;

            // Datos del usuario - mostrar nombre completo si existe
            const nombreCompleto = datosUsuario.nombre && datosUsuario.apellidos 
                ? `${datosUsuario.nombre} ${datosUsuario.apellidos}` 
                : datosUsuario.email;
            
            document.getElementById('dashboard-usuario').textContent = nombreCompleto;
            document.getElementById('dashboard-email').textContent = datosUsuario.email || 'Sin email';

            // Resumen de bicis
            const bicisActivas = datosUsuario.garaje.filter(b => b.activa !== false);
            const kmTotales = bicisActivas.reduce((total, bici) => total + (bici.kmTotales || 0), 0);

            document.getElementById('dashboard-bicis-activas').textContent = bicisActivas.length;
            document.getElementById('dashboard-km-totales').textContent = kmTotales.toLocaleString();
        }

        // ========================================
        // PERFIL DE USUARIO
        // ========================================
        function cargarPerfil() {
            if (!usuarioActual || !datosUsuario) return;

            // Datos b√°sicos
            document.getElementById('perfil-usuario').value = datosUsuario.email;
            document.getElementById('perfil-nombre').value = datosUsuario.nombre || '';
            document.getElementById('perfil-apellidos').value = datosUsuario.apellidos || '';
            document.getElementById('perfil-fecha-nacimiento').value = datosUsuario.fechaNacimiento || '';
            document.getElementById('perfil-password').value = '';

            // Datos f√≠sicos
            document.getElementById('perfil-peso').value = datosUsuario.peso || '';
            document.getElementById('perfil-altura').value = datosUsuario.altura || '';
            document.getElementById('perfil-ftp').value = datosUsuario.ftp || '';
            document.getElementById('perfil-fc-max').value = datosUsuario.fcMax || '';
            document.getElementById('perfil-vo2max').value = datosUsuario.vo2max || '';

            // Calcular edad e IMC si hay datos
            calcularEdad();
            calcularIMC();

            // A√±adir listeners para c√°lculos autom√°ticos
            document.getElementById('perfil-fecha-nacimiento').addEventListener('change', calcularEdad);
            document.getElementById('perfil-peso').addEventListener('input', calcularIMC);
            document.getElementById('perfil-altura').addEventListener('input', calcularIMC);

            // Actualizar nombre completo en el header
            actualizarNombreCompleto();
            
            // Actualizar estado de Strava
            actualizarEstadoStrava();
        }

        function actualizarNombreCompleto() {
            const nombre = document.getElementById('perfil-nombre').value.trim();
            const apellidos = document.getElementById('perfil-apellidos').value.trim();
            const nombreCompleto = nombre && apellidos ? `${nombre} ${apellidos}` : datosUsuario.email;
            document.getElementById('perfil-nombre-completo').textContent = nombreCompleto;
        }

        function calcularEdad() {
            const fechaNacimiento = document.getElementById('perfil-fecha-nacimiento').value;
            const displayEdad = document.getElementById('perfil-edad-display');
            
            if (!fechaNacimiento) {
                displayEdad.style.display = 'none';
                return;
            }

            const hoy = new Date();
            const nacimiento = new Date(fechaNacimiento);
            let edad = hoy.getFullYear() - nacimiento.getFullYear();
            const mes = hoy.getMonth() - nacimiento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                edad--;
            }

            document.getElementById('perfil-edad-valor').textContent = `${edad} a√±os`;
            displayEdad.style.display = 'block';
        }

        function calcularIMC() {
            const peso = parseFloat(document.getElementById('perfil-peso').value);
            const altura = parseFloat(document.getElementById('perfil-altura').value);
            const displayIMC = document.getElementById('perfil-imc-display');
            
            if (!peso || !altura || altura === 0) {
                displayIMC.style.display = 'none';
                return;
            }

            const alturaMetros = altura / 100;
            const imc = peso / (alturaMetros * alturaMetros);
            
            // Determinar categor√≠a y color
            let categoria = '';
            let color = '';
            
            if (imc < 18.5) {
                categoria = 'Bajo peso';
                color = '#3498db';
            } else if (imc >= 18.5 && imc < 25) {
                categoria = 'Peso normal';
                color = '#2ecc71';
            } else if (imc >= 25 && imc < 30) {
                categoria = 'Sobrepeso';
                color = '#f39c12';
            } else {
                categoria = 'Obesidad';
                color = '#e74c3c';
            }

            document.getElementById('perfil-imc-valor').textContent = imc.toFixed(1);
            document.getElementById('perfil-imc-valor').style.color = color;
            document.getElementById('perfil-imc-categoria').textContent = categoria;
            document.getElementById('perfil-imc-categoria').style.color = color;
            displayIMC.style.display = 'block';
        }

        async function guardarPerfil() {
            // Datos personales
            const nombre = document.getElementById('perfil-nombre').value.trim();
            const apellidos = document.getElementById('perfil-apellidos').value.trim();
            const fechaNacimiento = document.getElementById('perfil-fecha-nacimiento').value;
            const nuevaPassword = document.getElementById('perfil-password').value;

            // Datos f√≠sicos
            const peso = parseFloat(document.getElementById('perfil-peso').value) || null;
            const altura = parseFloat(document.getElementById('perfil-altura').value) || null;
            const ftp = parseFloat(document.getElementById('perfil-ftp').value) || null;
            const fcMax = parseFloat(document.getElementById('perfil-fc-max').value) || null;
            const vo2max = parseFloat(document.getElementById('perfil-vo2max').value) || null;

            // Actualizar datos personales (excepto email que est√° en Auth)
            datosUsuario.nombre = nombre;
            datosUsuario.apellidos = apellidos;
            datosUsuario.fechaNacimiento = fechaNacimiento;

            // Actualizar datos f√≠sicos
            datosUsuario.peso = peso;
            datosUsuario.altura = altura;
            datosUsuario.ftp = ftp;
            datosUsuario.fcMax = fcMax;
            datosUsuario.vo2max = vo2max;

            // Actualizar contrase√±a en Firebase Auth si se ingres√≥ una nueva
            if (nuevaPassword) {
                if (nuevaPassword.length < 6) {
                    mostrarNotificacion('La contrase√±a debe tener al menos 6 caracteres', 'error');
                    return;
                }
                
                try {
                    await usuarioActual.updatePassword(nuevaPassword);
                    await guardarDatosUsuario();
                    mostrarNotificacion('Perfil y contrase√±a actualizados', 'exito');
                } catch (error) {
                    console.error('Error actualizando contrase√±a:', error);
                    if (error.code === 'auth/requires-recent-login') {
                        mostrarNotificacion('Debes volver a iniciar sesi√≥n para cambiar la contrase√±a', 'error');
                    } else {
                        mostrarNotificacion('Error al actualizar contrase√±a: ' + error.message, 'error');
                    }
                    return;
                }
            } else {
                await guardarDatosUsuario();
                mostrarNotificacion('Perfil actualizado correctamente', 'exito');
            }

            setTimeout(() => navegar('sec-dashboard'), 1500);
        }

        // ========================================
        // SISTEMA DE LOGIN Y REGISTRO
        // ========================================
        async function iniciarSesion() {
            const email = document.getElementById('login-usuario').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                mostrarNotificacion('Por favor, completa todos los campos', 'error');
                return;
            }

            try {
                // Iniciar sesi√≥n con Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                usuarioActual = userCredential.user;
                
                // Cargar datos del usuario desde Firestore
                await cargarDatosUsuario(usuarioActual.uid);
                
                mostrarNotificacion('¬°Bienvenido!', 'exito');
                navegar('sec-dashboard');
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    mostrarNotificacion('Email o contrase√±a incorrectos', 'error');
                } else {
                    mostrarNotificacion('Error al iniciar sesi√≥n: ' + error.message, 'error');
                }
            }
        }

        async function registrarUsuario() {
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const aceptaTerminos = document.getElementById('reg-terminos').checked;

            if (!email || !password) {
                mostrarNotificacion('Email y contrase√±a son obligatorios', 'error');
                return;
            }

            if (!aceptaTerminos) {
                mostrarNotificacion('Debes aceptar los t√©rminos y la pol√≠tica de privacidad', 'error');
                return;
            }

            if (password.length < 6) {
                mostrarNotificacion('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                // Crear usuario con Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Crear documento inicial en Firestore
                datosUsuario = {
                    id: user.uid,
                    email: email,
                    garaje: [],
                    fechaRegistro: new Date().toISOString(),
                    aceptoTerminos: true,
                    fechaAceptacionTerminos: new Date().toISOString()
                };
                
                await db.collection('usuarios').doc(user.uid).set(datosUsuario);
                
                mostrarNotificacion('¬°Cuenta creada! Ya puedes iniciar sesi√≥n', 'exito');
                
                // Cerrar sesi√≥n autom√°ticamente para que haga login
                await auth.signOut();
                setTimeout(() => navegar('sec-login'), 1500);
            } catch (error) {
                console.error('Error al registrar:', error);
                if (error.code === 'auth/email-already-in-use') {
                    mostrarNotificacion('Ese email ya est√° registrado', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    mostrarNotificacion('Email inv√°lido', 'error');
                } else if (error.code === 'auth/weak-password') {
                    mostrarNotificacion('La contrase√±a es muy d√©bil', 'error');
                } else {
                    mostrarNotificacion('Error al registrar: ' + error.message, 'error');
                }
            }
        }

        async function cerrarSesion() {
            confirmar(
                '¬øCerrar sesi√≥n?',
                '¬øSeguro que quieres salir?',
                async () => {
                    try {
                        await auth.signOut();
                        usuarioActual = null;
                        datosUsuario = null;
                        biciActual = null;
                        mostrarNotificacion('Sesi√≥n cerrada', 'info');
                        navegar('sec-login');
                    } catch (error) {
                        console.error('Error al cerrar sesi√≥n:', error);
                        mostrarNotificacion('Error al cerrar sesi√≥n', 'error');
                    }
                }
            );
        }

        // ========================================
        // RECUPERAR CONTRASE√ëA
        // ========================================
        function abrirModalRecuperarPassword() {
            // Pre-rellenar con el email del campo de login si existe
            const emailLogin = document.getElementById('login-usuario').value.trim();
            document.getElementById('recuperar-email').value = emailLogin;
            abrirModal('modal-recuperar-password');
        }

        async function enviarEmailRecuperacion() {
            const email = document.getElementById('recuperar-email').value.trim();

            if (!email) {
                mostrarNotificacion('Por favor, introduce tu email', 'error');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                cerrarModal('modal-recuperar-password');
                mostrarNotificacion('Email enviado. Revisa tu bandeja de entrada', 'exito');
            } catch (error) {
                console.error('Error al enviar email:', error);
                if (error.code === 'auth/user-not-found') {
                    mostrarNotificacion('No existe ninguna cuenta con ese email', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    mostrarNotificacion('Email inv√°lido', 'error');
                } else {
                    mostrarNotificacion('Error al enviar email: ' + error.message, 'error');
                }
            }
        }

        // ========================================
        // GESTI√ìN DE BICICLETAS
        // ========================================
        function cargarGaraje() {
            const container = document.getElementById('lista-bicis');
            
            // Filtrar solo bicis activas
            const bicisActivas = datosUsuario.garaje.filter(b => b.activa !== false);
            const bicisRetiradas = datosUsuario.garaje.filter(b => b.activa === false);
            
            // Mostrar/ocultar bot√≥n de bicis retiradas
            const btnRetiradas = document.getElementById('btn-ver-retiradas');
            if (bicisRetiradas.length > 0) {
                btnRetiradas.style.display = 'block';
                btnRetiradas.innerHTML = `üì¶ Ver Bicis Retiradas (${bicisRetiradas.length})`;
            } else {
                btnRetiradas.style.display = 'none';
            }
            
            if (!bicisActivas || bicisActivas.length === 0) {
                container.innerHTML = `
                    <div class="lista-vacia">
                        <div class="lista-vacia-icon">üö¥</div>
                        <p>No tienes ninguna bici en el garaje</p>
                        <p class="text-muted">¬°A√±ade tu primera bicicleta!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            bicisActivas.forEach(bici => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${bici.alias}</div>
                            <div class="card-subtitle">${bici.marca} ${bici.modelo}</div>
                        </div>
                        <span class="badge badge-primary">${bici.disciplina}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; align-items: center;">
                        <div class="text-muted">
                            <strong style="color: var(--primary); font-size: 1.2em;">${bici.kmTotales || 0} km</strong>
                        </div>
                        <button class="btn btn-secondary" style="width: auto; padding: 10px 20px;" onclick="abrirTaller('${bici.id}')">
                            Abrir
                        </button>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-secondary" style="flex: 1; padding: 8px; font-size: 0.85em;" onclick="retirarBici('${bici.id}')">
                            üì¶ Retirar
                        </button>
                        <button class="btn btn-danger" style="flex: 1; padding: 8px; font-size: 0.85em;" onclick="eliminarBici('${bici.id}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function retirarBici(biciId) {
            const bici = datosUsuario.garaje.find(b => b.id === biciId);
            if (!bici) return;

            confirmar(
                '¬øRetirar bici?',
                `¬øQuieres retirar "${bici.alias}" del garaje activo? Se guardar√° en tu historial pero no aparecer√° en la lista principal.`,
                () => {
                    bici.activa = false;
                    bici.fechaRetiro = new Date().toISOString();
                    guardarDatosUsuario();
                    cargarGaraje();
                    mostrarNotificacion(`"${bici.alias}" retirada del garaje`, 'info');
                }
            );
        }

        function eliminarBici(biciId) {
            const bici = datosUsuario.garaje.find(b => b.id === biciId);
            if (!bici) return;

            confirmar(
                '¬øEliminar bici?',
                `¬øEst√°s seguro de eliminar "${bici.alias}"? Esta acci√≥n no se puede deshacer y perder√°s todo su historial.`,
                () => {
                    const index = datosUsuario.garaje.findIndex(b => b.id === biciId);
                    if (index !== -1) {
                        datosUsuario.garaje.splice(index, 1);
                        guardarDatosUsuario();
                        cargarGaraje();
                        mostrarNotificacion(`"${bici.alias}" eliminada correctamente`, 'exito');
                    }
                }
            );
        }

        function cargarBicisRetiradas() {
            const container = document.getElementById('lista-bicis-retiradas');
            const bicisRetiradas = datosUsuario.garaje.filter(b => b.activa === false);
            
            if (!bicisRetiradas || bicisRetiradas.length === 0) {
                container.innerHTML = `
                    <div class="lista-vacia">
                        <div class="lista-vacia-icon">üì¶</div>
                        <p>No hay bicis retiradas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            bicisRetiradas.forEach(bici => {
                const fechaRetiro = bici.fechaRetiro ? new Date(bici.fechaRetiro).toLocaleDateString('es-ES') : 'Fecha desconocida';
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.borderLeftColor = 'var(--text)';
                card.style.opacity = '0.85';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${bici.alias}</div>
                            <div class="card-subtitle">${bici.marca} ${bici.modelo}</div>
                            <div class="text-muted" style="font-size: 0.75em; margin-top: 5px;">Retirada: ${fechaRetiro}</div>
                        </div>
                        <span class="badge" style="background: #e0e0e0; color: #666;">${bici.disciplina}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; align-items: center;">
                        <div class="text-muted">
                            <strong style="color: var(--text); font-size: 1em;">${bici.kmTotales || 0} km</strong>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-primary" style="flex: 1; padding: 8px; font-size: 0.85em;" onclick="reactivarBici('${bici.id}')">
                            ‚Ü©Ô∏è Reactivar
                        </button>
                        <button class="btn btn-danger" style="flex: 1; padding: 8px; font-size: 0.85em;" onclick="eliminarBiciRetirada('${bici.id}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function reactivarBici(biciId) {
            const bici = datosUsuario.garaje.find(b => b.id === biciId);
            if (!bici) return;

            confirmar(
                '¬øReactivar bici?',
                `¬øQuieres volver a activar "${bici.alias}" en tu garaje?`,
                () => {
                    bici.activa = true;
                    delete bici.fechaRetiro;
                    guardarDatosUsuario();
                    cargarBicisRetiradas();
                    mostrarNotificacion(`"${bici.alias}" reactivada en el garaje`, 'exito');
                }
            );
        }

        function eliminarBiciRetirada(biciId) {
            const bici = datosUsuario.garaje.find(b => b.id === biciId);
            if (!bici) return;

            confirmar(
                '¬øEliminar bici?',
                `¬øEst√°s seguro de eliminar "${bici.alias}"? Esta acci√≥n no se puede deshacer y perder√°s todo su historial.`,
                () => {
                    const index = datosUsuario.garaje.findIndex(b => b.id === biciId);
                    if (index !== -1) {
                        datosUsuario.garaje.splice(index, 1);
                        guardarDatosUsuario();
                        cargarBicisRetiradas();
                        mostrarNotificacion(`"${bici.alias}" eliminada correctamente`, 'exito');
                    }
                }
            );
        }

        function crearBicicleta() {
            const alias = document.getElementById('nueva-alias').value.trim();
            const marca = document.getElementById('nueva-marca').value;
            const modelo = document.getElementById('nueva-modelo').value.trim();
            const disciplina = document.getElementById('nueva-disciplina').value;
            const fechaCompra = document.getElementById('nueva-fecha').value;
            const kmIniciales = parseFloat(document.getElementById('nueva-km').value) || 0;

            if (!alias || !marca || !modelo) {
                mostrarNotificacion('Por favor, completa alias, marca y modelo', 'error');
                return;
            }

            if (!fechaCompra) {
                mostrarNotificacion('Por favor, indica la fecha de compra', 'error');
                return;
            }

            const nuevaBici = {
                id: Date.now().toString(),
                alias: alias,
                marca: marca,
                modelo: modelo,
                disciplina: disciplina,
                fechaCompra: fechaCompra,
                kmTotales: kmIniciales,
                pesoGramos: 0,
                inversion: 0,
                componentes: [],
                historial: [],
                activa: true,
                fechaCreacion: new Date().toISOString()
            };

            datosUsuario.garaje.push(nuevaBici);
            guardarDatosUsuario();

            // Limpiar formulario
            document.getElementById('nueva-alias').value = '';
            document.getElementById('nueva-marca').value = '';
            document.getElementById('nueva-modelo').value = '';
            document.getElementById('nueva-fecha').value = '';
            document.getElementById('nueva-km').value = '0';

            mostrarNotificacion('¬°Bicicleta creada correctamente!', 'exito');
            navegar('sec-garaje');
        }

        function abrirTaller(biciId) {
            biciActual = datosUsuario.garaje.find(b => b.id === biciId);
            if (!biciActual) {
                mostrarNotificacion('Error: No se encontr√≥ la bici', 'error');
                return;
            }
            navegar('sec-taller');
        }

        function cargarTaller() {
            if (!biciActual) return;

            document.getElementById('taller-nombre-bici').textContent = biciActual.alias;
            document.getElementById('taller-alias').textContent = biciActual.alias;
            document.getElementById('taller-modelo').textContent = `${biciActual.marca} ${biciActual.modelo}`;
            document.getElementById('taller-disciplina').textContent = biciActual.disciplina;
            document.getElementById('taller-km').textContent = `${biciActual.kmTotales || 0} km`;
            
            // Calcular peso total de todos los componentes V2
            let pesoTotal = 0;
            if (biciActual.componentesV2) {
                Object.keys(biciActual.componentesV2).forEach(seccion => {
                    biciActual.componentesV2[seccion].forEach(comp => {
                        pesoTotal += comp.peso || 0;
                        // Sumar peso de subpiezas si existen
                        if (comp.subpiezas) {
                            Object.values(comp.subpiezas).forEach(sub => {
                                pesoTotal += sub.peso || 0;
                            });
                        }
                    });
                });
            }
            
            const pesoKg = (pesoTotal / 1000).toFixed(2);
            document.getElementById('taller-peso').textContent = `${pesoKg} kg`;
            document.getElementById('taller-inversion').textContent = `${biciActual.inversion || 0}‚Ç¨`;
            
            // Calcular d√≠as de uso desde fecha de compra con formato aa/mm/dd
            if (biciActual.fechaCompra) {
                const diasUso = Math.floor((new Date() - new Date(biciActual.fechaCompra)) / 86400000);
                document.getElementById('taller-uso').textContent = formatearDuracion(diasUso);
            } else {
                document.getElementById('taller-uso').textContent = '0d';
            }
            
            // Mostrar vinculaci√≥n con Strava si existe
            if (biciActual.stravaBiciId) {
                document.getElementById('taller-strava-vinculado').style.display = 'block';
                document.getElementById('taller-strava-nombre').textContent = biciActual.stravaBiciNombre || 'Bici de Strava';
            } else {
                document.getElementById('taller-strava-vinculado').style.display = 'none';
            }
        }

        function volverATaller() {
            navegar('sec-taller');
        }

        function mostrarMenuBici() {
            mostrarNotificacion('Funci√≥n de edici√≥n pr√≥ximamente', 'info');
        }

        // ========================================
        // GESTI√ìN DE KIL√ìMETROS
        // ========================================
        function abrirModalKm() {
            document.getElementById('input-km').value = '';
            abrirModal('modal-km');
        }

        function guardarKm() {
            const km = parseFloat(document.getElementById('input-km').value);
            
            if (!km || km <= 0) {
                mostrarNotificacion('Introduce un valor v√°lido de kil√≥metros', 'error');
                return;
            }

            biciActual.kmTotales = (biciActual.kmTotales || 0) + km;
            guardarDatosUsuario();
            cargarTaller();
            cerrarModal('modal-km');
            mostrarNotificacion(`¬°${km} km a√±adidos correctamente!`, 'exito');
        }

        // ========================================
        // GESTI√ìN DE COMPONENTES - SISTEMA COMPLETO V2
        // ========================================
        
        // Variables globales para componentes
        let seccionActual = null;
        let componenteActual = null;
        let modoEdicion = false;
        
        // Definici√≥n de secciones por disciplina
        const SECCIONES_COMPONENTES = {
            'Carretera': ['Cuadro', 'Transmisi√≥n', 'Frenos', 'Ruedas', 'Perif√©ricos'],
            'Gravel': ['Cuadro', 'Transmisi√≥n', 'Frenos', 'Ruedas', 'Perif√©ricos'],
            'MTB': ['Cuadro', 'Transmisi√≥n', 'Frenos', 'Ruedas', 'Perif√©ricos', 'Suspensiones']
        };
        
        // Componentes por secci√≥n
        const COMPONENTES_POR_SECCION = {
            'Cuadro': {
                'Carretera': ['Cuadro', 'Horquilla', 'Direcci√≥n', 'Cierre Tija', 'Patilla de Cambio'],
                'Gravel': ['Cuadro', 'Horquilla', 'Direcci√≥n', 'Cierre Tija', 'Patilla de Cambio'],
                'MTB': ['Cuadro', 'Direcci√≥n', 'Cierre Tija', 'Patilla de Cambio']
            },
            'Transmisi√≥n': {
                'Carretera': ['Cambio Trasero', 'Desviador Delantero', 'Cassette', 'Cadena', 'Bielas', 'Eje de Pedalier', 'Pedales', 'Bater√≠a de Cambio'],
                'Gravel': ['Cambio Trasero', 'Desviador Delantero', 'Cassette', 'Cadena', 'Bielas', 'Eje de Pedalier', 'Pedales', 'Bater√≠a de Cambio'],
                'MTB': ['Cambio Trasero', 'Desviador Delantero', 'Cassette', 'Cadena', 'Bielas', 'Eje de Pedalier', 'Pedales', 'Bater√≠a de Cambio', 'Mando Cambio Delantero', 'Mando Cambio Trasero']
            },
            'Frenos': {
                'todos': ['Maneta Izquierda', 'Maneta Derecha', 'Pinza Delantera', 'Pinza Trasera', 'Disco Delantero', 'Disco Trasero']
            },
            'Ruedas': {
                'todos': ['Llanta Delantera', 'Llanta Trasera', 'Buje Delantero', 'Buje Trasero', 'Cubierta Delantera', 'Cubierta Trasera', 'Cierre Delantero', 'Cierre Trasero', 'N√∫cleo']
            },
            'Perif√©ricos': {
                'todos': ['Manillar', 'Potencia', 'Tija', 'Sill√≠n', 'Pu√±os/Cinta', 'Portabidones', 'Acople GPS']
            },
            'Suspensiones': {
                'MTB': ['Horquilla', 'Amortiguador', 'Rodamientos/Casquillos', 'Mando Remoto Trasero', 'Mando Remoto Delantero']
            }
        };
        
        // Componentes con subpiezas
        const SUBPIEZAS = {
            'Cambio Trasero': ['Roldanas'],
            'Bielas': ['Plato Grande', 'Plato Peque√±o', 'Monoplato'],
            'Maneta Izquierda': ['Pila', 'Escalador'],
            'Maneta Derecha': ['Pila', 'Escalador'],
            'Pinza Delantera': ['Pastillas'],
            'Pinza Trasera': ['Pastillas']
        };
        
        // Cargar grid de secciones
        function cargarSeccionesComponentes() {
            if (!biciActual) return;
            
            const grid = document.getElementById('grid-secciones-componentes');
            const secciones = SECCIONES_COMPONENTES[biciActual.disciplina] || SECCIONES_COMPONENTES['Carretera'];
            
            grid.innerHTML = '';
            const iconos = {'Cuadro': 'üö≤', 'Transmisi√≥n': '‚öôÔ∏è', 'Frenos': 'üõë', 'Ruedas': '‚≠ï', 'Perif√©ricos': 'üéØ', 'Suspensiones': 'üîß'};
            
            secciones.forEach(seccion => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                card.onclick = () => abrirSeccionComponentes(seccion);
                card.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 10px;">${iconos[seccion]}</div>
                        <div class="card-title" style="font-size: 1em;">${seccion}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // Abrir secci√≥n
        function abrirSeccionComponentes(seccion) {
            seccionActual = seccion;
            document.getElementById('titulo-seccion-componentes').textContent = seccion;
            cargarListaComponentesSeccion();
            navegar('sec-lista-componentes-seccion');
        }
        
        // Cargar lista de componentes de una secci√≥n
        function cargarListaComponentesSeccion() {
            if (!biciActual || !seccionActual) return;
            
            const container = document.getElementById('lista-componentes-seccion');
            
            if (!biciActual.componentesV2) biciActual.componentesV2 = {};
            if (!biciActual.componentesV2[seccionActual]) biciActual.componentesV2[seccionActual] = [];
            
            const componentes = biciActual.componentesV2[seccionActual];
            
            if (componentes.length === 0) {
                container.innerHTML = '<div class="lista-vacia"><div class="lista-vacia-icon">üîß</div><p>No hay componentes</p></div>';
                return;
            }
            
            container.innerHTML = '';
            componentes.forEach(comp => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                card.onclick = () => abrirDetalleComponente(comp);
                
                const kmUso = (biciActual.kmTotales || 0) - (comp.kmInstalacion || 0);
                const diasUso = comp.fechaInstalacion ? Math.floor((new Date() - new Date(comp.fechaInstalacion)) / (1000*60*60*24)) : 0;
                
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${comp.tipo}</div>
                            <div class="card-subtitle">${comp.marca || '-'} ${comp.modelo || '-'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="badge badge-primary">${kmUso} km</div>
                            <div style="font-size: 0.75em; color: var(--text); margin-top: 5px;">${diasUso} d√≠as</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Abrir detalle componente
        function abrirDetalleComponente(comp) {
            componenteActual = comp;
            
            document.getElementById('titulo-detalle-componente').textContent = comp.tipo;
            document.getElementById('detalle-comp-nombre').textContent = comp.tipo;
            document.getElementById('detalle-comp-marca').textContent = comp.marca || '-';
            document.getElementById('detalle-comp-modelo').textContent = comp.modelo || '-';
            document.getElementById('detalle-comp-material').textContent = comp.material || '-';
            document.getElementById('detalle-comp-peso').textContent = comp.peso ? `${comp.peso}g` : '-';
            document.getElementById('detalle-comp-km').textContent = comp.kmInstalacion || '0';
            
            const kmUso = (biciActual.kmTotales || 0) - (comp.kmInstalacion || 0);
            document.getElementById('detalle-comp-km-uso').textContent = `${kmUso} km`;
            
            document.getElementById('detalle-comp-fecha').textContent = formatearFecha(comp.fechaInstalacion);
            document.getElementById('detalle-comp-precio').textContent = comp.precio ? `${comp.precio}‚Ç¨` : '-';
            
            // Subpiezas
            if (SUBPIEZAS[comp.tipo]) {
                document.getElementById('subpiezas-container').style.display = 'block';
                cargarSubpiezas();
            } else {
                document.getElementById('subpiezas-container').style.display = 'none';
            }
            
            navegar('sec-detalle-componente');
        }
        
        // Cargar subpiezas
        function cargarSubpiezas() {
            const container = document.getElementById('lista-subpiezas');
            const tipos = SUBPIEZAS[componenteActual.tipo];
            
            if (!componenteActual.subpiezas) componenteActual.subpiezas = {};
            
            container.innerHTML = '';
            tipos.forEach(tipo => {
                const sub = componenteActual.subpiezas[tipo];
                const div = document.createElement('div');
                div.style.cssText = 'padding:10px;background:var(--light-gray);border-radius:8px;margin-bottom:10px;';
                
                if (sub) {
                    const kmUso = (biciActual.kmTotales || 0) - (sub.kmInstalacion || 0);
                    div.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:bold;">${tipo}</div>
                                <div style="font-size:0.85em;color:var(--text);">${sub.marca} ${sub.modelo} - ${kmUso} km</div>
                            </div>
                            <div style="display:flex;gap:10px;">
                                <button class="btn btn-secondary" style="padding:5px 10px;font-size:0.8em;" onclick="editarSubpieza('${tipo}')">‚úèÔ∏è</button>
                                <button class="btn btn-primary" style="padding:5px 10px;font-size:0.8em;" onclick="sustituirSubpieza('${tipo}')">üîÑ</button>
                            </div>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div><div style="font-weight:bold;">${tipo}</div><div style="font-size:0.85em;color:var(--text);">No instalado</div></div>
                            <button class="btn btn-primary" style="padding:5px 10px;font-size:0.8em;" onclick="editarSubpieza('${tipo}')">‚ûï</button>
                        </div>
                    `;
                }
                container.appendChild(div);
            });
        }
        
        // Modal nuevo componente
        function abrirModalNuevoComponente() {
            if (!seccionActual) return;
            
            modoEdicion = false;
            document.getElementById('modal-componente-titulo').textContent = 'Nuevo Componente';
            
            limpiarFormComponente();
            
            const select = document.getElementById('comp-tipo');
            select.innerHTML = '<option value="">-- Selecciona --</option>';
            const comps = COMPONENTES_POR_SECCION[seccionActual][biciActual.disciplina] || COMPONENTES_POR_SECCION[seccionActual]['todos'];
            comps.forEach(c => select.add(new Option(c, c)));
            
            select.onchange = () => actualizarCamposExtra();
            
            // Pre-rellenar con datos de compra de la bici
            document.getElementById('comp-km-instalacion').value = 0;
            document.getElementById('comp-fecha-instalacion').value = biciActual.fechaCompra || new Date().toISOString().split('T')[0];
            
            abrirModal('modal-componente');
        }
        
        // Limpiar formulario
        function limpiarFormComponente() {
            ['comp-tipo','comp-marca','comp-modelo','comp-material','comp-peso','comp-precio','comp-fecha-instalacion','comp-km-instalacion'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('comp-marca-otra-container').style.display = 'none';
            document.getElementById('comp-material-otro-container').style.display = 'none';
            document.getElementById('comp-campos-extra').innerHTML = '';
        }
        
        // Campos extra
        function actualizarCamposExtra() {
            const tipo = document.getElementById('comp-tipo').value;
            const container = document.getElementById('comp-campos-extra');
            container.innerHTML = ''; // Sin campos extra por ahora
        }
        
        // Guardar componente
        function guardarComponente() {
            const tipo = document.getElementById('comp-tipo').value.trim();
            let marca = document.getElementById('comp-marca').value;
            const modelo = document.getElementById('comp-modelo').value.trim();
            let material = document.getElementById('comp-material').value;
            const peso = parseFloat(document.getElementById('comp-peso').value) || 0;
            const precio = parseFloat(document.getElementById('comp-precio').value) || 0;
            const fecha = document.getElementById('comp-fecha-instalacion').value;
            const km = parseFloat(document.getElementById('comp-km-instalacion').value) || 0;
            
            if (!tipo) return mostrarNotificacion('Selecciona el tipo', 'error');
            
            if (marca === 'Otra') marca = document.getElementById('comp-marca-otra').value.trim() || 'Otra';
            if (material === 'Otro') material = document.getElementById('comp-material-otro').value.trim() || 'Otro';
            
            const comp = {
                id: modoEdicion ? componenteActual.id : Date.now().toString(),
                tipo, marca, modelo, material, peso, precio,
                fechaInstalacion: fecha,
                kmInstalacion: km
            };
            
            // Sin campos extra en componentes principales
            
            if (SUBPIEZAS[tipo]) comp.subpiezas = {};
            
            if (!biciActual.componentesV2) biciActual.componentesV2 = {};
            if (!biciActual.componentesV2[seccionActual]) biciActual.componentesV2[seccionActual] = [];
            
            if (modoEdicion) {
                const idx = biciActual.componentesV2[seccionActual].findIndex(c => c.id === componenteActual.id);
                if (idx !== -1) {
                    comp.subpiezas = biciActual.componentesV2[seccionActual][idx].subpiezas || {};
                    biciActual.componentesV2[seccionActual][idx] = comp;
                }
            } else {
                biciActual.componentesV2[seccionActual].push(comp);
                biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
            }
            
            guardarDatosUsuario();
            cargarListaComponentesSeccion();
            cargarTaller();
            cerrarModal('modal-componente');
            mostrarNotificacion(modoEdicion ? 'Actualizado' : 'A√±adido', 'exito');
        }
        
        // Editar componente
        function editarComponenteActual() {
            if (!componenteActual) return;
            
            modoEdicion = true;
            document.getElementById('modal-componente-titulo').textContent = 'Editar Componente';
            
            const select = document.getElementById('comp-tipo');
            select.innerHTML = '';
            const comps = COMPONENTES_POR_SECCION[seccionActual][biciActual.disciplina] || COMPONENTES_POR_SECCION[seccionActual]['todos'];
            comps.forEach(c => select.add(new Option(c, c)));
            
            select.value = componenteActual.tipo;
            document.getElementById('comp-marca').value = componenteActual.marca;
            document.getElementById('comp-modelo').value = componenteActual.modelo || '';
            document.getElementById('comp-material').value = componenteActual.material;
            document.getElementById('comp-peso').value = componenteActual.peso || '';
            document.getElementById('comp-precio').value = componenteActual.precio || '';
            document.getElementById('comp-fecha-instalacion').value = componenteActual.fechaInstalacion || '';
            document.getElementById('comp-km-instalacion').value = componenteActual.kmInstalacion || '';
            
            select.onchange = () => actualizarCamposExtra();
            actualizarCamposExtra();
            
            abrirModal('modal-componente');
        }
        
        // Reparar
        function repararComponenteActual() {
            if (!componenteActual) return;
            
            document.getElementById('reparar-componente-nombre').textContent = componenteActual.tipo;
            document.getElementById('reparar-descripcion').value = '';
            document.getElementById('reparar-lugar').value = 'Taller';
            document.getElementById('reparar-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('reparar-km').value = biciActual.kmTotales || 0;
            document.getElementById('reparar-coste').value = '';
            
            abrirModal('modal-reparar');
        }
        
        // Guardar reparaci√≥n
        function guardarReparacion() {
            const desc = document.getElementById('reparar-descripcion').value.trim();
            const lugar = document.getElementById('reparar-lugar').value;
            const fecha = document.getElementById('reparar-fecha').value;
            const km = parseFloat(document.getElementById('reparar-km').value) || 0;
            const coste = parseFloat(document.getElementById('reparar-coste').value) || 0;
            
            if (!desc) return mostrarNotificacion('A√±ade descripci√≥n', 'error');
            
            if (!biciActual.historial) biciActual.historial = [];
            
            biciActual.historial.unshift({
                id: Date.now().toString(),
                fecha, tipo: 'Reparaci√≥n',
                componente: componenteActual.tipo,
                descripcion: `${desc} (${lugar})`,
                km, coste,
                fechaCreacion: new Date().toISOString()
            });
            
            guardarDatosUsuario();
            cerrarModal('modal-reparar');
            mostrarNotificacion('Reparaci√≥n registrada', 'exito');
        }
        
        // Sustituir
        function sustituirComponenteActual() {
            if (!componenteActual) return;
            
            document.getElementById('sustituir-componente-viejo').textContent = `${componenteActual.marca} ${componenteActual.modelo}`;
            document.getElementById('sustituir-km-instalacion').textContent = componenteActual.kmInstalacion || '0';
            document.getElementById('sustituir-km-actual').textContent = biciActual.kmTotales || '0';
            const durKm = (biciActual.kmTotales || 0) - (componenteActual.kmInstalacion || 0);
            document.getElementById('sustituir-duracion-km').textContent = durKm;
            
            // Pre-rellenar con datos del viejo
            document.getElementById('sustituir-marca').value = componenteActual.marca;
            document.getElementById('sustituir-modelo').value = componenteActual.modelo || '';
            document.getElementById('sustituir-material').value = componenteActual.material;
            document.getElementById('sustituir-peso').value = componenteActual.peso || '';
            document.getElementById('sustituir-precio').value = '';
            document.getElementById('sustituir-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('sustituir-km').value = biciActual.kmTotales || 0;
            document.getElementById('sustituir-campos-extra').innerHTML = '';
            
            // Sin campos extra en componentes principales
            
            abrirModal('modal-sustituir');
        }
        
        // Guardar sustituci√≥n
        function guardarSustitucion() {
            let marca = document.getElementById('sustituir-marca').value;
            const modelo = document.getElementById('sustituir-modelo').value.trim();
            let material = document.getElementById('sustituir-material').value;
            const peso = parseFloat(document.getElementById('sustituir-peso').value) || 0;
            const precio = parseFloat(document.getElementById('sustituir-precio').value) || 0;
            const fecha = document.getElementById('sustituir-fecha').value;
            const kmSustitucion = parseFloat(document.getElementById('sustituir-km').value) || 0;
            
            if (marca === 'Otra') marca = document.getElementById('sustituir-marca-otra').value.trim() || 'Otra';
            if (material === 'Otro') material = document.getElementById('sustituir-material-otro').value.trim() || 'Otro';
            
            const kmViejo = componenteActual.kmInstalacion || 0;
            const durKm = kmSustitucion - kmViejo;
            const diasUso = componenteActual.fechaInstalacion ? Math.floor((new Date(fecha) - new Date(componenteActual.fechaInstalacion)) / 86400000) : 0;
            
            if (!biciActual.historial) biciActual.historial = [];
            biciActual.historial.unshift({
                id: Date.now().toString(),
                fecha, tipo: 'Sustituci√≥n',
                componente: componenteActual.tipo,
                descripcion: `${componenteActual.marca} ${componenteActual.modelo} ‚Üí ${marca} ${modelo}`,
                km: kmSustitucion, coste: precio,
                duracionKm: durKm, duracionDias: diasUso,
                fechaCreacion: new Date().toISOString()
            });
            
            componenteActual.marca = marca;
            componenteActual.modelo = modelo;
            componenteActual.material = material;
            componenteActual.peso = peso;
            componenteActual.precio = precio;
            componenteActual.fechaInstalacion = fecha;
            componenteActual.kmInstalacion = kmSustitucion;
            
            // Sin campos extra en componentes principales
            
            if (SUBPIEZAS[componenteActual.tipo]) componenteActual.subpiezas = {};
            
            biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
            
            guardarDatosUsuario();
            cerrarModal('modal-sustituir');
            abrirDetalleComponente(componenteActual);
            mostrarNotificacion('Sustituido', 'exito');
        }
        
        // Volver
        function volverAListaComponentes() {
            navegar('sec-lista-componentes-seccion');
        }
        
        // Subpiezas (placeholder)
        // Variables para subpiezas
        let subpiezaTipo = null;
        let modoSubpieza = 'a√±adir'; // 'a√±adir', 'editar', 'sustituir'
        
        // Editar/A√±adir subpieza
        function editarSubpieza(tipo) {
            if (!componenteActual) return;
            
            subpiezaTipo = tipo;
            const subpiezaExiste = componenteActual.subpiezas && componenteActual.subpiezas[tipo];
            
            modoSubpieza = subpiezaExiste ? 'editar' : 'a√±adir';
            document.getElementById('modal-subpieza-titulo').textContent = subpiezaExiste ? `Editar ${tipo}` : `A√±adir ${tipo}`;
            document.getElementById('modal-subpieza-subtitulo').textContent = `${componenteActual.tipo}`;
            
            // Mostrar datos heredados
            document.getElementById('subpieza-heredada-marca').textContent = componenteActual.marca || '-';
            document.getElementById('subpieza-heredada-modelo').textContent = componenteActual.modelo || '-';
            document.getElementById('subpieza-heredada-material').textContent = componenteActual.material || '-';
            document.getElementById('subpieza-heredada-fecha').textContent = formatearFecha(componenteActual.fechaInstalacion);
            document.getElementById('subpieza-heredada-km').textContent = componenteActual.kmInstalacion || '0';
            
            // Pre-rellenar con datos heredados o existentes
            if (subpiezaExiste) {
                const sub = componenteActual.subpiezas[tipo];
                document.getElementById('subpieza-marca').value = sub.marca;
                document.getElementById('subpieza-modelo').value = sub.modelo || '';
                document.getElementById('subpieza-material').value = sub.material;
                document.getElementById('subpieza-peso').value = sub.peso || '';
                document.getElementById('subpieza-precio').value = sub.precio || '';
                document.getElementById('subpieza-fecha').value = sub.fechaInstalacion || '';
                document.getElementById('subpieza-km').value = sub.kmInstalacion || '';
            } else {
                // Heredar del padre
                document.getElementById('subpieza-marca').value = componenteActual.marca;
                document.getElementById('subpieza-modelo').value = componenteActual.modelo || '';
                document.getElementById('subpieza-material').value = componenteActual.material;
                document.getElementById('subpieza-peso').value = '';
                document.getElementById('subpieza-precio').value = '';
                document.getElementById('subpieza-fecha').value = componenteActual.fechaInstalacion || '';
                document.getElementById('subpieza-km').value = componenteActual.kmInstalacion || '';
            }
            
            // Campos espec√≠ficos
            actualizarCamposEspecificosSubpieza(tipo, subpiezaExiste);
            
            abrirModal('modal-subpieza');
        }
        
        // Sustituir subpieza
        function sustituirSubpieza(tipo) {
            if (!componenteActual) return;
            
            subpiezaTipo = tipo;
            modoSubpieza = 'sustituir';
            
            document.getElementById('modal-subpieza-titulo').textContent = `Sustituir ${tipo}`;
            document.getElementById('modal-subpieza-subtitulo').textContent = `${componenteActual.tipo}`;
            
            const subActual = componenteActual.subpiezas[tipo];
            
            // Mostrar datos del componente padre (heredados)
            document.getElementById('subpieza-heredada-marca').textContent = componenteActual.marca || '-';
            document.getElementById('subpieza-heredada-modelo').textContent = componenteActual.modelo || '-';
            document.getElementById('subpieza-heredada-material').textContent = componenteActual.material || '-';
            document.getElementById('subpieza-heredada-fecha').textContent = formatearFecha(componenteActual.fechaInstalacion);
            document.getElementById('subpieza-heredada-km').textContent = componenteActual.kmInstalacion || '0';
            
            // Pre-rellenar con datos de la subpieza actual
            document.getElementById('subpieza-marca').value = subActual.marca;
            document.getElementById('subpieza-modelo').value = subActual.modelo || '';
            document.getElementById('subpieza-material').value = subActual.material;
            document.getElementById('subpieza-peso').value = subActual.peso || '';
            document.getElementById('subpieza-precio').value = '';
            document.getElementById('subpieza-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('subpieza-km').value = biciActual.kmTotales || 0;
            
            actualizarCamposEspecificosSubpieza(tipo, true);
            
            abrirModal('modal-subpieza');
        }
        
        // Actualizar campos espec√≠ficos seg√∫n tipo de subpieza
        function actualizarCamposEspecificosSubpieza(tipo, existente) {
            const container = document.getElementById('subpieza-campos-especificos');
            container.innerHTML = '';
            
            if (tipo === 'Roldanas') {
                const sub = existente && componenteActual.subpiezas[tipo];
                container.innerHTML = `
                    <div class="form-group"><label>Dientes Roldana Superior</label><input type="number" id="subpieza-dientes-sup" value="${sub?.dientesSup || 11}" step="1"></div>
                    <div class="form-group"><label>Dientes Roldana Inferior</label><input type="number" id="subpieza-dientes-inf" value="${sub?.dientesInf || 11}" step="1"></div>
                `;
            } else if (tipo.includes('Plato')) {
                const sub = existente && componenteActual.subpiezas[tipo];
                container.innerHTML = `
                    <div class="form-group"><label>N√∫mero de Dientes</label><input type="number" id="subpieza-num-dientes" value="${sub?.numDientes || 50}" step="1"></div>
                `;
            }
        }
        
        // Guardar subpieza
        function guardarSubpieza() {
            if (!componenteActual || !subpiezaTipo) return;
            
            let marca = document.getElementById('subpieza-marca').value;
            const modelo = document.getElementById('subpieza-modelo').value.trim();
            let material = document.getElementById('subpieza-material').value;
            const peso = parseFloat(document.getElementById('subpieza-peso').value) || 0;
            const precio = parseFloat(document.getElementById('subpieza-precio').value) || 0;
            const fecha = document.getElementById('subpieza-fecha').value;
            const km = parseFloat(document.getElementById('subpieza-km').value) || 0;
            
            if (marca === 'Otra') marca = document.getElementById('subpieza-marca-otra').value.trim() || 'Otra';
            if (material === 'Otro') material = document.getElementById('subpieza-material-otro').value.trim() || 'Otro';
            
            const subpieza = {
                tipo: subpiezaTipo,
                marca, modelo, material, peso, precio,
                fechaInstalacion: fecha,
                kmInstalacion: km
            };
            
            // Campos espec√≠ficos
            if (subpiezaTipo === 'Roldanas') {
                const sup = document.getElementById('subpieza-dientes-sup');
                const inf = document.getElementById('subpieza-dientes-inf');
                if (sup) subpieza.dientesSup = parseFloat(sup.value) || 0;
                if (inf) subpieza.dientesInf = parseFloat(inf.value) || 0;
            } else if (subpiezaTipo.includes('Plato')) {
                const dientes = document.getElementById('subpieza-num-dientes');
                if (dientes) subpieza.numDientes = parseFloat(dientes.value) || 0;
            }
            
            if (!componenteActual.subpiezas) componenteActual.subpiezas = {};
            
            // Si es sustituci√≥n, registrar en historial
            if (modoSubpieza === 'sustituir') {
                const subVieja = componenteActual.subpiezas[subpiezaTipo];
                const kmViejo = subVieja.kmInstalacion || 0;
                const durKm = km - kmViejo;
                const diasUso = subVieja.fechaInstalacion ? Math.floor((new Date(fecha) - new Date(subVieja.fechaInstalacion)) / 86400000) : 0;
                
                if (!biciActual.historial) biciActual.historial = [];
                biciActual.historial.unshift({
                    id: Date.now().toString(),
                    fecha, tipo: 'Sustituci√≥n',
                    componente: `${componenteActual.tipo} - ${subpiezaTipo}`,
                    descripcion: `${subVieja.marca} ${subVieja.modelo} ‚Üí ${marca} ${modelo}`,
                    km, coste: precio,
                    duracionKm: durKm, duracionDias: diasUso,
                    fechaCreacion: new Date().toISOString()
                });
                
                biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
            } else if (modoSubpieza === 'a√±adir') {
                biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
            }
            
            componenteActual.subpiezas[subpiezaTipo] = subpieza;
            
            guardarDatosUsuario();
            cerrarModal('modal-subpieza');
            abrirDetalleComponente(componenteActual);
            mostrarNotificacion(modoSubpieza === 'sustituir' ? 'Sustituida' : modoSubpieza === 'editar' ? 'Actualizada' : 'A√±adida', 'exito');
        }
        
        // Listeners para "Otra" marca
        window.addEventListener('load', () => {
            const marcaComp = document.getElementById('comp-marca');
            if (marcaComp) marcaComp.addEventListener('change', e => {
                document.getElementById('comp-marca-otra-container').style.display = e.target.value === 'Otra' ? 'block' : 'none';
            });
            
            const materialComp = document.getElementById('comp-material');
            if (materialComp) materialComp.addEventListener('change', e => {
                document.getElementById('comp-material-otro-container').style.display = e.target.value === 'Otro' ? 'block' : 'none';
            });
            
            const marcaSust = document.getElementById('sustituir-marca');
            if (marcaSust) marcaSust.addEventListener('change', e => {
                document.getElementById('sustituir-marca-otra-container').style.display = e.target.value === 'Otra' ? 'block' : 'none';
            });
            
            const materialSust = document.getElementById('sustituir-material');
            if (materialSust) materialSust.addEventListener('change', e => {
                document.getElementById('sustituir-material-otro-container').style.display = e.target.value === 'Otro' ? 'block' : 'none';
            });
            
            // Listeners para modal de subpieza
            const marcaSubpieza = document.getElementById('subpieza-marca');
            if (marcaSubpieza) marcaSubpieza.addEventListener('change', e => {
                document.getElementById('subpieza-marca-otra-container').style.display = e.target.value === 'Otra' ? 'block' : 'none';
            });
            
            const materialSubpieza = document.getElementById('subpieza-material');
            if (materialSubpieza) materialSubpieza.addEventListener('change', e => {
                document.getElementById('subpieza-material-otro-container').style.display = e.target.value === 'Otro' ? 'block' : 'none';
            });
        });

        // ========================================
        // GESTI√ìN DE HISTORIAL
        // ========================================
        function cargarHistorial() {
            const container = document.getElementById('lista-historial');
            
            if (!biciActual.historial || biciActual.historial.length === 0) {
                container.innerHTML = `
                    <div class="lista-vacia">
                        <div class="lista-vacia-icon">üìã</div>
                        <p>No hay registros de mantenimiento</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            biciActual.historial.forEach(reg => {
                const colorTipo = reg.tipo === 'Sustituci√≥n' ? 'var(--danger)' : 
                                 reg.tipo === 'Reparaci√≥n' ? 'var(--primary)' : 'var(--secondary)';
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.borderLeft = `4px solid ${colorTipo}`;
                
                let detalleExtra = '';
                if (reg.tipo === 'Sustituci√≥n' && reg.duracionKm !== undefined) {
                    const duracionFormateada = formatearDuracion(reg.duracionDias || 0);
                    detalleExtra = `<div class="text-muted">Dur√≥: <strong>${reg.duracionKm} km</strong> (${duracionFormateada})</div>`;
                } else {
                    detalleExtra = `<div class="text-muted">KM: <strong>${reg.km || reg.kmActuales || 0}</strong></div>`;
                }
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span class="badge" style="background: ${colorTipo}20; color: ${colorTipo}; font-weight: 600;">
                            ${reg.tipo}
                        </span>
                        <span class="text-muted" style="font-weight: 600;">${formatearFecha(reg.fecha)}</span>
                    </div>
                    <div class="card-title" style="font-size: 1em;">${reg.componente || reg.pieza || '-'}</div>
                    <div class="card-subtitle">${reg.descripcion}</div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                        ${detalleExtra}
                        <div class="text-muted">Coste: <strong style="color: var(--warning);">${reg.coste || 0}‚Ç¨</strong></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function abrirModalNuevoMantenimiento() {
            document.getElementById('mant-pieza').value = '';
            document.getElementById('mant-descripcion').value = '';
            document.getElementById('mant-coste').value = '';
            abrirModal('modal-mantenimiento');
        }

        function guardarMantenimiento() {
            const tipo = document.getElementById('mant-tipo').value;
            const pieza = document.getElementById('mant-pieza').value.trim();
            const descripcion = document.getElementById('mant-descripcion').value.trim();
            const coste = parseFloat(document.getElementById('mant-coste').value) || 0;

            if (!pieza || !descripcion) {
                mostrarNotificacion('Por favor, completa al menos la pieza y descripci√≥n', 'error');
                return;
            }

            const nuevoRegistro = {
                id: Date.now().toString(),
                tipo: tipo,
                pieza: pieza,
                descripcion: descripcion,
                coste: coste,
                kmActuales: biciActual.kmTotales,
                fecha: new Date().toLocaleDateString('es-ES')
            };

            biciActual.historial.unshift(nuevoRegistro);
            biciActual.inversion = (parseFloat(biciActual.inversion) + coste).toFixed(2);
            
            guardarDatosUsuario();
            cargarHistorial();
            cargarTaller();
            cerrarModal('modal-mantenimiento');
            mostrarNotificacion('Mantenimiento registrado correctamente', 'exito');
        }

        // ========================================
        // SISTEMA DE MODALES
        // ========================================
        function abrirModal(modalId) {
            document.getElementById(modalId).classList.add('activo');
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('activo');
        }

        // Cerrar modal al hacer clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('activo');
                }
            });
        });

        // ========================================
        // INTEGRACI√ìN CON STRAVA
        // ========================================
        
        // Conectar con Strava (inicia OAuth)
        function conectarStrava() {
            const scope = 'read,activity:read_all,profile:read_all';
            const authUrl = `${STRAVA_AUTH_URL}?client_id=${STRAVA_CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(STRAVA_REDIRECT_URI)}&approval_prompt=force&scope=${scope}&state=strava_auth`;
            window.location.href = authUrl;
        }

        // Desconectar Strava
        async function desconectarStrava() {
            confirmar(
                '¬øDesconectar Strava?',
                'Se eliminar√°n todas las vinculaciones de bicis con Strava.',
                async () => {
                    // Eliminar tokens y datos de Strava
                    delete datosUsuario.stravaAccessToken;
                    delete datosUsuario.stravaRefreshToken;
                    delete datosUsuario.stravaAtletaNombre;
                    delete datosUsuario.stravaTokenExpira;
                    
                    // Desvincular todas las bicis
                    datosUsuario.garaje.forEach(bici => {
                        delete bici.stravaBiciId;
                        delete bici.stravaBiciNombre;
                    });
                    
                    await guardarDatosUsuario();
                    mostrarNotificacion('Strava desconectado', 'info');
                    cargarPerfil();
                }
            );
        }

        // Procesar el c√≥digo de autorizaci√≥n de Strava
        async function procesarCallbackStrava(code) {
            try {
                document.getElementById('strava-desconectado').style.display = 'none';
                document.getElementById('strava-conectado').style.display = 'none';
                document.getElementById('strava-cargando').style.display = 'block';

                // Intercambiar c√≥digo por tokens
                const response = await fetch(`${STRAVA_TOKEN_URL}?client_id=${STRAVA_CLIENT_ID}&client_secret=${STRAVA_CLIENT_SECRET}&code=${code}&grant_type=authorization_code`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Error al obtener tokens de Strava');
                }

                const data = await response.json();

                // Guardar tokens en Firestore
                datosUsuario.stravaAccessToken = data.access_token;
                datosUsuario.stravaRefreshToken = data.refresh_token;
                datosUsuario.stravaTokenExpira = data.expires_at;
                datosUsuario.stravaAtletaNombre = data.athlete.firstname + ' ' + data.athlete.lastname;

                await guardarDatosUsuario();
                
                mostrarNotificacion('¬°Conectado con Strava!', 'exito');
                
                // Limpiar URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                cargarPerfil();
            } catch (error) {
                console.error('Error procesando callback de Strava:', error);
                mostrarNotificacion('Error al conectar con Strava', 'error');
                document.getElementById('strava-cargando').style.display = 'none';
                document.getElementById('strava-desconectado').style.display = 'block';
            }
        }

        // Renovar token de Strava si ha expirado
        async function renovarTokenStrava() {
            if (!datosUsuario.stravaRefreshToken) return false;

            const ahora = Math.floor(Date.now() / 1000);
            if (datosUsuario.stravaTokenExpira && ahora < datosUsuario.stravaTokenExpira) {
                return true; // Token todav√≠a v√°lido
            }

            try {
                const response = await fetch(`${STRAVA_TOKEN_URL}?client_id=${STRAVA_CLIENT_ID}&client_secret=${STRAVA_CLIENT_SECRET}&refresh_token=${datosUsuario.stravaRefreshToken}&grant_type=refresh_token`, {
                    method: 'POST'
                });

                if (!response.ok) return false;

                const data = await response.json();
                datosUsuario.stravaAccessToken = data.access_token;
                datosUsuario.stravaRefreshToken = data.refresh_token;
                datosUsuario.stravaTokenExpira = data.expires_at;

                await guardarDatosUsuario();
                return true;
            } catch (error) {
                console.error('Error renovando token:', error);
                return false;
            }
        }

        // Sincronizar km desde Strava
        async function sincronizarStravaManual() {
            if (!await renovarTokenStrava()) {
                mostrarNotificacion('Error: Token de Strava expirado. Reconecta tu cuenta.', 'error');
                return;
            }

            mostrarNotificacion('Sincronizando con Strava...', 'info');

            try {
                // Obtener actividades de los √∫ltimos 30 d√≠as
                const treintaDiasAtras = Math.floor((Date.now() - 30 * 24 * 60 * 60 * 1000) / 1000);
                const response = await fetch(`${STRAVA_API_URL}/athlete/activities?after=${treintaDiasAtras}&per_page=100`, {
                    headers: {
                        'Authorization': `Bearer ${datosUsuario.stravaAccessToken}`
                    }
                });

                if (!response.ok) throw new Error('Error obteniendo actividades');

                const actividades = await response.json();
                let kmActualizados = 0;

                // Agrupar actividades por bici
                const kmPorBici = {};
                actividades.forEach(act => {
                    if (act.gear_id) {
                        if (!kmPorBici[act.gear_id]) {
                            kmPorBici[act.gear_id] = 0;
                        }
                        kmPorBici[act.gear_id] += act.distance / 1000; // Convertir a km
                    }
                });

                // Actualizar bicis vinculadas
                datosUsuario.garaje.forEach(bici => {
                    if (bici.stravaBiciId && kmPorBici[bici.stravaBiciId]) {
                        const kmNuevos = Math.round(kmPorBici[bici.stravaBiciId]);
                        if (kmNuevos > 0) {
                            bici.kmTotales += kmNuevos;
                            kmActualizados += kmNuevos;
                        }
                    }
                });

                if (kmActualizados > 0) {
                    await guardarDatosUsuario();
                    mostrarNotificacion(`‚úÖ ${kmActualizados} km sincronizados`, 'exito');
                    if (biciActual) {
                        cargarTaller();
                    }
                } else {
                    mostrarNotificacion('No hay km nuevos para sincronizar', 'info');
                }
            } catch (error) {
                console.error('Error sincronizando:', error);
                mostrarNotificacion('Error al sincronizar con Strava', 'error');
            }
        }

        // Abrir modal para vincular bici con Strava
        async function abrirModalVincularStrava() {
            if (!biciActual) return;

            // Verificar si est√° conectado con Strava
            if (!datosUsuario.stravaAccessToken) {
                document.getElementById('vincular-strava-no-conectado').style.display = 'block';
                document.getElementById('vincular-strava-conectado').style.display = 'none';
                abrirModal('modal-vincular-strava');
                return;
            }

            // Renovar token si es necesario
            if (!await renovarTokenStrava()) {
                mostrarNotificacion('Error: Token de Strava expirado. Reconecta tu cuenta.', 'error');
                return;
            }

            try {
                // Obtener bicis de Strava usando el endpoint correcto
                const response = await fetch(`${STRAVA_API_URL}/athlete`, {
                    headers: {
                        'Authorization': `Bearer ${datosUsuario.stravaAccessToken}`
                    }
                });

                if (!response.ok) {
                    console.error('Response no OK:', response.status, response.statusText);
                    throw new Error('Error obteniendo datos del atleta');
                }

                const atleta = await response.json();
                console.log('Datos del atleta:', atleta);
                
                // Obtener actividades recientes para extraer los gear_id
                const activitiesResponse = await fetch(`${STRAVA_API_URL}/athlete/activities?per_page=100`, {
                    headers: {
                        'Authorization': `Bearer ${datosUsuario.stravaAccessToken}`
                    }
                });
                
                if (!activitiesResponse.ok) {
                    throw new Error('Error obteniendo actividades');
                }
                
                const actividades = await activitiesResponse.json();
                console.log('Actividades obtenidas:', actividades.length);
                
                // Extraer gear_ids √∫nicos
                const gearIds = new Set();
                actividades.forEach(act => {
                    if (act.gear_id) {
                        gearIds.add(act.gear_id);
                    }
                });
                
                console.log('IDs de bicis √∫nicos encontrados:', Array.from(gearIds));
                
                // Obtener detalles de cada bici
                const bicis = [];
                for (const gearId of gearIds) {
                    try {
                        const gearResponse = await fetch(`${STRAVA_API_URL}/gear/${gearId}`, {
                            headers: {
                                'Authorization': `Bearer ${datosUsuario.stravaAccessToken}`
                            }
                        });
                        
                        if (gearResponse.ok) {
                            const gear = await gearResponse.json();
                            bicis.push({
                                id: gear.id,
                                name: gear.name,
                                brand_name: gear.brand_name || '',
                                model_name: gear.model_name || '',
                                distance: gear.distance || 0
                            });
                            console.log('Bici obtenida:', gear.name);
                        }
                    } catch (error) {
                        console.error('Error obteniendo detalles de gear', gearId, error);
                    }
                }
                
                console.log('Total bicis con detalles:', bicis.length);
                
                const select = document.getElementById('vincular-strava-select');
                select.innerHTML = '<option value="">-- No vincular / Desvincular --</option>';

                if (bicis.length > 0) {
                    console.log('A√±adiendo', bicis.length, 'bicis al select');
                    bicis.forEach(bici => {
                        const option = document.createElement('option');
                        option.value = bici.id;
                        const km = Math.round(bici.distance / 1000);
                        option.textContent = `${bici.name}${bici.brand_name ? ' - ' + bici.brand_name + ' ' + bici.model_name : ''} (${km} km)`;
                        if (biciActual.stravaBiciId === bici.id) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else {
                    console.log('No se encontraron bicis en el perfil de Strava');
                }

                // Mostrar vinculaci√≥n actual si existe
                if (biciActual.stravaBiciId) {
                    document.getElementById('vincular-bici-actual').style.display = 'block';
                    document.getElementById('vincular-bici-actual-nombre').textContent = biciActual.stravaBiciNombre || 'Bici de Strava';
                } else {
                    document.getElementById('vincular-bici-actual').style.display = 'none';
                }

                document.getElementById('vincular-bici-nombre').textContent = biciActual.alias;
                document.getElementById('vincular-strava-no-conectado').style.display = 'none';
                document.getElementById('vincular-strava-conectado').style.display = 'block';
                abrirModal('modal-vincular-strava');
            } catch (error) {
                console.error('Error obteniendo bicis de Strava:', error);
                mostrarNotificacion('Error al obtener bicis de Strava', 'error');
            }
        }

        // Guardar vinculaci√≥n de bici con Strava
        async function guardarVinculacionStrava() {
            const select = document.getElementById('vincular-strava-select');
            const stravaBiciId = select.value;

            if (stravaBiciId) {
                const selectedOption = select.options[select.selectedIndex];
                biciActual.stravaBiciId = stravaBiciId;
                biciActual.stravaBiciNombre = selectedOption.textContent;
                mostrarNotificacion('Bici vinculada con Strava', 'exito');
            } else {
                delete biciActual.stravaBiciId;
                delete biciActual.stravaBiciNombre;
                mostrarNotificacion('Vinculaci√≥n eliminada', 'info');
            }

            await guardarDatosUsuario();
            cerrarModal('modal-vincular-strava');
            cargarTaller();
        }

        // Actualizar visualizaci√≥n de estado de Strava en perfil
        function actualizarEstadoStrava() {
            const conectado = datosUsuario && datosUsuario.stravaAccessToken;
            
            if (conectado) {
                document.getElementById('strava-desconectado').style.display = 'none';
                document.getElementById('strava-conectado').style.display = 'block';
                document.getElementById('strava-cargando').style.display = 'none';
                document.getElementById('strava-atleta-nombre').textContent = datosUsuario.stravaAtletaNombre || 'Atleta';
            } else {
                document.getElementById('strava-desconectado').style.display = 'block';
                document.getElementById('strava-conectado').style.display = 'none';
                document.getElementById('strava-cargando').style.display = 'none';
            }
        }

        // ========================================
        // INICIALIZACI√ìN AL CARGAR
        // ========================================
        window.onload = () => {
            // Detectar callback de Strava
            const urlParams = new URLSearchParams(window.location.search);
            const stravaCode = urlParams.get('code');
            const stravaState = urlParams.get('state');

            // Escuchar cambios en el estado de autenticaci√≥n
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Usuario autenticado
                    usuarioActual = user;
                    await cargarDatosUsuario(user.uid);
                    
                    // Procesar callback de Strava si existe
                    if (stravaCode && stravaState === 'strava_auth') {
                        await procesarCallbackStrava(stravaCode);
                        navegar('sec-perfil');
                    } else {
                        navegar('sec-dashboard');
                    }
                } else {
                    // No hay usuario autenticado
                    usuarioActual = null;
                    datosUsuario = null;
                    navegar('sec-login');
                }
            });
        };

    </script>

</body>
</html>
