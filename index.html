<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyBikeGestor v3.0</title>
    
    <!-- PWA -->
    <meta name="theme-color" content="#4CAF50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MyBikeGestor">
    <link rel="icon" type="image/png" href="./logo.png">
    <link rel="apple-touch-icon" href="./logo.png">
    <link rel="manifest" href="./manifest.json">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        /* ========================================
           VARIABLES DE COLORES Y TEMA
        ======================================== */
        :root {
            --primary: #2ecc71;
            --primary-dark: #27ae60;
            --secondary: #3498db;
            --bg: #f5f6fa;
            --dark: #2c3e50;
            --text: #7f8c8d;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light-gray: #ecf0f1;
            --white: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        /* ========================================
           ESTILOS GENERALES
        ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        /* ========================================
           CONTENEDOR PRINCIPAL
        ======================================== */
        #app-container {
            width: 100%;
            max-width: 420px;
            background: var(--white);
            min-height: 600px;
            box-shadow: 0 20px 60px var(--shadow);
            border-radius: 30px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========================================
           SECCIONES / PANTALLAS
        ======================================== */
        .seccion {
            display: none;
            flex-direction: column;
            padding: 30px;
            flex-grow: 1;
            animation: fadeIn 0.3s ease;
        }

        .seccion.activa {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========================================
           HEADER / ENCABEZADOS
        ======================================== */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: var(--dark);
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header .app-name {
            color: var(--primary);
            font-weight: bold;
        }

        .header p {
            color: var(--text);
            font-size: 0.9em;
        }

        /* ========================================
           FORMULARIOS
        ======================================== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 0.85em;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* ========================================
           BOTONES
        ======================================== */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--white);
        }

        .btn-secondary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        /* Tooltips en botones */
        [title] {
            position: relative;
        }
        [title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: calc(100% + 6px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.78);
            color: #fff;
            padding: 4px 9px;
            border-radius: 6px;
            font-size: 0.72em;
            white-space: nowrap;
            pointer-events: none;
            z-index: 9999;
            font-weight: 500;
        }
        [title]:hover::before {
            content: '';
            position: absolute;
            bottom: calc(100% + 1px);
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0,0,0,0.78);
            pointer-events: none;
            z-index: 9999;
        }

        .btn-link {
            background: transparent;
            color: var(--secondary);
            font-size: 0.9em;
            text-decoration: underline;
        }

        .btn-link:hover {
            opacity: 0.8;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* ========================================
           CARDS / TARJETAS
        ======================================== */
        .card {
            background: var(--white);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px var(--shadow);
            border-left: 5px solid var(--primary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: 700;
            font-size: 1.2em;
            color: var(--dark);
        }

        .card-subtitle {
            color: var(--text);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        /* ========================================
           BADGES / ETIQUETAS
        ======================================== */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .badge-primary {
            background: #e8f8f0;
            color: var(--primary);
        }

        .badge-secondary {
            background: #e3f2fd;
            color: var(--secondary);
        }

        /* ========================================
           LISTAS
        ======================================== */
        .lista-vacia {
            text-align: center;
            padding: 40px 20px;
            color: var(--text);
        }

        .lista-vacia-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }

        /* ========================================
           BARRA DE NAVEGACI√ìN SUPERIOR
        ======================================== */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: var(--white);
            border-bottom: 1px solid var(--light-gray);
        }

        .topbar-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--dark);
        }

        .btn-back {
            background: var(--light-gray);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: #d5dbdb;
        }

        /* ========================================
           UTILIDADES
        ======================================== */
        .text-center {
            text-align: center;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .text-muted {
            color: var(--text);
            font-size: 0.9em;
        }

        /* ========================================
           MODALES
        ======================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.activo {
            display: flex;
        }

        .modal-contenido {
            background: var(--white);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        /* ========================================
           GRID DE ACCIONES
        ======================================== */
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-grid-item {
            padding: 20px;
            border: none;
            border-radius: 16px;
            background: var(--light-gray);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn-grid-item:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }

        .btn-grid-item-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .btn-grid-item-text {
            font-weight: 600;
            color: var(--dark);
        }

        /* ========================================
           RESPONSIVE
        ======================================== */
        @media (max-width: 480px) {
            #app-container {
                border-radius: 0;
                max-width: 100%;
                min-height: 100vh;
            }

            body {
                padding: 0;
            }
        }

        /* ========================================
           SISTEMA DE NOTIFICACIONES
        ======================================== */
        .notificacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 250px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notificacion-exito {
            border-left: 4px solid var(--primary);
        }

        .notificacion-error {
            border-left: 4px solid var(--danger);
        }

        .notificacion-info {
            border-left: 4px solid var(--secondary);
        }

        .notificacion-icono {
            font-size: 1.5em;
        }

        .notificacion-texto {
            flex: 1;
            font-weight: 500;
            color: var(--dark);
        }

        /* Modal de confirmaci√≥n personalizado */
        .modal-confirmar {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-confirmar.activo {
            display: flex;
        }

        .modal-confirmar-contenido {
            background: white;
            padding: 25px;
            border-radius: 16px;
            max-width: 350px;
            text-align: center;
        }

        .modal-confirmar-titulo {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--dark);
        }

        .modal-confirmar-botones {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .profile-photo-container {
            position: relative; width: 120px; height: 120px;
            margin: 0 auto 15px auto; cursor: pointer;
        }
        .profile-photo {
            width: 100%; height: 100%; border-radius: 50%;
            border: 4px solid var(--primary); background: var(--light-gray);
            display: flex; align-items: center; justify-content: center;
            font-size: 3em; overflow: hidden;
        }
        .profile-photo-overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; border-radius: 50%;
            background: rgba(0,0,0,0.6); display: flex;
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s; color: white; font-size: 2em;
        }
        .profile-photo-container:hover .profile-photo-overlay { opacity: 1; }
        .photo-options {
            display: none; position: absolute; top: 100%; left: 50%;
            transform: translateX(-50%); background: white;
            border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            padding: 10px; margin-top: 10px; z-index: 1000; min-width: 200px;
        }
        .photo-options.active { display: block; }
        .photo-option-btn {
            width: 100%; padding: 12px; border: none; background: none;
            text-align: left; cursor: pointer; border-radius: 5px;
            transition: background 0.3s; display: flex; align-items: center;
            gap: 10px; font-size: 1em;
        }
        .photo-option-btn:hover { background: var(--light-gray); }

        /* ========================================
           PANEL ADMINISTRACI√ìN
        ======================================== */
        .admin-user-card {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .admin-user-name {
            font-weight: 700;
            font-size: 1em;
            color: var(--dark);
        }
        .admin-user-email {
            font-size: 0.82em;
            color: var(--text);
            margin-top: 2px;
        }
        .admin-user-meta {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 0.78em;
            color: var(--text);
        }
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .admin-stat-box {
            background: var(--light-gray);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        .admin-stat-num {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary);
        }
        .admin-stat-label {
            font-size: 0.72em;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

    </style>
</head>
<body>

    <!-- ========================================
         CONTENEDOR PRINCIPAL DE LA APP
    ======================================== -->
    <div id="app-container">

        <!-- ========================================
             SECCI√ìN: LOGIN
        ======================================== -->
        <section id="sec-login" class="seccion activa">
            <!-- Logo de la aplicaci√≥n -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 200px; height: 200px; margin: 0 auto; border-radius: 20px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    <img src="./logo.png" alt="MyBikeGestor" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="login-usuario" placeholder="tu@email.com" onkeydown="if(event.key==='Enter') iniciarSesion()">
            </div>

            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="login-password" placeholder="Escribe tu contrase√±a" onkeydown="if(event.key==='Enter') iniciarSesion()">
            </div>

            <button class="btn btn-primary" onclick="iniciarSesion()">Entrar</button>
            <button class="btn btn-link" onclick="abrirModalRecuperarPassword()" style="margin-top: 10px; font-size: 0.85em;">¬øOlvidaste tu contrase√±a?</button>
            <button class="btn btn-link mt-20" onclick="navegar('sec-registro')">¬øNo tienes cuenta? Reg√≠strate</button>
            
            <div style="text-align: center; margin-top: 30px; font-size: 0.75em; color: var(--text);">
                <a href="#" onclick="event.preventDefault(); navegar('sec-terminos');" style="color: var(--text); text-decoration: underline;">T√©rminos</a>
                <span style="margin: 0 10px;">¬∑</span>
                <a href="#" onclick="event.preventDefault(); navegar('sec-privacidad');" style="color: var(--text); text-decoration: underline;">Privacidad</a>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: REGISTRO
        ======================================== -->
        <section id="sec-registro" class="seccion">
            <div class="header">
                <h1>Crear cuenta</h1>
                <p>√önete a <span class="app-name">MyBikeGestor</span></p>
            </div>

            <div class="form-group">
                <label>Email</label>
                <input type="email" id="reg-email" placeholder="tu@email.com">
            </div>

            <div class="form-group">
                <label>Contrase√±a</label>
                <input type="password" id="reg-password" placeholder="M√≠nimo 6 caracteres">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: flex-start; font-weight: normal; cursor: pointer;">
                    <input type="checkbox" id="reg-terminos" style="width: auto; margin-right: 10px; margin-top: 3px; cursor: pointer;">
                    <span style="font-size: 0.85em; color: var(--text);">
                        Acepto los <a href="#" onclick="event.preventDefault(); navegar('sec-terminos');" style="color: var(--primary); text-decoration: underline;">T√©rminos y Condiciones</a> 
                        y la <a href="#" onclick="event.preventDefault(); navegar('sec-privacidad');" style="color: var(--primary); text-decoration: underline;">Pol√≠tica de Privacidad</a>
                    </span>
                </label>
            </div>

            <button class="btn btn-primary" onclick="registrarUsuario()">Crear cuenta</button>
            <button class="btn btn-link mt-20" onclick="navegar('sec-login')">Ya tengo cuenta</button>
        </section>

        <!-- ========================================
             SECCI√ìN: T√âRMINOS Y CONDICIONES
        ======================================== -->
        <section id="sec-terminos" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="history.back()">‚Üê</button>
                <div class="topbar-title">T√©rminos y Condiciones</div>
                <div style="width: 40px;"></div>
            </div>

            <div style="padding: 20px; overflow-y: auto;">
                <h2 style="color: var(--dark); margin-bottom: 15px;">T√©rminos y Condiciones de Uso</h2>
                <p style="color: var(--text); margin-bottom: 15px; font-size: 0.9em;">√öltima actualizaci√≥n: Febrero 2026</p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">1. Aceptaci√≥n de los t√©rminos</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Al acceder y utilizar MyBikeGestor, aceptas estar sujeto a estos t√©rminos y condiciones de uso.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">2. Descripci√≥n del servicio</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    MyBikeGestor es una aplicaci√≥n web que permite a los usuarios gestionar el mantenimiento de sus bicicletas, 
                    registrar componentes, kil√≥metros y llevar un historial de reparaciones.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">3. Uso de la cuenta</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Eres responsable de mantener la confidencialidad de tu contrase√±a y de todas las actividades 
                    que ocurran bajo tu cuenta. Debes notificar inmediatamente cualquier uso no autorizado de tu cuenta.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">4. Contenido del usuario</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Mantienes todos los derechos sobre los datos que introduces en la aplicaci√≥n. MyBikeGestor no 
                    reclamar√° propiedad sobre tu informaci√≥n personal ni sobre los datos de tus bicicletas.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">5. Limitaci√≥n de responsabilidad</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    MyBikeGestor se proporciona "tal cual" sin garant√≠as de ning√∫n tipo. No nos hacemos responsables 
                    de cualquier da√±o directo, indirecto, incidental o consecuente derivado del uso de la aplicaci√≥n.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">6. Modificaciones</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Nos reservamos el derecho de modificar estos t√©rminos en cualquier momento. 
                    Los cambios entrar√°n en vigor inmediatamente despu√©s de su publicaci√≥n.
                </p>

                <button class="btn btn-primary mt-20" onclick="history.back()">Cerrar</button>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: POL√çTICA DE PRIVACIDAD
        ======================================== -->
        <section id="sec-privacidad" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="history.back()">‚Üê</button>
                <div class="topbar-title">Pol√≠tica de Privacidad</div>
                <div style="width: 40px;"></div>
            </div>

            <div style="padding: 20px; overflow-y: auto;">
                <h2 style="color: var(--dark); margin-bottom: 15px;">Pol√≠tica de Privacidad y Protecci√≥n de Datos</h2>
                <p style="color: var(--text); margin-bottom: 15px; font-size: 0.9em;">√öltima actualizaci√≥n: Febrero 2026</p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">1. Responsable del tratamiento</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    El responsable del tratamiento de tus datos personales es el administrador de MyBikeGestor.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">2. Datos que recopilamos</h3>
                <p style="color: var(--text); margin-bottom: 10px; line-height: 1.6;">
                    Recopilamos y almacenamos la siguiente informaci√≥n:
                </p>
                <ul style="color: var(--text); margin-bottom: 15px; line-height: 1.6; padding-left: 20px;">
                    <li>Email (necesario para el registro y recuperaci√≥n de cuenta)</li>
                    <li>Datos de perfil (nombre, apellidos, fecha de nacimiento, datos f√≠sicos - opcional)</li>
                    <li>Informaci√≥n de tus bicicletas (marca, modelo, componentes, kil√≥metros)</li>
                    <li>Historial de mantenimiento</li>
                </ul>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">3. Finalidad del tratamiento</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Utilizamos tus datos exclusivamente para:
                </p>
                <ul style="color: var(--text); margin-bottom: 15px; line-height: 1.6; padding-left: 20px;">
                    <li>Gestionar tu cuenta de usuario</li>
                    <li>Permitirte acceder y utilizar las funcionalidades de la aplicaci√≥n</li>
                    <li>Guardar y sincronizar tus datos entre dispositivos</li>
                </ul>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">4. Base legal</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    El tratamiento de tus datos se basa en tu consentimiento expreso al registrarte y aceptar 
                    estos t√©rminos, as√≠ como en la ejecuci√≥n del contrato de prestaci√≥n del servicio.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">5. Almacenamiento de datos</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Tus datos se almacenan de forma segura en Firebase (Google Cloud Platform) con servidores 
                    ubicados en la Uni√≥n Europea (regi√≥n: europe-southwest1, Madrid).
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">6. Compartir datos con terceros</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    No compartimos, vendemos ni cedemos tus datos personales a terceros. √önicamente utilizamos 
                    Firebase/Google como proveedor de infraestructura t√©cnica.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">7. Tus derechos (RGPD)</h3>
                <p style="color: var(--text); margin-bottom: 10px; line-height: 1.6;">
                    Conforme al RGPD, tienes derecho a:
                </p>
                <ul style="color: var(--text); margin-bottom: 15px; line-height: 1.6; padding-left: 20px;">
                    <li><strong>Acceso:</strong> Conocer qu√© datos personales tenemos sobre ti</li>
                    <li><strong>Rectificaci√≥n:</strong> Corregir datos inexactos o incompletos</li>
                    <li><strong>Supresi√≥n:</strong> Solicitar la eliminaci√≥n de tus datos</li>
                    <li><strong>Portabilidad:</strong> Obtener una copia de tus datos</li>
                    <li><strong>Oposici√≥n:</strong> Oponerte al tratamiento de tus datos</li>
                    <li><strong>Limitaci√≥n:</strong> Solicitar la limitaci√≥n del tratamiento</li>
                </ul>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Para ejercer estos derechos, contacta con el administrador de la aplicaci√≥n.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">8. Seguridad</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Implementamos medidas de seguridad t√©cnicas y organizativas para proteger tus datos personales 
                    contra acceso no autorizado, p√©rdida o alteraci√≥n. Utilizamos Firebase Authentication y Firestore 
                    con cifrado en tr√°nsito y en reposo.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">9. Cookies</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    La aplicaci√≥n utiliza sessionStorage y localStorage para mantener tu sesi√≥n activa y mejorar 
                    la experiencia de usuario. No utilizamos cookies de terceros ni cookies publicitarias.
                </p>

                <h3 style="color: var(--dark); margin: 20px 0 10px 0; font-size: 1.1em;">10. Cambios en la pol√≠tica</h3>
                <p style="color: var(--text); margin-bottom: 15px; line-height: 1.6;">
                    Podemos actualizar esta pol√≠tica de privacidad ocasionalmente. Te notificaremos de cualquier 
                    cambio significativo.
                </p>

                <button class="btn btn-primary mt-20" onclick="history.back()">Cerrar</button>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: DASHBOARD / MEN√ö PRINCIPAL
        ======================================== -->
        <section id="sec-dashboard" class="seccion">
            <div class="topbar">
                <div class="topbar-title">MyBikeGestor</div>
                <button class="btn-back" onclick="cerrarSesion()">üö™</button>
            </div>

            <!-- Perfil de usuario -->
            <div class="card" style="text-align: center; margin-top: 20px;">
                <div class="profile-photo-container" id="profile-photo-container" onclick="togglePhotoOptions()">
                    <div class="profile-photo">
                        <span id="dashboard-initials">üë§</span>
                        <img id="dashboard-photo-img" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:50%;">
                    </div>
                    <div class="profile-photo-overlay">üì∑</div>
                    <div class="photo-options" id="photo-options">
                        <button class="photo-option-btn" onclick="event.stopPropagation(); selectPhotoSource('camera')">üì∑ Tomar foto</button>
                        <button class="photo-option-btn" onclick="event.stopPropagation(); selectPhotoSource('gallery')">üñºÔ∏è Elegir de galer√≠a</button>
                        <button class="photo-option-btn" onclick="event.stopPropagation(); removeProfilePhoto()" style="color:var(--danger)">üóëÔ∏è Eliminar foto</button>
                    </div>
                </div>
                <input type="file" id="photo-input" accept="image/*" style="display:none;" onchange="handlePhotoSelected(event)">
                <div class="card-title" id="dashboard-usuario">Usuario</div>
                <div class="card-subtitle" id="dashboard-email"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f49199959d98b4919e919984989bda979b99">[email&#160;protected]</a></div>
            </div>

            <!-- Resumen de bicis -->
            <div class="card">
                <div class="card-title">üìä Resumen</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 10px;">
                        <div class="text-muted" style="font-size: 0.8em;">Bicis Activas</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--primary);" id="dashboard-bicis-activas">0</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 10px;">
                        <div class="text-muted" style="font-size: 0.8em;">KM Totales</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--secondary);" id="dashboard-km-totales">0</div>
                    </div>
                </div>
            </div>

            <!-- Botones de navegaci√≥n -->
            <div class="btn-grid">
                <button class="btn-grid-item" onclick="navegar('sec-garaje')" style="grid-column: span 2;">
                    <div class="btn-grid-item-icon">üö¥</div>
                    <div class="btn-grid-item-text">Mi Garaje</div>
                </button>
                <button class="btn-grid-item" onclick="navegar('sec-perfil')">
                    <div class="btn-grid-item-icon">üë§</div>
                    <div class="btn-grid-item-text">Mi Perfil</div>
                </button>
                <button class="btn-grid-item" onclick="mostrarNotificacion('Pr√≥ximamente: Configuraci√≥n', 'info')">
                    <div class="btn-grid-item-icon">‚öôÔ∏è</div>
                    <div class="btn-grid-item-text">Ajustes</div>
                </button>
                <button class="btn-grid-item" id="btn-admin-dashboard" style="display:none; grid-column: span 2; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="navegar('sec-admin')">
                    <div class="btn-grid-item-icon">üëë</div>
                    <div class="btn-grid-item-text">Panel Admin</div>
                </button>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: PERFIL DE USUARIO
        ======================================== -->
        <section id="sec-perfil" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-dashboard')">‚Üê</button>
                <div class="topbar-title">Mi Perfil</div>
                <div style="width: 40px;"></div>
            </div>

            <div style="text-align: center; margin: 20px 0 30px 0;">
                <div style="font-size: 4em;">üë§</div>
                <div style="font-size: 1.3em; font-weight: bold; color: var(--dark); margin-top: 10px;" id="perfil-nombre-completo">Usuario</div>
            </div>

            <!-- DATOS PERSONALES -->
            <div class="card">
                <div class="card-title" style="margin-bottom: 20px;">üìã Datos Personales</div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="perfil-usuario" disabled style="background: var(--light-gray);">
                </div>

                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" id="perfil-nombre" placeholder="Tu nombre">
                </div>

                <div class="form-group">
                    <label>Apellidos</label>
                    <input type="text" id="perfil-apellidos" placeholder="Tus apellidos">
                </div>

                <div class="form-group">
                    <label>Fecha de nacimiento</label>
                    <input type="date" id="perfil-fecha-nacimiento">
                </div>

                <!-- Edad calculada -->
                <div id="perfil-edad-display" style="background: var(--light-gray); padding: 12px; border-radius: 10px; text-align: center; display: none;">
                    <span style="color: var(--text); font-size: 0.9em;">Edad: </span>
                    <span style="font-weight: bold; color: var(--primary); font-size: 1.2em;" id="perfil-edad-valor">0 a√±os</span>
                </div>

                <div class="form-group">
                    <label>Nueva contrase√±a (dejar vac√≠o para no cambiar)</label>
                    <input type="password" id="perfil-password" placeholder="Nueva contrase√±a (m√≠nimo 6 caracteres)">
                </div>
            </div>

            <!-- DATOS F√çSICOS -->
            <div class="card mt-20">
                <div class="card-title" style="margin-bottom: 20px;">üí™ Datos F√≠sicos</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Peso (kg)</label>
                        <input type="number" id="perfil-peso" placeholder="70" step="0.1">
                    </div>

                    <div class="form-group">
                        <label>Altura (cm)</label>
                        <input type="number" id="perfil-altura" placeholder="175">
                    </div>
                </div>

                <!-- IMC calculado -->
                <div id="perfil-imc-display" style="background: var(--light-gray); padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 20px; display: none;">
                    <div style="color: var(--text); font-size: 0.85em; margin-bottom: 5px;">√çndice de Masa Corporal (IMC)</div>
                    <div style="font-weight: bold; font-size: 1.8em; margin-bottom: 5px;" id="perfil-imc-valor">0.0</div>
                    <div style="font-size: 0.85em; font-weight: 600;" id="perfil-imc-categoria">-</div>
                </div>

                <div class="form-group">
                    <label>FTP - Potencia Umbral (W)</label>
                    <input type="number" id="perfil-ftp" placeholder="200">
                </div>

                <div class="form-group">
                    <label>FC M√°xima (ppm)</label>
                    <input type="number" id="perfil-fc-max" placeholder="190">
                </div>

                <div class="form-group">
                    <label>VO2 Max (ml/kg/min)</label>
                    <input type="number" id="perfil-vo2max" placeholder="50" step="0.1">
                </div>
            </div>

            <!-- INTEGRACI√ìN CON STRAVA -->
            <div class="card mt-20">
                <div class="card-title" style="margin-bottom: 20px;">üö¥ Conexi√≥n con Strava</div>
                
                <div id="strava-desconectado" style="display: none;">
                    <p style="color: var(--text); margin-bottom: 15px; font-size: 0.9em;">
                        Conecta tu cuenta de Strava para sincronizar autom√°ticamente los kil√≥metros de tus salidas.
                    </p>
                    <!-- Bot√≥n oficial de Strava seg√∫n brand guidelines -->
                    <button onclick="conectarStrava()" style="background: #FC4C02; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 1em; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; transition: background 0.2s;" onmouseover="this.style.background='#E34402'" onmouseout="this.style.background='#FC4C02'">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169" fill="white"/>
                        </svg>
                        Connect with Strava
                    </button>
                </div>

                <div id="strava-conectado" style="display: none;">
                    <div style="background: var(--light-gray); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 2em;">‚úÖ</span>
                            <div>
                                <div style="font-weight: bold; color: var(--primary);">Conectado con Strava</div>
                                <div style="font-size: 0.85em; color: var(--text);" id="strava-atleta-nombre">Atleta</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-danger mt-10" onclick="desconectarStrava()">
                        Desconectar Strava
                    </button>
                </div>

                <div id="strava-cargando" style="display: none; text-align: center; padding: 20px;">
                    <div style="font-size: 2em;">‚è≥</div>
                    <div style="margin-top: 10px; color: var(--text);">Conectando con Strava...</div>
                </div>
            </div>

            <button class="btn btn-primary mt-20" onclick="guardarPerfil()">Guardar Cambios</button>
            <button class="btn btn-secondary mt-20" onclick="navegar('sec-dashboard')">Volver</button>
        </section>

        <!-- ========================================
             SECCI√ìN: GARAJE (LISTA DE BICIS)
        ======================================== -->
        <section id="sec-garaje" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-dashboard')">‚Üê</button>
                <div class="topbar-title">Mi Garaje üö¥</div>
                <div style="width: 40px;"></div>
            </div>

            <div id="lista-bicis" class="mt-20">
                <!-- Aqu√≠ se generar√°n las tarjetas de las bicis -->
            </div>

            <button class="btn btn-primary mt-20" onclick="navegar('sec-nueva-bici')">‚ûï A√±adir Bicicleta</button>
            
            <!-- Bot√≥n para ver bicis retiradas (solo visible si hay alguna) -->
            <button id="btn-ver-retiradas" class="btn btn-secondary mt-20" style="display: none;" onclick="navegar('sec-bicis-retiradas')">
                üì¶ Ver Bicis Retiradas
            </button>
        </section>

        <!-- ========================================
             SECCI√ìN: NUEVA BICICLETA
        ======================================== -->
        <section id="sec-nueva-bici" class="seccion">
            <div class="topbar">
                <button class="btn-back" id="btn-back-nueva-bici" onclick="navegar('sec-garaje')">‚Üê</button>
                <div class="topbar-title" id="titulo-nueva-bici">Nueva Bici</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="form-group">
                <label>Alias / Nombre</label>
                <input type="text" id="nueva-alias" placeholder="Ej: La Bestia">
            </div>

            <div class="form-group">
                <label>Marca</label>
                <select id="nueva-marca">
                    <option value="">Selecciona una marca</option>
                    <option value="Basso">Basso</option>
                    <option value="BH">BH</option>
                    <option value="Bianchi">Bianchi</option>
                    <option value="BMC">BMC</option>
                    <option value="Cannondale">Cannondale</option>
                    <option value="Canyon">Canyon</option>
                    <option value="Cerv√©lo">Cerv√©lo</option>
                    <option value="Colnago">Colnago</option>
                    <option value="Cube">Cube</option>
                    <option value="Factor">Factor</option>
                    <option value="Focus">Focus</option>
                    <option value="Giant">Giant</option>
                    <option value="Kona">Kona</option>
                    <option value="Lifefitness">Lifefitness</option>
                    <option value="Merida">Merida</option>
                    <option value="Orbea">Orbea</option>
                    <option value="Pinarello">Pinarello</option>
                    <option value="Pivot">Pivot</option>
                    <option value="Santa Cruz">Santa Cruz</option>
                    <option value="Scott">Scott</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Trek">Trek</option>
                    <option value="Wilier">Wilier</option>
                    <option value="Yeti">Yeti</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="nueva-modelo" placeholder="Ej: Ultimate CF SLX">
            </div>

            <div class="form-group">
                <label>Disciplina</label>
                <select id="nueva-disciplina">
                    <option value="Carretera">Carretera</option>
                    <option value="MTB">MTB</option>
                    <option value="Gravel">Gravel</option>
                    <option value="Urbana">Urbana</option>
                    <option value="El√©ctrica">El√©ctrica</option>
                    <option value="Indoor">Indoor / Est√°tica</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group">
                <label>Fecha de compra</label>
                <input type="date" id="nueva-fecha" value="">
            </div>

            <div class="form-group">
                <label>Kil√≥metros iniciales (opcional)</label>
                <input type="number" id="nueva-km" placeholder="0" value="0">
            </div>

            <button class="btn btn-primary" id="btn-guardar-bici" onclick="guardarBici()">Crear Bicicleta</button>
            <button class="btn btn-secondary mt-20" onclick="cancelarFormBici()">Cancelar</button>
        </section>

        <!-- ========================================
             SECCI√ìN: GARAJE DE RUEDAS
        ======================================== -->
        <section id="sec-garaje-ruedas" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-componentes')">‚Üê</button>
                <div class="topbar-title" style="font-size:1em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">‚≠ï Ruedas ¬∑ <span id="garaje-ruedas-nombre-bici"></span></div>
                <div style="width: 40px;"></div>
            </div>

            <div id="lista-juegos-ruedas" class="mt-20">
                <!-- Generado din√°micamente -->
            </div>

            <button class="btn btn-primary mt-20" onclick="abrirModalNuevoJuegoRuedas()">‚ûï A√±adir Juego de Ruedas</button>
            <button id="btn-ver-ruedas-retiradas" class="btn btn-secondary mt-20" style="display:none;" onclick="navegar('sec-ruedas-retiradas')">üì¶ Ver Ruedas Retiradas</button>
        </section>

        <!-- ========================================
             SECCI√ìN: RUEDAS RETIRADAS
        ======================================== -->
        <section id="sec-ruedas-retiradas" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-garaje-ruedas')">‚Üê</button>
                <div class="topbar-title">üì¶ Ruedas Retiradas</div>
                <div style="width: 40px;"></div>
            </div>
            <div class="text-muted text-center mb-20" style="margin-top:15px;">
                <p>Juegos de ruedas retirados ¬∑ Puedes reactivarlos cuando quieras</p>
            </div>
            <div id="lista-ruedas-retiradas" class="mt-20"></div>
        </section>

        <!-- ========================================
             SECCI√ìN: DETALLE JUEGO DE RUEDAS (Ver Ruedas)
        ======================================== -->
        <section id="sec-detalle-juego-ruedas" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-garaje-ruedas')">‚Üê</button>
                <div class="topbar-title" id="detalle-juego-ruedas-titulo">Juego de Ruedas</div>
                <div style="width: 40px;"></div>
            </div>
            <div id="contenido-detalle-ruedas" class="mt-20"></div>
        </section>

        <!-- ========================================
             SECCI√ìN: DESPIECE DE RUEDA
        ======================================== -->
        <section id="sec-despiece-rueda" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-detalle-juego-ruedas')">‚Üê</button>
                <div class="topbar-title" id="despiece-rueda-titulo">Despiece</div>
                <div style="width: 40px;"></div>
            </div>
            <div id="contenido-despiece-rueda" class="mt-20"></div>
        </section>

        <!-- ========================================
             SECCI√ìN: DESGLOSE PESO
        ======================================== -->
        <section id="sec-desglose-peso" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-taller')">‚Üê</button>
                <div class="topbar-title">‚öñÔ∏è Desglose de Peso</div>
                <div style="width:40px;"></div>
            </div>
            <div id="contenido-desglose-peso" class="mt-20"></div>
        </section>

        <!-- ========================================
             SECCI√ìN: DESGLOSE INVERSI√ìN
        ======================================== -->
        <section id="sec-desglose-inversion" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-taller')">‚Üê</button>
                <div class="topbar-title">üí∞ Desglose de Inversi√≥n</div>
                <div style="width:40px;"></div>
            </div>
            <div id="contenido-desglose-inversion" class="mt-20"></div>
        </section>

        <!-- ========================================
             SECCI√ìN: CAJ√ìN DE PIEZAS
        ======================================== -->
        <section id="sec-cajon-piezas" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-componentes')">‚Üê</button>
                <div class="topbar-title">üì¶ Caj√≥n de Piezas</div>
                <div style="width: 40px;"></div>
            </div>
            <div class="text-muted text-center mb-20" style="margin-top:15px;">
                <p>Piezas guardadas ¬∑ Puedes reinstalarlas cuando quieras</p>
            </div>
            <div id="lista-cajon-piezas" class="mt-20"></div>
        </section>

        <!-- ========================================
             SECCI√ìN: BICIS RETIRADAS
        ======================================== -->
        <section id="sec-bicis-retiradas" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-garaje')">‚Üê</button>
                <div class="topbar-title">Bicis Retiradas üì¶</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="text-muted text-center mb-20">
                <p>Aqu√≠ est√°n las bicis que has retirado del garaje activo</p>
            </div>

            <div id="lista-bicis-retiradas" class="mt-20">
                <!-- Aqu√≠ se generar√°n las tarjetas de las bicis retiradas -->
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: PANEL ADMINISTRACI√ìN
        ======================================== -->
        <section id="sec-admin" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-dashboard')">‚Üê</button>
                <div class="topbar-title">üëë Panel Admin</div>
                <div style="width: 40px;"></div>
            </div>

            <!-- Estad√≠sticas globales -->
            <div class="admin-stats" id="admin-stats">
                <div class="admin-stat-box">
                    <div class="admin-stat-num" id="admin-total-usuarios">-</div>
                    <div class="admin-stat-label">Usuarios</div>
                </div>
                <div class="admin-stat-box">
                    <div class="admin-stat-num" id="admin-total-bicis">-</div>
                    <div class="admin-stat-label">Bicis</div>
                </div>
                <div class="admin-stat-box">
                    <div class="admin-stat-num" id="admin-con-strava">-</div>
                    <div class="admin-stat-label">Con Strava</div>
                </div>
            </div>

            <!-- Lista de usuarios -->
            <div id="admin-lista-usuarios">
                <div class="text-center text-muted">Cargando usuarios...</div>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: DETALLE DE BICI / TALLER
        ======================================== -->
        <section id="sec-taller" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-garaje')">‚Üê</button>
                <div class="topbar-title" id="taller-nombre-bici">Taller</div>
                <button class="btn-back" onclick="mostrarMenuBici()">‚öôÔ∏è</button>
            </div>

            <!-- Resumen de la bici -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title" id="taller-alias" style="font-size: 1.3em; font-weight: 700;"></div>
                        <div class="card-subtitle" id="taller-modelo" style="font-size: 1em; font-weight: 600; color: var(--text);"></div>
                    </div>
                    <span class="badge badge-primary" id="taller-disciplina" style="font-weight: 600;"></span>
                </div>
                
                <!-- Indicador de Strava -->
                <div id="taller-strava-vinculado" style="display: none; margin-top: 15px;">
                    <div style="background: #FC4C02; color: white; padding: 8px 12px; border-radius: 8px 8px 0 0; font-size: 0.85em; text-align: center;">
                        üö¥ Vinculada con Strava: <span id="taller-strava-nombre" style="font-weight: bold;"></span>
                    </div>
                    <button onclick="sincronizarBiciStrava()" style="width:100%; background:#E34402; color:white; border:none; padding:10px; border-radius:0 0 8px 8px; font-size:0.9em; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;" onmouseover="this.style.background='#cc3d02'" onmouseout="this.style.background='#E34402'">
                        üîÑ Sincronizar KM con Strava
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px;">
                        <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); margin-bottom: 5px; font-weight: 600;">Kil√≥metros</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--primary);" id="taller-km">0</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px;">
                        <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); margin-bottom: 5px; font-weight: 600;">Uso</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--primary);" id="taller-uso">0d</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px; cursor:pointer;" onclick="navegar('sec-desglose-peso')">
                        <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); margin-bottom: 5px; font-weight: 600;">Peso</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--secondary);" id="taller-peso">0</div>
                    </div>
                    <div style="text-align: center; padding: 10px; background: var(--light-gray); border-radius: 8px; cursor:pointer;" onclick="navegar('sec-desglose-inversion')">
                        <div style="font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text); margin-bottom: 5px; font-weight: 600;">Inversi√≥n</div>
                        <div style="font-size: 1.6em; font-weight: 700; color: var(--warning);" id="taller-inversion">0‚Ç¨</div>
                    </div>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="btn-grid">
                <button class="btn-grid-item" onclick="navegar('sec-componentes')">
                    <div class="btn-grid-item-icon">üß±</div>
                    <div class="btn-grid-item-text">Componentes</div>
                </button>
                <button class="btn-grid-item" onclick="navegar('sec-historial')">
                    <div class="btn-grid-item-icon">üìã</div>
                    <div class="btn-grid-item-text">Historial</div>
                </button>
                <button class="btn-grid-item" onclick="abrirModalKm()">
                    <div class="btn-grid-item-icon">üìè</div>
                    <div class="btn-grid-item-text">A√±adir KM</div>
                </button>
                <button class="btn-grid-item" id="btn-vincular-strava" onclick="accionStravaBici()">
                    <div class="btn-grid-item-icon" id="btn-vincular-strava-icon">üö¥</div>
                    <div class="btn-grid-item-text" id="btn-vincular-strava-texto">Vincular Strava</div>
                </button>
                <button class="btn-grid-item" onclick="mostrarNotificacion('Pr√≥ximamente: Estad√≠sticas', 'info')">
                    <div class="btn-grid-item-icon">üìä</div>
                    <div class="btn-grid-item-text">Estad√≠sticas</div>
                </button>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: COMPONENTES
        ======================================== -->
        <section id="sec-componentes" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="volverATaller()">‚Üê</button>
                <div class="topbar-title">Componentes</div>
                <div style="width: 40px;"></div>
            </div>

            <p style="color: var(--text); margin: 20px 0; text-align: center;">Selecciona una secci√≥n para gestionar sus componentes</p>

            <!-- Grid de secciones -->
            <div id="grid-secciones-componentes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;">
                <!-- Se generar√° din√°micamente seg√∫n la disciplina -->
            </div>

            <!-- Caj√≥n de piezas (solo visible si hay piezas) -->
            <button id="btn-ver-cajon" class="btn btn-secondary mt-20" style="display:none;" onclick="navegar('sec-cajon-piezas')">üì¶ Caj√≥n de piezas (<span id="cajon-count">0</span>)</button>
        </section>

        <!-- ========================================
             SECCI√ìN: LISTA COMPONENTES DE UNA SECCI√ìN
        ======================================== -->
        <section id="sec-lista-componentes-seccion" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="navegar('sec-componentes')">‚Üê</button>
                <div class="topbar-title" id="titulo-seccion-componentes">Secci√≥n</div>
                <div style="width: 40px;"></div>
            </div>

            <div id="lista-componentes-seccion" class="mt-20">
                <!-- Se generar√° din√°micamente -->
            </div>

            <button class="btn btn-primary mt-20" onclick="abrirModalNuevoComponente()">‚ûï A√±adir Componente</button>
        </section>

        <!-- ========================================
             SECCI√ìN: DETALLE COMPONENTE
        ======================================== -->
        <section id="sec-detalle-componente" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="volverAListaComponentes()">‚Üê</button>
                <div class="topbar-title" id="titulo-detalle-componente">Componente</div>
                <div style="width: 40px;"></div>
            </div>

            <!-- Datos del componente -->
            <div class="card">
                <div class="card-title" id="detalle-comp-nombre">-</div>
                <div style="margin-top: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em;">
                        <div>
                            <span style="color: var(--text);">Marca:</span>
                            <div style="font-weight: bold;" id="detalle-comp-marca">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Modelo:</span>
                            <div style="font-weight: bold;" id="detalle-comp-modelo">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Material:</span>
                            <div style="font-weight: bold;" id="detalle-comp-material">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Peso:</span>
                            <div style="font-weight: bold;" id="detalle-comp-peso">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Km instalaci√≥n:</span>
                            <div style="font-weight: bold; color: var(--primary);" id="detalle-comp-km">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Km actuales:</span>
                            <div style="font-weight: bold; color: var(--primary);" id="detalle-comp-km-uso">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Fecha inst.:</span>
                            <div style="font-weight: bold;" id="detalle-comp-fecha">-</div>
                        </div>
                        <div>
                            <span style="color: var(--text);">Precio:</span>
                            <div style="font-weight: bold; color: var(--warning);" id="detalle-comp-precio">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones de acci√≥n -->
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-grid-item" style="flex:1;" title="Editar datos del componente" onclick="editarComponenteActual()">
                    <div class="btn-grid-item-icon">‚úèÔ∏è</div>
                </button>
                <button class="btn-grid-item" style="flex:1;" title="Sustituir por otro componente" onclick="sustituirComponenteActual()">
                    <div class="btn-grid-item-icon">üîÑ</div>
                </button>
                <button class="btn-grid-item" style="flex:1;" title="Registrar reparaci√≥n" onclick="repararComponenteActual()">
                    <div class="btn-grid-item-icon">üîß</div>
                </button>
                <button class="btn-grid-item" style="flex:1; color:var(--danger);" title="Eliminar este componente" onclick="eliminarComponenteActual()">
                    <div class="btn-grid-item-icon">üóëÔ∏è</div>
                </button>
            </div>

            <!-- Subpiezas (si las tiene) -->
            <div id="subpiezas-container" style="display: none; margin-top: 20px;">
                <div class="card">
                    <div class="card-title">Subpiezas</div>
                    <div id="lista-subpiezas" style="margin-top: 15px;">
                        <!-- Se genera din√°micamente -->
                    </div>
                </div>
            </div>
        </section>

        <!-- ========================================
             SECCI√ìN: HISTORIAL
        ======================================== -->
        <section id="sec-historial" class="seccion">
            <div class="topbar">
                <button class="btn-back" onclick="volverATaller()">‚Üê</button>
                <div class="topbar-title">Historial</div>
                <div style="width: 40px;"></div>
            </div>

            <div id="lista-historial" class="mt-20">
                <div class="lista-vacia">
                    <div class="lista-vacia-icon">üìã</div>
                    <p>No hay registros de mantenimiento</p>
                </div>
            </div>

            <button class="btn btn-primary mt-20" onclick="abrirModalNuevoMantenimiento()">‚ûï Registrar Mantenimiento</button>
        </section>

    </div>

    <!-- ========================================
         MODAL: A√ëADIR KIL√ìMETROS
    ======================================== -->
    <div id="modal-km" class="modal">
        <div class="modal-contenido">
            <div class="modal-header" style="display:flex; align-items:center; gap:10px;">
                <button onclick="cerrarModal('modal-km')" style="background:none; border:none; font-size:1.4em; cursor:pointer; padding:0; line-height:1;">‚Üê</button>
                <h2 class="modal-title" style="margin:0;">A√±adir Kil√≥metros</h2>
            </div>
            <div class="form-group">
                <label>¬øCu√°ntos km has hecho?</label>
                <input type="number" id="input-km" placeholder="Ej: 50">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarKm()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: NUEVO COMPONENTE
    ======================================== -->
    <div id="modal-componente" class="modal">
        <div class="modal-contenido" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="display:flex; align-items:center; gap:10px;">
                <button onclick="cerrarModal('modal-componente')" style="background:none; border:none; font-size:1.4em; cursor:pointer; padding:0; line-height:1;">‚Üê</button>
                <h2 class="modal-title" id="modal-componente-titulo" style="margin:0;">Nuevo Componente</h2>
            </div>
            
            <!-- Tipo de componente (select que se genera din√°micamente) -->
            <div class="form-group">
                <label>Tipo de componente</label>
                <select id="comp-tipo">
                    <option value="">-- Selecciona --</option>
                </select>
            </div>

            <div class="form-group">
                <label>Marca</label>
                <select id="comp-marca">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Canyon">Canyon</option>
                    <option value="Campagnolo">Campagnolo</option>
                    <option value="Continental">Continental</option>
                    <option value="Basso">Basso</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Fizik">Fizik</option>
                    <option value="Fox">Fox</option>
                    <option value="Garmin">Garmin</option>
                    <option value="Giant">Giant</option>
                    <option value="Kodak">Kodak</option>
                    <option value="Lifefitness">Lifefitness</option>
                    <option value="Look">Look</option>
                    <option value="Maxxis">Maxxis</option>
                    <option value="Magura">Magura</option>
                    <option value="Michelin">Michelin</option>
                    <option value="Pirelli">Pirelli</option>
                    <option value="Pro">Pro</option>
                    <option value="Pr√≥logo">Pr√≥logo</option>
                    <option value="RockShox">RockShox</option>
                    <option value="Schwalbe">Schwalbe</option>
                    <option value="Selle Italia">Selle Italia</option>
                    <option value="Shimano">Shimano</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Sram">Sram</option>
                    <option value="Varta">Varta</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group" id="comp-marca-otra-container" style="display: none;">
                <label>Especifica la marca</label>
                <input type="text" id="comp-marca-otra" placeholder="Nombre de la marca">
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="comp-modelo" placeholder="Ej: Ultegra R8100">
            </div>

            <div class="form-group">
                <label>Material</label>
                <select id="comp-material">
                    <option value="">-- Selecciona --</option>
                    <option value="Acero">Acero</option>
                    <option value="Aluminio">Aluminio</option>
                    <option value="Carbono">Carbono</option>
                    <option value="Caucho">Caucho</option>
                    <option value="Cromo">Cromo</option>
                    <option value="Pl√°stico">Pl√°stico</option>
                    <option value="TPU">TPU</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group" id="comp-material-otro-container" style="display: none;">
                <label>Especifica el material</label>
                <input type="text" id="comp-material-otro" placeholder="Nombre del material">
            </div>

            <div class="form-group">
                <label>Peso (gramos)</label>
                <input type="number" id="comp-peso" placeholder="0" step="1">
            </div>

            <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="comp-precio" placeholder="0" step="0.01">
            </div>

            <div class="form-group">
                <label>Fecha de instalaci√≥n</label>
                <input type="date" id="comp-fecha-instalacion">
            </div>

            <div class="form-group">
                <label>Km en instalaci√≥n</label>
                <input type="number" id="comp-km-instalacion" placeholder="0" step="1">
            </div>

            <!-- Campos extra seg√∫n tipo de componente -->
            <div id="comp-campos-extra">
                <!-- Se generan din√°micamente -->
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarComponente()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: REPARAR COMPONENTE
    ======================================== -->
    <div id="modal-reparar" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-title">Reparar Componente</h2>
                <p style="color: var(--text); font-size: 0.9em; margin-top: 10px;" id="reparar-componente-nombre">-</p>
            </div>
            <div class="form-group">
                <label>Descripci√≥n de la reparaci√≥n</label>
                <textarea id="reparar-descripcion" placeholder="¬øQu√© se ha reparado?"></textarea>
            </div>
            <div class="form-group">
                <label>Lugar</label>
                <select id="reparar-lugar">
                    <option value="Taller">Taller</option>
                    <option value="En casa">En casa</option>
                </select>
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="reparar-fecha">
            </div>
            <div class="form-group">
                <label>Km actuales de la bici</label>
                <input type="number" id="reparar-km" placeholder="0" step="1">
            </div>
            <div class="form-group">
                <label>Coste (‚Ç¨)</label>
                <input type="number" id="reparar-coste" placeholder="0" step="0.01">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarReparacion()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: SUSTITUIR COMPONENTE
    ======================================== -->
    <div id="modal-sustituir" class="modal">
        <div class="modal-contenido" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="display:flex; align-items:center; gap:10px;">
                <button onclick="cerrarModal('modal-sustituir')" style="background:none; border:none; font-size:1.4em; cursor:pointer; padding:0; line-height:1;">‚Üê</button>
                <h2 class="modal-title" style="margin:0;">Sustituir Componente</h2>
            </div>

            <!-- Resumen componente antiguo -->
            <div class="card" style="background: var(--light-gray); margin-bottom: 20px; margin-top:15px;">
                <div style="font-size: 0.85em; color: var(--text); margin-bottom: 5px;">Componente a sustituir:</div>
                <div style="font-weight: bold;" id="sustituir-componente-viejo">-</div>
                <div style="margin-top: 10px; font-size: 0.9em;">
                    <div>Km instalaci√≥n: <strong id="sustituir-km-instalacion">-</strong></div>
                    <div>Km actuales: <strong id="sustituir-km-actual">-</strong></div>
                    <div style="color: var(--primary); font-weight: bold;">Duraci√≥n: <span id="sustituir-duracion-km">-</span> km</div>
                </div>
            </div>

            <!-- Datos del nuevo componente -->
            <p style="font-weight: bold; margin-bottom: 15px;">Datos del nuevo componente:</p>

            <div class="form-group">
                <label>Marca</label>
                <select id="sustituir-marca">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Canyon">Canyon</option>
                    <option value="Campagnolo">Campagnolo</option>
                    <option value="Continental">Continental</option>
                    <option value="Basso">Basso</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Fizik">Fizik</option>
                    <option value="Fox">Fox</option>
                    <option value="Garmin">Garmin</option>
                    <option value="Giant">Giant</option>
                    <option value="Kodak">Kodak</option>
                    <option value="Lifefitness">Lifefitness</option>
                    <option value="Look">Look</option>
                    <option value="Maxxis">Maxxis</option>
                    <option value="Magura">Magura</option>
                    <option value="Michelin">Michelin</option>
                    <option value="Pirelli">Pirelli</option>
                    <option value="Pro">Pro</option>
                    <option value="Pr√≥logo">Pr√≥logo</option>
                    <option value="RockShox">RockShox</option>
                    <option value="Schwalbe">Schwalbe</option>
                    <option value="Selle Italia">Selle Italia</option>
                    <option value="Shimano">Shimano</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Sram">Sram</option>
                    <option value="Varta">Varta</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group" id="sustituir-marca-otra-container" style="display: none;">
                <label>Especifica la marca</label>
                <input type="text" id="sustituir-marca-otra" placeholder="Nombre de la marca">
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="sustituir-modelo" placeholder="Ej: Ultegra R8100">
            </div>

            <div class="form-group">
                <label>Material</label>
                <select id="sustituir-material">
                    <option value="">-- Selecciona --</option>
                    <option value="Acero">Acero</option>
                    <option value="Aluminio">Aluminio</option>
                    <option value="Carbono">Carbono</option>
                    <option value="Caucho">Caucho</option>
                    <option value="Cromo">Cromo</option>
                    <option value="Pl√°stico">Pl√°stico</option>
                    <option value="TPU">TPU</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group" id="sustituir-material-otro-container" style="display: none;">
                <label>Especifica el material</label>
                <input type="text" id="sustituir-material-otro" placeholder="Nombre del material">
            </div>

            <div class="form-group">
                <label>Peso (gramos)</label>
                <input type="number" id="sustituir-peso" placeholder="0" step="1">
            </div>

            <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="sustituir-precio" placeholder="0" step="0.01">
            </div>

            <div class="form-group">
                <label>Fecha de sustituci√≥n</label>
                <input type="date" id="sustituir-fecha">
            </div>

            <div class="form-group">
                <label>Km de la bici en la sustituci√≥n</label>
                <input type="number" id="sustituir-km" placeholder="0" step="1">
            </div>

            <!-- Campos extra seg√∫n tipo -->
            <div id="sustituir-campos-extra"></div>

            <!-- Qu√© hacer con el componente viejo - al tocar confirma -->
            <div style="background: var(--light-gray); border-radius: 12px; padding: 15px; margin-top: 20px; margin-bottom: 15px;">
                <label style="font-weight: 700; margin-bottom: 10px; display:block;">¬øQu√© hacemos con el componente actual?</label>
                <div style="display: flex; gap: 10px;">
                    <button type="button" onclick="guardarSustitucion('historial')" style="flex:1; cursor:pointer; text-align:center; padding: 12px; border-radius: 8px; border: 2px solid var(--primary); background: white;">
                        <div style="font-size: 1.3em;">üóëÔ∏è</div>
                        <div style="font-size: 0.8em; font-weight: 600; margin-top: 4px;">Al historial</div>
                        <div style="font-size: 0.72em; color: var(--text); margin-top: 2px;">Reemplazar</div>
                    </button>
                    <button type="button" onclick="guardarSustitucion('cajon')" style="flex:1; cursor:pointer; text-align:center; padding: 12px; border-radius: 8px; border: 2px solid #ccc; background: white;">
                        <div style="font-size: 1.3em;">üì¶</div>
                        <div style="font-size: 0.8em; font-weight: 600; margin-top: 4px;">Al caj√≥n</div>
                        <div style="font-size: 0.72em; color: var(--text); margin-top: 2px;">Guardar para reutilizar</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: SUBPIEZA (A√ëADIR/EDITAR/SUSTITUIR)
    ======================================== -->
    <div id="modal-subpieza" class="modal">
        <div class="modal-contenido" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="display:flex; align-items:center; gap:10px;">
                <button onclick="cerrarModal('modal-subpieza')" style="background:none; border:none; font-size:1.4em; cursor:pointer; padding:0; line-height:1;">‚Üê</button>
                <div>
                    <h2 class="modal-title" id="modal-subpieza-titulo" style="margin:0;">A√±adir Subpieza</h2>
                    <p style="color: var(--text); font-size: 0.9em; margin-top: 4px;" id="modal-subpieza-subtitulo">-</p>
                </div>
            </div>

            <!-- Datos heredados del padre (solo lectura visual) -->
            <div class="card" style="background: var(--light-gray); margin-bottom: 20px;" id="subpieza-datos-heredados">
                <div style="font-size: 0.85em; color: var(--text); margin-bottom: 5px;">Datos heredados del componente principal:</div>
                <div style="font-size: 0.9em;">
                    <div>Marca: <strong id="subpieza-heredada-marca">-</strong></div>
                    <div>Modelo: <strong id="subpieza-heredada-modelo">-</strong></div>
                    <div>Material: <strong id="subpieza-heredada-material">-</strong></div>
                    <div>Fecha: <strong id="subpieza-heredada-fecha">-</strong></div>
                    <div>Km: <strong id="subpieza-heredada-km">-</strong></div>
                </div>
                <div style="font-size: 0.85em; color: var(--text); margin-top: 10px;">Puedes modificar cualquier campo si es necesario</div>
            </div>

            <div class="form-group">
                <label>Marca</label>
                <select id="subpieza-marca">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Canyon">Canyon</option>
                    <option value="Campagnolo">Campagnolo</option>
                    <option value="Continental">Continental</option>
                    <option value="Basso">Basso</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Fizik">Fizik</option>
                    <option value="Fox">Fox</option>
                    <option value="Garmin">Garmin</option>
                    <option value="Giant">Giant</option>
                    <option value="Kodak">Kodak</option>
                    <option value="Lifefitness">Lifefitness</option>
                    <option value="Look">Look</option>
                    <option value="Maxxis">Maxxis</option>
                    <option value="Magura">Magura</option>
                    <option value="Michelin">Michelin</option>
                    <option value="Pirelli">Pirelli</option>
                    <option value="Pro">Pro</option>
                    <option value="Pr√≥logo">Pr√≥logo</option>
                    <option value="RockShox">RockShox</option>
                    <option value="Schwalbe">Schwalbe</option>
                    <option value="Selle Italia">Selle Italia</option>
                    <option value="Shimano">Shimano</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Sram">Sram</option>
                    <option value="Varta">Varta</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>

            <div class="form-group" id="subpieza-marca-otra-container" style="display: none;">
                <label>Especifica la marca</label>
                <input type="text" id="subpieza-marca-otra" placeholder="Nombre de la marca">
            </div>

            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="subpieza-modelo" placeholder="Ej: Ultegra R8100">
            </div>

            <div class="form-group">
                <label>Material</label>
                <select id="subpieza-material">
                    <option value="">-- Selecciona --</option>
                    <option value="Acero">Acero</option>
                    <option value="Aluminio">Aluminio</option>
                    <option value="Carbono">Carbono</option>
                    <option value="Caucho">Caucho</option>
                    <option value="Cromo">Cromo</option>
                    <option value="Pl√°stico">Pl√°stico</option>
                    <option value="TPU">TPU</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group" id="subpieza-material-otro-container" style="display: none;">
                <label>Especifica el material</label>
                <input type="text" id="subpieza-material-otro" placeholder="Nombre del material">
            </div>

            <div class="form-group">
                <label>Peso (gramos)</label>
                <input type="number" id="subpieza-peso" placeholder="0" step="1">
            </div>

            <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="subpieza-precio" placeholder="0" step="0.01">
            </div>

            <div class="form-group">
                <label>Fecha de instalaci√≥n</label>
                <input type="date" id="subpieza-fecha">
            </div>

            <div class="form-group">
                <label>Km en instalaci√≥n</label>
                <input type="number" id="subpieza-km" placeholder="0" step="1">
            </div>

            <!-- Campos espec√≠ficos seg√∫n tipo de subpieza -->
            <div id="subpieza-campos-especificos"></div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarSubpieza()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: NUEVO MANTENIMIENTO
    ======================================== -->
    <div id="modal-mantenimiento" class="modal">
        <div class="modal-contenido">
            <div class="modal-header" style="display:flex; align-items:center; gap:10px;">
                <button onclick="cerrarModal('modal-mantenimiento')" style="background:none; border:none; font-size:1.4em; cursor:pointer; padding:0; line-height:1;">‚Üê</button>
                <h2 class="modal-title" style="margin:0;">Registrar Mantenimiento</h2>
            </div>
            <div class="form-group">
                <label>Tipo</label>
                <select id="mant-tipo">
                    <option value="Reparaci√≥n">Reparaci√≥n</option>
                    <option value="Sustituci√≥n">Sustituci√≥n</option>
                    <option value="Mejora">Mejora</option>
                </select>
            </div>
            <div class="form-group">
                <label>Componente/Pieza</label>
                <input type="text" id="mant-pieza" placeholder="Ej: Cadena">
            </div>
            <div class="form-group">
                <label>Descripci√≥n</label>
                <textarea id="mant-descripcion" placeholder="¬øQu√© has hecho?"></textarea>
            </div>
            <div class="form-group">
                <label>Coste (‚Ç¨)</label>
                <input type="number" id="mant-coste" placeholder="0">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarMantenimiento()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: RECUPERAR CONTRASE√ëA
    ======================================== -->
    <div id="modal-recuperar-password" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-title">Recuperar contrase√±a</h2>
                <p style="color: var(--text); font-size: 0.9em; margin-top: 10px;">
                    Introduce tu email y te enviaremos un enlace para restablecer tu contrase√±a.
                </p>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="recuperar-email" placeholder="tu@email.com">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="enviarEmailRecuperacion()">Enviar enlace</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: VINCULAR BICI CON STRAVA
    ======================================== -->
    <div id="modal-vincular-strava" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h2 class="modal-title">Vincular con Strava</h2>
                <p style="color: var(--text); font-size: 0.9em; margin-top: 10px;">
                    Selecciona qu√© bici de Strava corresponde a "<span id="vincular-bici-nombre"></span>"
                </p>
            </div>
            <div id="vincular-strava-no-conectado" style="display: none;">
                <p style="color: var(--text); margin-bottom: 15px;">
                    Primero debes conectar tu cuenta de Strava desde el perfil.
                </p>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="cerrarModal('modal-vincular-strava')">Cerrar</button>
                    <button class="btn btn-primary" onclick="cerrarModal('modal-vincular-strava'); navegar('sec-perfil')">Ir al perfil</button>
                </div>
            </div>
            <div id="vincular-strava-conectado" style="display: none;">
                <div class="form-group">
                    <label>Bici de Strava</label>
                    <select id="vincular-strava-select">
                        <option value="">-- No vincular / Desvincular --</option>
                    </select>
                </div>
                <div id="vincular-bici-actual" style="background: var(--light-gray); padding: 12px; border-radius: 10px; margin-bottom: 15px; display: none;">
                    <div style="font-size: 0.85em; color: var(--text); margin-bottom: 5px;">Actualmente vinculada con:</div>
                    <div style="font-weight: bold; color: var(--primary);" id="vincular-bici-actual-nombre">-</div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary" onclick="cerrarModal('modal-vincular-strava')">Cancelar</button>
                    <button class="btn btn-primary" onclick="guardarVinculacionStrava()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: NUEVO/EDITAR JUEGO DE RUEDAS
    ======================================== -->
    <div id="modal-juego-ruedas" class="modal">
        <div class="modal-contenido">
            <div class="modal-header" style="display:flex; align-items:center; gap:10px;">
                <button onclick="cerrarModal('modal-juego-ruedas')" style="background:none; border:none; font-size:1.4em; cursor:pointer; padding:0; line-height:1;">‚Üê</button>
                <h2 class="modal-title" id="juego-ruedas-modal-titulo" style="margin:0;">Nuevo Juego de Ruedas</h2>
            </div>
            <div class="form-group">
                <label>Marca</label>
                <select id="juego-marca-select" onchange="toggleMarcaJuegoOtra()">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Campagnolo">Campagnolo</option>
                    <option value="Corima">Corima</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Enve">Enve</option>
                    <option value="Fulcrum">Fulcrum</option>
                    <option value="Hunt">Hunt</option>
                    <option value="Lightweight">Lightweight</option>
                    <option value="Mavic">Mavic</option>
                    <option value="Miche">Miche</option>
                    <option value="Reynolds">Reynolds</option>
                    <option value="Roval">Roval</option>
                    <option value="Vision">Vision</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
                <input type="text" id="juego-marca" placeholder="Nombre de la marca" style="margin-top:8px; display:none;">
            </div>
            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="juego-modelo" placeholder="Ej: 404 Firecrest, Ksyrium...">
            </div>
            <div class="form-group">
                <label>Fecha de instalaci√≥n</label>
                <input type="date" id="juego-fecha">
            </div>
            <div class="form-group">
                <label>KM en instalaci√≥n</label>
                <input type="number" id="juego-km" placeholder="0" value="0">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarJuegoRuedas()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: RUEDA (A√ëADIR / EDITAR)
    ======================================== -->
    <div id="modal-rueda" class="modal">
        <div class="modal-contenido" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="display:flex; align-items:center; gap:10px;">
                <button onclick="cerrarModal('modal-rueda')" style="background:none; border:none; font-size:1.4em; cursor:pointer; padding:0; line-height:1;">‚Üê</button>
                <h2 class="modal-title" id="modal-rueda-titulo" style="margin:0;">A√±adir Rueda</h2>
            </div>
            <div class="form-group">
                <label>Marca</label>
                <select id="rueda-marca-select" onchange="toggleMarcaRuedaModal()">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Campagnolo">Campagnolo</option>
                    <option value="Corima">Corima</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Enve">Enve</option>
                    <option value="Fulcrum">Fulcrum</option>
                    <option value="Hunt">Hunt</option>
                    <option value="Lightweight">Lightweight</option>
                    <option value="Mavic">Mavic</option>
                    <option value="Miche">Miche</option>
                    <option value="Reynolds">Reynolds</option>
                    <option value="Roval">Roval</option>
                    <option value="Vision">Vision</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
                <input type="text" id="rueda-marca-input" placeholder="Nombre de la marca" style="margin-top:8px; display:none;">
            </div>
            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="rueda-modelo" placeholder="Ej: 404 Firecrest">
            </div>
            <div class="form-group">
                <label>Material</label>
                <select id="rueda-material">
                    <option value="">-- Selecciona --</option>
                    <option value="Aluminio">Aluminio</option>
                    <option value="Carbono">Carbono</option>
                    <option value="Carbono/Aluminio">Carbono/Aluminio</option>
                    <option value="Acero">Acero</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label>Peso (gramos)</label>
                <input type="number" id="rueda-peso" placeholder="0" step="1">
            </div>
            <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="rueda-precio" placeholder="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Fecha de instalaci√≥n</label>
                <input type="date" id="rueda-fecha">
            </div>
            <div class="form-group">
                <label>KM en instalaci√≥n</label>
                <input type="number" id="rueda-km" placeholder="0" step="1">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarRueda()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: PIEZA DE RUEDA (DESPIECE)
    ======================================== -->
    <div id="modal-pieza-rueda" class="modal">
        <div class="modal-contenido" style="max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="display:flex; align-items:center; gap:10px;">
                <button onclick="cerrarModal('modal-pieza-rueda')" style="background:none; border:none; font-size:1.4em; cursor:pointer; padding:0; line-height:1;">‚Üê</button>
                <h2 class="modal-title" id="modal-pieza-rueda-titulo" style="margin:0;">A√±adir pieza</h2>
            </div>
            <div class="form-group">
                <label>Tipo de pieza</label>
                <select id="pieza-rueda-tipo"></select>
            </div>
            <div class="form-group">
                <label>Marca</label>
                <select id="pieza-rueda-marca-select">
                    <option value="">-- Selecciona --</option>
                    <option value="Bontrager">Bontrager</option>
                    <option value="Continental">Continental</option>
                    <option value="DT Swiss">DT Swiss</option>
                    <option value="Maxxis">Maxxis</option>
                    <option value="Mavic">Mavic</option>
                    <option value="Michelin">Michelin</option>
                    <option value="Pirelli">Pirelli</option>
                    <option value="Schwalbe">Schwalbe</option>
                    <option value="Shimano">Shimano</option>
                    <option value="Specialized">Specialized</option>
                    <option value="Zipp">Zipp</option>
                    <option value="Otra">Otra</option>
                </select>
            </div>
            <div class="form-group">
                <label>Modelo</label>
                <input type="text" id="pieza-rueda-modelo" placeholder="Ej: GP5000, 404...">
            </div>
            <div class="form-group">
                <label>Material</label>
                <select id="pieza-rueda-material">
                    <option value="">-- Selecciona --</option>
                    <option value="Aluminio">Aluminio</option>
                    <option value="Carbono">Carbono</option>
                    <option value="Caucho">Caucho</option>
                    <option value="Acero">Acero</option>
                    <option value="Titanio">Titanio</option>
                    <option value="Lat√≥n">Lat√≥n</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group" id="pieza-rueda-peso-group" style="display:none;">
                <label>Peso (gramos)</label>
                <input type="number" id="pieza-rueda-peso" placeholder="0" step="1">
            </div>
            <div class="form-group" id="pieza-rueda-numradios-group" style="display:none;">
                <label>N¬∫ de Radios</label>
                <input type="number" id="pieza-rueda-numradios" placeholder="Ej: 24" step="1" min="1">
            </div>
            <div class="form-group">
                <label>Precio (‚Ç¨)</label>
                <input type="number" id="pieza-rueda-precio" placeholder="0" step="0.01">
            </div>
            <div class="form-group">
                <label>Fecha de instalaci√≥n</label>
                <input type="date" id="pieza-rueda-fecha">
            </div>
            <div class="form-group">
                <label>KM en instalaci√≥n</label>
                <input type="number" id="pieza-rueda-km" placeholder="0" step="1">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarPiezaRueda()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MODAL: CONFIRMACI√ìN PERSONALIZADO
    ======================================== -->
    <div id="modal-confirmar" class="modal-confirmar">
        <div class="modal-confirmar-contenido">
            <div class="modal-confirmar-titulo" id="confirmar-titulo">¬øEst√°s seguro?</div>
            <div id="confirmar-mensaje"></div>
            <div class="modal-confirmar-botones">
                <button class="btn btn-secondary" onclick="cerrarConfirmacion()">Cancelar</button>
                <button class="btn btn-danger" id="btn-confirmar-accion">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         JAVASCRIPT - L√ìGICA DE LA APP
    ======================================== -->
    <script>
        // ========================================
        // CONFIGURACI√ìN DE FIREBASE
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDoF3qgC8a_OGyLMA4bEVgjxo8flL6TTWU",
            authDomain: "mybikegestor.firebaseapp.com",
            projectId: "mybikegestor",
            storageBucket: "mybikegestor.firebasestorage.app",
            messagingSenderId: "553350408189",
            appId: "1:553350408189:web:e16d29ca1cded704849b94"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ========================================
        // CONFIGURACI√ìN DE STRAVA
        // ========================================
        const STRAVA_CLIENT_ID = '201273';
        const STRAVA_CLIENT_SECRET = '778fd4bdc03d2ffbb57bb52f83c5ae6b4f73a776';
        const STRAVA_REDIRECT_URI = window.location.hostname === 'localhost' 
            ? 'http://localhost:5500' 
            : 'https://alfersam-byte.github.io/MyBikeGestor/';
        const STRAVA_AUTH_URL = 'https://www.strava.com/oauth/authorize';
        const STRAVA_TOKEN_URL = 'https://www.strava.com/oauth/token';
        const STRAVA_API_URL = 'https://www.strava.com/api/v3';

        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let usuarioActual = null;
        let datosUsuario = null; // Datos del usuario desde Firestore
        let biciActual = null;
        let callbackConfirmacion = null;

        // ========================================
        // FUNCIONES FOTO DE PERFIL
        // ========================================

        function togglePhotoOptions() {
            document.getElementById('photo-options').classList.toggle('active');
        }
        document.addEventListener('click', (e) => {
            const c = document.getElementById('profile-photo-container');
            if (c && !c.contains(e.target)) document.getElementById('photo-options').classList.remove('active');
        });
        function selectPhotoSource(source) {
            const input = document.getElementById('photo-input');
            source === 'camera' ? input.setAttribute('capture','environment') : input.removeAttribute('capture');
            input.click();
            document.getElementById('photo-options').classList.remove('active');
        }
        async function handlePhotoSelected(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 5*1024*1024) { mostrarNotificacion('Imagen demasiado grande. M√°x 5MB.','error'); return; }
            try {
                mostrarNotificacion('Subiendo foto...','exito');
                const compressed = await compressImage(file);
                const ref = storage.ref().child(`profile-photos/${usuarioActual.uid}`);
                await ref.put(compressed);
                const url = await ref.getDownloadURL();
                await db.collection('usuarios').doc(usuarioActual.uid).update({ photoURL: url });
                mostrarFotoPerfil(url);
                mostrarNotificacion('Foto actualizada correctamente','exito');
            } catch(e) { console.error(e); mostrarNotificacion('Error al subir la foto','error'); }
            event.target.value = '';
        }
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height, max = 800;
                        if (w > h && w > max) { h = h*max/w; w = max; }
                        else if (h > max) { w = w*max/h; h = max; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img,0,0,w,h);
                        canvas.toBlob(blob => resolve(new File([blob],file.name,{type:'image/jpeg'})),'image/jpeg',0.8);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        function mostrarFotoPerfil(url) {
            const img = document.getElementById('dashboard-photo-img');
            const ini = document.getElementById('dashboard-initials');
            if (!img || !ini) return;
            if (url) { img.src = url; img.style.display = 'block'; ini.style.display = 'none'; }
            else { img.style.display = 'none'; ini.style.display = 'block'; }
        }
        function mostrarIniciales(nombre) {
            if (!nombre) return 'üë§';
            const p = nombre.trim().split(' ');
            return p.length >= 2 ? (p[0][0]+p[p.length-1][0]).toUpperCase() : nombre.substring(0,2).toUpperCase();
        }
        async function removeProfilePhoto() {
            if (!confirm('¬øEliminar foto de perfil?')) return;
            document.getElementById('photo-options').classList.remove('active');
            try {
                await storage.ref().child(`profile-photos/${usuarioActual.uid}`).delete().catch(()=>{});
                await db.collection('usuarios').doc(usuarioActual.uid).update({ photoURL: firebase.firestore.FieldValue.delete() });
                mostrarFotoPerfil(null);
                mostrarNotificacion('Foto eliminada','exito');
            } catch(e) { mostrarNotificacion('Error al eliminar','error'); }
        }

        // Sincronizar KM de la bici actual desde Strava
        async function sincronizarBiciStrava() {
            if (!biciActual || !biciActual.stravaBiciId) {
                mostrarNotificacion('Esta bici no est√° vinculada con Strava','error'); return;
            }
            if (!await renovarTokenStrava()) {
                mostrarNotificacion('Token de Strava expirado. Reconecta tu cuenta.','error'); return;
            }
            mostrarNotificacion('Sincronizando KM con Strava...','info');
            try {
                const response = await fetch(`${STRAVA_API_URL}/gear/${biciActual.stravaBiciId}`, {
                    headers: { 'Authorization': `Bearer ${datosUsuario.stravaAccessToken}` }
                });
                if (!response.ok) throw new Error('Error obteniendo datos de la bici en Strava');
                const gearData = await response.json();
                const kmStrava = Math.round(gearData.distance / 1000);
                const biciIndex = datosUsuario.garaje.findIndex(b => b.id === biciActual.id);
                if (biciIndex !== -1) {
                    const kmAnteriores = datosUsuario.garaje[biciIndex].kmTotales || 0;
                    datosUsuario.garaje[biciIndex].kmTotales = kmStrava;
                    datosUsuario.garaje[biciIndex].ultimaSincronizacion = new Date().toISOString();
                    biciActual = datosUsuario.garaje[biciIndex];
                    await guardarDatosUsuario();
                    cargarTaller();
                    mostrarNotificacion(`‚úÖ KM actualizados: ${kmStrava.toLocaleString()} km (antes: ${kmAnteriores.toLocaleString()} km)`, 'exito');
                }
            } catch (error) {
                console.error('Error sincronizando con Strava:', error);
                mostrarNotificacion('Error al sincronizar con Strava', 'error');
            }
        }

        // ========================================
        // PANEL DE ADMINISTRACI√ìN
        // NOTA FIRESTORE PERMISOS: Para que el admin pueda leer todos los usuarios,
        // actualiza las reglas en Firebase Console > Firestore > Reglas:
        //
        // rules_version = '2';
        // service cloud.firestore {
        //   match /databases/{database}/documents {
        //     match /usuarios/{userId} {
        //       allow read, write: if request.auth != null && request.auth.uid == userId;
        //       allow read: if request.auth != null && request.auth.token.email == 'alfersam@gmail.com';
        //     }
        //   }
        // }
        // ========================================
        async function cargarAdmin() {
            if (!usuarioActual || usuarioActual.email !== 'alfersam@gmail.com') {
                navegar('sec-dashboard');
                return;
            }

            const container = document.getElementById('admin-lista-usuarios');
            container.innerHTML = '<div class="text-center text-muted">Cargando...</div>';

            try {
                const snapshot = await db.collection('usuarios').get();
                const usuarios = [];
                
                snapshot.forEach(doc => {
                    usuarios.push({ id: doc.id, ...doc.data() });
                });

                // Estad√≠sticas globales
                const totalBicis = usuarios.reduce((t, u) => t + (u.garaje ? u.garaje.filter(b => b.activa !== false).length : 0), 0);
                const conStrava = usuarios.filter(u => u.stravaAccessToken).length;

                document.getElementById('admin-total-usuarios').textContent = usuarios.length;
                document.getElementById('admin-total-bicis').textContent = totalBicis;
                document.getElementById('admin-con-strava').textContent = conStrava;

                // Lista de usuarios ordenados por fecha de registro
                usuarios.sort((a, b) => {
                    const fa = a.fechaRegistro || a.fechaCreacion || '';
                    const fb = b.fechaRegistro || b.fechaCreacion || '';
                    return fb.localeCompare(fa);
                });

                if (usuarios.length === 0) {
                    container.innerHTML = '<div class="lista-vacia"><div class="lista-vacia-icon">üë•</div><p>No hay usuarios registrados</p></div>';
                    return;
                }

                container.innerHTML = '';
                usuarios.forEach(u => {
                    const nombre = u.nombre && u.apellidos
                        ? `${u.nombre} ${u.apellidos}`
                        : u.nombre || u.email || 'Sin nombre';
                    
                    const fechaReg = u.fechaRegistro || u.fechaCreacion
                        ? new Date(u.fechaRegistro || u.fechaCreacion).toLocaleDateString('es-ES')
                        : 'Desconocida';
                    
                    const ultimaConexion = u.ultimaConexion
                        ? new Date(u.ultimaConexion).toLocaleDateString('es-ES')
                        : 'Sin datos';

                    const bicisActivas = u.garaje ? u.garaje.filter(b => b.activa !== false).length : 0;
                    const bicisRetiradas = u.garaje ? u.garaje.filter(b => b.activa === false).length : 0;
                    const stravaStatus = u.stravaAccessToken ? 'üü¢ Strava' : '‚ö™ Sin Strava';
                    const esAdmin = u.email === 'alfersam@gmail.com' ? ' üëë' : '';

                    // Calcular d√≠as desde registro
                    let diasRegistro = '';
                    const fechaReg2 = u.fechaRegistro || u.fechaCreacion;
                    if (fechaReg2) {
                        const dias = Math.floor((new Date() - new Date(fechaReg2)) / 86400000);
                        diasRegistro = ` (${formatearDuracion(dias)})`;
                    }

                    const card = document.createElement('div');
                    card.className = 'admin-user-card';
                    card.innerHTML = `
                        <div class="admin-user-name">${nombre}${esAdmin}</div>
                        <div class="admin-user-email">${u.email || 'Sin email'}</div>
                        <div class="admin-user-meta">
                            <span>üìÖ Registro: ${fechaReg}${diasRegistro}</span>
                            <span>üïê √öltima: ${ultimaConexion}</span>
                        </div>
                        <div class="admin-user-meta" style="margin-top: 5px;">
                            <span>üö¥ ${bicisActivas} activa${bicisActivas !== 1 ? 's' : ''}</span>
                            <span>üì¶ ${bicisRetiradas} retirada${bicisRetiradas !== 1 ? 's' : ''}</span>
                            <span>${stravaStatus}</span>
                        </div>
                    `;
                    container.appendChild(card);
                });

            } catch (error) {
                console.error('Error cargando admin:', error);
                container.innerHTML = '<div class="text-center text-muted">Error al cargar usuarios</div>';
            }
        }

        // ========================================
        // FUNCIONES AUXILIARES
        // ========================================
        
        // Formatear fecha de YYYY-MM-DD a DD/MM/YYYY
        function formatearFecha(fechaISO) {
            if (!fechaISO) return '-';
            const partes = fechaISO.split('T')[0].split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        
        // Formatear duraci√≥n de d√≠as a formato aa/mm/dd
        function formatearDuracion(dias) {
            if (!dias || dias < 0) return '0d';
            
            const a√±os = Math.floor(dias / 365);
            const meses = Math.floor((dias % 365) / 30);
            const diasRestantes = Math.floor(dias % 30);
            
            const partes = [];
            if (a√±os > 0) partes.push(`${a√±os}a`);
            if (meses > 0) partes.push(`${meses}m`);
            if (diasRestantes > 0 || partes.length === 0) partes.push(`${diasRestantes}d`);
            
            return partes.join(' ');
        }

        // ========================================
        // FUNCIONES DE FIREBASE AUTH Y FIRESTORE
        // ========================================
        
        // Cargar datos del usuario actual desde Firestore
        async function cargarDatosUsuario(uid) {
            try {
                const doc = await db.collection('usuarios').doc(uid).get();
                if (doc.exists) {
                    datosUsuario = { id: doc.id, ...doc.data() };
                    // Guardar √∫ltima conexi√≥n
            db.collection('usuarios').doc(usuarioActual.uid).update({
                ultimaConexion: new Date().toISOString()
            }).catch(() => {});
            console.log('Datos del usuario cargados');
                } else {
                    // Si no existe, crear documento inicial
                    datosUsuario = {
                        id: uid,
                        email: auth.currentUser.email,
                        garaje: [],
                        fechaRegistro: new Date().toISOString()
                    };
                    await db.collection('usuarios').doc(uid).set(datosUsuario);
                    console.log('Documento de usuario creado');
                }
            } catch (error) {
                console.error('Error cargando datos del usuario:', error);
                mostrarNotificacion('Error al cargar datos', 'error');
            }
        }

        // Guardar datos del usuario en Firestore
        async function guardarDatosUsuario() {
            if (!datosUsuario || !datosUsuario.id) {
                console.error('No hay datos de usuario o falta el ID');
                mostrarNotificacion('Error: No se puede guardar sin ID de usuario', 'error');
                return;
            }
            
            try {
                await db.collection('usuarios').doc(datosUsuario.id).set(datosUsuario);
                console.log('Datos guardados en Firestore con ID:', datosUsuario.id);
            } catch (error) {
                console.error('Error guardando datos:', error);
                mostrarNotificacion('Error al guardar datos. Intenta de nuevo.', 'error');
            }
        }

        // ========================================
        // SISTEMA DE NOTIFICACIONES
        // ========================================
        function mostrarNotificacion(mensaje, tipo = 'exito') {
            // Eliminar notificaci√≥n anterior si existe
            const notifAnterior = document.querySelector('.notificacion');
            if (notifAnterior) notifAnterior.remove();

            const iconos = {
                'exito': '‚úì',
                'error': '‚úó',
                'info': '‚Ñπ'
            };

            const notif = document.createElement('div');
            notif.className = `notificacion notificacion-${tipo}`;
            notif.innerHTML = `
                <div class="notificacion-icono">${iconos[tipo]}</div>
                <div class="notificacion-texto">${mensaje}</div>
            `;

            document.body.appendChild(notif);

            // Auto-eliminar despu√©s de 3 segundos
            setTimeout(() => {
                notif.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function confirmar(titulo, mensaje, callback) {
            document.getElementById('confirmar-titulo').textContent = titulo;
            document.getElementById('confirmar-mensaje').textContent = mensaje;
            document.getElementById('modal-confirmar').classList.add('activo');
            
            // Guardar el callback para ejecutarlo si confirma
            callbackConfirmacion = callback;
            
            // Asignar el evento al bot√≥n
            document.getElementById('btn-confirmar-accion').onclick = () => {
                if (callbackConfirmacion) callbackConfirmacion();
                cerrarConfirmacion();
            };
        }

        function cerrarConfirmacion() {
            document.getElementById('modal-confirmar').classList.remove('activo');
            callbackConfirmacion = null;
        }

        // ========================================
        // SISTEMA DE NAVEGACI√ìN
        // ========================================
        function navegar(seccionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(sec => {
                sec.classList.remove('activa');
            });

            // Mostrar la secci√≥n seleccionada
            document.getElementById(seccionId).classList.add('activa');

            // Cargar datos seg√∫n la secci√≥n
            if (seccionId === 'sec-dashboard') {
                cargarDashboard();
            } else if (seccionId === 'sec-garaje') {
                cargarGaraje();
            } else if (seccionId === 'sec-taller') {
                cargarTaller();
            } else if (seccionId === 'sec-componentes') {
                cargarSeccionesComponentes();
                actualizarBotonCajon();
            } else if (seccionId === 'sec-cajon-piezas') {
                cargarCajonPiezas();
            } else if (seccionId === 'sec-historial') {
                cargarHistorial();
            } else if (seccionId === 'sec-bicis-retiradas') {
                cargarBicisRetiradas();
            } else if (seccionId === 'sec-garaje-ruedas') {
                cargarGarajeRuedas();
            } else if (seccionId === 'sec-desglose-peso') {
                cargarDesglosePeso();
            } else if (seccionId === 'sec-desglose-inversion') {
                cargarDesgloseInversion();
            } else if (seccionId === 'sec-detalle-juego-ruedas') {
                cargarDetalleJuegoRuedas();
            } else if (seccionId === 'sec-despiece-rueda') {
                cargarDespieceRueda();
            } else if (seccionId === 'sec-ruedas-retiradas') {
                cargarRuedasRetiradas();
            } else if (seccionId === 'sec-admin') {
                cargarAdmin();
            } else if (seccionId === 'sec-perfil') {
                cargarPerfil();
            }
        }

        // ========================================
        // DASHBOARD
        // ========================================
        function cargarDashboard() {
            if (!usuarioActual || !datosUsuario) return;

            // Datos del usuario - mostrar nombre completo si existe
            const nombreCompleto = datosUsuario.nombre && datosUsuario.apellidos 
                ? `${datosUsuario.nombre} ${datosUsuario.apellidos}` 
                : datosUsuario.email;
            
            document.getElementById('dashboard-usuario').textContent = nombreCompleto;
            document.getElementById('dashboard-email').textContent = datosUsuario.email || 'Sin email';

            // Mostrar bot√≥n admin solo para alfersam@gmail.com
            const btnAdmin = document.getElementById('btn-admin-dashboard');
            if (btnAdmin) {
                btnAdmin.style.display = usuarioActual.email === 'alfersam@gmail.com' ? 'flex' : 'none';
            }

            // Cargar foto de perfil
            if (datosUsuario.photoURL) {
                mostrarFotoPerfil(datosUsuario.photoURL);
            } else {
                const ini = document.getElementById('dashboard-initials');
                if (ini) ini.textContent = mostrarIniciales(datosUsuario.nombre || usuarioActual.email);
            }

            // Resumen de bicis
            const bicisActivas = datosUsuario.garaje.filter(b => b.activa !== false);
            const kmTotales = bicisActivas.reduce((total, bici) => total + (bici.kmTotales || 0), 0);

            document.getElementById('dashboard-bicis-activas').textContent = bicisActivas.length;
            document.getElementById('dashboard-km-totales').textContent = kmTotales.toLocaleString();
        }

        // ========================================
        // PERFIL DE USUARIO
        // ========================================
        function cargarPerfil() {
            if (!usuarioActual || !datosUsuario) return;

            // Datos b√°sicos
            document.getElementById('perfil-usuario').value = datosUsuario.email;
            document.getElementById('perfil-nombre').value = datosUsuario.nombre || '';
            document.getElementById('perfil-apellidos').value = datosUsuario.apellidos || '';
            document.getElementById('perfil-fecha-nacimiento').value = datosUsuario.fechaNacimiento || '';
            document.getElementById('perfil-password').value = '';

            // Datos f√≠sicos
            document.getElementById('perfil-peso').value = datosUsuario.peso || '';
            document.getElementById('perfil-altura').value = datosUsuario.altura || '';
            document.getElementById('perfil-ftp').value = datosUsuario.ftp || '';
            document.getElementById('perfil-fc-max').value = datosUsuario.fcMax || '';
            document.getElementById('perfil-vo2max').value = datosUsuario.vo2max || '';

            // Calcular edad e IMC si hay datos
            calcularEdad();
            calcularIMC();

            // A√±adir listeners para c√°lculos autom√°ticos
            document.getElementById('perfil-fecha-nacimiento').addEventListener('change', calcularEdad);
            document.getElementById('perfil-peso').addEventListener('input', calcularIMC);
            document.getElementById('perfil-altura').addEventListener('input', calcularIMC);

            // Actualizar nombre completo en el header
            actualizarNombreCompleto();
            
            // Actualizar estado de Strava
            actualizarEstadoStrava();
        }

        function actualizarNombreCompleto() {
            const nombre = document.getElementById('perfil-nombre').value.trim();
            const apellidos = document.getElementById('perfil-apellidos').value.trim();
            const nombreCompleto = nombre && apellidos ? `${nombre} ${apellidos}` : datosUsuario.email;
            document.getElementById('perfil-nombre-completo').textContent = nombreCompleto;
        }

        function calcularEdad() {
            const fechaNacimiento = document.getElementById('perfil-fecha-nacimiento').value;
            const displayEdad = document.getElementById('perfil-edad-display');
            
            if (!fechaNacimiento) {
                displayEdad.style.display = 'none';
                return;
            }

            const hoy = new Date();
            const nacimiento = new Date(fechaNacimiento);
            let edad = hoy.getFullYear() - nacimiento.getFullYear();
            const mes = hoy.getMonth() - nacimiento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                edad--;
            }

            document.getElementById('perfil-edad-valor').textContent = `${edad} a√±os`;
            displayEdad.style.display = 'block';
        }

        function calcularIMC() {
            const peso = parseFloat(document.getElementById('perfil-peso').value);
            const altura = parseFloat(document.getElementById('perfil-altura').value);
            const displayIMC = document.getElementById('perfil-imc-display');
            
            if (!peso || !altura || altura === 0) {
                displayIMC.style.display = 'none';
                return;
            }

            const alturaMetros = altura / 100;
            const imc = peso / (alturaMetros * alturaMetros);
            
            // Determinar categor√≠a y color
            let categoria = '';
            let color = '';
            
            if (imc < 18.5) {
                categoria = 'Bajo peso';
                color = '#3498db';
            } else if (imc >= 18.5 && imc < 25) {
                categoria = 'Peso normal';
                color = '#2ecc71';
            } else if (imc >= 25 && imc < 30) {
                categoria = 'Sobrepeso';
                color = '#f39c12';
            } else {
                categoria = 'Obesidad';
                color = '#e74c3c';
            }

            document.getElementById('perfil-imc-valor').textContent = imc.toFixed(1);
            document.getElementById('perfil-imc-valor').style.color = color;
            document.getElementById('perfil-imc-categoria').textContent = categoria;
            document.getElementById('perfil-imc-categoria').style.color = color;
            displayIMC.style.display = 'block';
        }

        async function guardarPerfil() {
            // Datos personales
            const nombre = document.getElementById('perfil-nombre').value.trim();
            const apellidos = document.getElementById('perfil-apellidos').value.trim();
            const fechaNacimiento = document.getElementById('perfil-fecha-nacimiento').value;
            const nuevaPassword = document.getElementById('perfil-password').value;

            // Datos f√≠sicos
            const peso = parseFloat(document.getElementById('perfil-peso').value) || null;
            const altura = parseFloat(document.getElementById('perfil-altura').value) || null;
            const ftp = parseFloat(document.getElementById('perfil-ftp').value) || null;
            const fcMax = parseFloat(document.getElementById('perfil-fc-max').value) || null;
            const vo2max = parseFloat(document.getElementById('perfil-vo2max').value) || null;

            // Actualizar datos personales (excepto email que est√° en Auth)
            datosUsuario.nombre = nombre;
            datosUsuario.apellidos = apellidos;
            datosUsuario.fechaNacimiento = fechaNacimiento;

            // Actualizar datos f√≠sicos
            datosUsuario.peso = peso;
            datosUsuario.altura = altura;
            datosUsuario.ftp = ftp;
            datosUsuario.fcMax = fcMax;
            datosUsuario.vo2max = vo2max;

            // Actualizar contrase√±a en Firebase Auth si se ingres√≥ una nueva
            if (nuevaPassword) {
                if (nuevaPassword.length < 6) {
                    mostrarNotificacion('La contrase√±a debe tener al menos 6 caracteres', 'error');
                    return;
                }
                
                try {
                    await usuarioActual.updatePassword(nuevaPassword);
                    await guardarDatosUsuario();
                    mostrarNotificacion('Perfil y contrase√±a actualizados', 'exito');
                } catch (error) {
                    console.error('Error actualizando contrase√±a:', error);
                    if (error.code === 'auth/requires-recent-login') {
                        mostrarNotificacion('Debes volver a iniciar sesi√≥n para cambiar la contrase√±a', 'error');
                    } else {
                        mostrarNotificacion('Error al actualizar contrase√±a: ' + error.message, 'error');
                    }
                    return;
                }
            } else {
                await guardarDatosUsuario();
                mostrarNotificacion('Perfil actualizado correctamente', 'exito');
            }

            setTimeout(() => navegar('sec-dashboard'), 1500);
        }

        // ========================================
        // SISTEMA DE LOGIN Y REGISTRO
        // ========================================
        async function iniciarSesion() {
            const email = document.getElementById('login-usuario').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                mostrarNotificacion('Por favor, completa todos los campos', 'error');
                return;
            }

            try {
                // Iniciar sesi√≥n con Firebase Auth
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                usuarioActual = userCredential.user;
                
                // Cargar datos del usuario desde Firestore
                await cargarDatosUsuario(usuarioActual.uid);
                
                mostrarNotificacion('¬°Bienvenido!', 'exito');
                navegar('sec-dashboard');
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    mostrarNotificacion('Email o contrase√±a incorrectos', 'error');
                } else {
                    mostrarNotificacion('Error al iniciar sesi√≥n: ' + error.message, 'error');
                }
            }
        }

        async function registrarUsuario() {
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            const aceptaTerminos = document.getElementById('reg-terminos').checked;

            if (!email || !password) {
                mostrarNotificacion('Email y contrase√±a son obligatorios', 'error');
                return;
            }

            if (!aceptaTerminos) {
                mostrarNotificacion('Debes aceptar los t√©rminos y la pol√≠tica de privacidad', 'error');
                return;
            }

            if (password.length < 6) {
                mostrarNotificacion('La contrase√±a debe tener al menos 6 caracteres', 'error');
                return;
            }

            try {
                // Crear usuario con Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Crear documento inicial en Firestore
                datosUsuario = {
                    id: user.uid,
                    email: email,
                    garaje: [],
                    fechaRegistro: new Date().toISOString(),
                    aceptoTerminos: true,
                    fechaAceptacionTerminos: new Date().toISOString()
                };
                
                await db.collection('usuarios').doc(user.uid).set(datosUsuario);
                
                mostrarNotificacion('¬°Cuenta creada! Ya puedes iniciar sesi√≥n', 'exito');
                
                // Cerrar sesi√≥n autom√°ticamente para que haga login
                await auth.signOut();
                setTimeout(() => navegar('sec-login'), 1500);
            } catch (error) {
                console.error('Error al registrar:', error);
                if (error.code === 'auth/email-already-in-use') {
                    mostrarNotificacion('Ese email ya est√° registrado', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    mostrarNotificacion('Email inv√°lido', 'error');
                } else if (error.code === 'auth/weak-password') {
                    mostrarNotificacion('La contrase√±a es muy d√©bil', 'error');
                } else {
                    mostrarNotificacion('Error al registrar: ' + error.message, 'error');
                }
            }
        }

        async function cerrarSesion() {
            confirmar(
                '¬øCerrar sesi√≥n?',
                '¬øSeguro que quieres salir?',
                async () => {
                    try {
                        await auth.signOut();
                        usuarioActual = null;
                        datosUsuario = null;
                        biciActual = null;
                        mostrarNotificacion('Sesi√≥n cerrada', 'info');
                        navegar('sec-login');
                    } catch (error) {
                        console.error('Error al cerrar sesi√≥n:', error);
                        mostrarNotificacion('Error al cerrar sesi√≥n', 'error');
                    }
                }
            );
        }

        // ========================================
        // RECUPERAR CONTRASE√ëA
        // ========================================
        function abrirModalRecuperarPassword() {
            // Pre-rellenar con el email del campo de login si existe
            const emailLogin = document.getElementById('login-usuario').value.trim();
            document.getElementById('recuperar-email').value = emailLogin;
            abrirModal('modal-recuperar-password');
        }

        async function enviarEmailRecuperacion() {
            const email = document.getElementById('recuperar-email').value.trim();

            if (!email) {
                mostrarNotificacion('Por favor, introduce tu email', 'error');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                cerrarModal('modal-recuperar-password');
                mostrarNotificacion('Email enviado. Revisa tu bandeja de entrada', 'exito');
            } catch (error) {
                console.error('Error al enviar email:', error);
                if (error.code === 'auth/user-not-found') {
                    mostrarNotificacion('No existe ninguna cuenta con ese email', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    mostrarNotificacion('Email inv√°lido', 'error');
                } else {
                    mostrarNotificacion('Error al enviar email: ' + error.message, 'error');
                }
            }
        }

        // ========================================
        // GESTI√ìN DE BICICLETAS
        // ========================================
        function cargarGaraje() {
            const container = document.getElementById('lista-bicis');
            
            // Filtrar solo bicis activas
            const bicisActivas = datosUsuario.garaje.filter(b => b.activa !== false);
            const bicisRetiradas = datosUsuario.garaje.filter(b => b.activa === false);
            
            // Mostrar/ocultar bot√≥n de bicis retiradas
            const btnRetiradas = document.getElementById('btn-ver-retiradas');
            if (bicisRetiradas.length > 0) {
                btnRetiradas.style.display = 'block';
                btnRetiradas.innerHTML = `üì¶ Ver Bicis Retiradas (${bicisRetiradas.length})`;
            } else {
                btnRetiradas.style.display = 'none';
            }
            
            if (!bicisActivas || bicisActivas.length === 0) {
                container.innerHTML = `
                    <div class="lista-vacia">
                        <div class="lista-vacia-icon">üö¥</div>
                        <p>No tienes ninguna bici en el garaje</p>
                        <p class="text-muted">¬°A√±ade tu primera bicicleta!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            bicisActivas.forEach(bici => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${bici.alias}</div>
                            <div class="card-subtitle">${bici.marca} ${bici.modelo}</div>
                        </div>
                        <span class="badge badge-primary">${bici.disciplina}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; align-items: center;">
                        <div class="text-muted">
                            <strong style="color: var(--primary); font-size: 1.2em;">${bici.kmTotales || 0} km</strong>
                        </div>
                        <button class="btn btn-secondary" style="width: auto; padding: 10px 20px;" onclick="abrirTaller('${bici.id}')">
                            Abrir
                        </button>
                    </div>

                `;
                container.appendChild(card);
            });
        }

        function retirarBici(biciId) {
            const bici = datosUsuario.garaje.find(b => b.id === biciId);
            if (!bici) return;

            confirmar(
                '¬øRetirar bici?',
                `"${bici.alias}" se guardar√° en Bicis Retiradas. Podr√°s reactivarla cuando quieras.`,
                async () => {
                    bici.activa = false;
                    bici.fechaRetiro = new Date().toISOString();
                    await guardarDatosUsuario();
                    mostrarNotificacion(`"${bici.alias}" retirada del garaje`, 'info');
                    navegar('sec-garaje');
                }
            );
        }

        function eliminarBici(biciId) {
            const bici = datosUsuario.garaje.find(b => b.id === biciId);
            if (!bici) return;

            confirmar(
                '¬øEliminar bici?',
                `¬øEst√°s seguro de eliminar "${bici.alias}"? Esta acci√≥n no se puede deshacer y perder√°s todo su historial.`,
                () => {
                    const index = datosUsuario.garaje.findIndex(b => b.id === biciId);
                    if (index !== -1) {
                        datosUsuario.garaje.splice(index, 1);
                        guardarDatosUsuario();
                        mostrarNotificacion(`"${bici.alias}" eliminada correctamente`, 'exito');
                        navegar('sec-garaje');
                    }
                }
            );
        }

        function cargarBicisRetiradas() {
            const container = document.getElementById('lista-bicis-retiradas');
            const bicisRetiradas = datosUsuario.garaje.filter(b => b.activa === false);
            
            if (!bicisRetiradas || bicisRetiradas.length === 0) {
                container.innerHTML = `
                    <div class="lista-vacia">
                        <div class="lista-vacia-icon">üì¶</div>
                        <p>No hay bicis retiradas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            bicisRetiradas.forEach(bici => {
                const fechaRetiro = bici.fechaRetiro ? new Date(bici.fechaRetiro).toLocaleDateString('es-ES') : 'Fecha desconocida';
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.borderLeftColor = 'var(--text)';
                card.style.opacity = '0.85';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${bici.alias}</div>
                            <div class="card-subtitle">${bici.marca} ${bici.modelo}</div>
                            <div class="text-muted" style="font-size: 0.75em; margin-top: 5px;">Retirada: ${fechaRetiro}</div>
                        </div>
                        <span class="badge" style="background: #e0e0e0; color: #666;">${bici.disciplina}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; align-items: center;">
                        <div class="text-muted">
                            <strong style="color: var(--text); font-size: 1em;">${bici.kmTotales || 0} km</strong>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button class="btn btn-primary" style="flex: 1; padding: 8px; font-size: 0.85em;" onclick="reactivarBici('${bici.id}')">
                            ‚Ü©Ô∏è Reactivar
                        </button>
                        <button class="btn btn-danger" style="flex: 1; padding: 8px; font-size: 0.85em;" onclick="eliminarBiciRetirada('${bici.id}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function reactivarBici(biciId) {
            const bici = datosUsuario.garaje.find(b => b.id === biciId);
            if (!bici) return;

            confirmar(
                '¬øReactivar bici?',
                `"${bici.alias}" volver√° a tu garaje activo.`,
                async () => {
                    bici.activa = true;
                    delete bici.fechaRetiro;
                    await guardarDatosUsuario();
                    mostrarNotificacion(`"${bici.alias}" reactivada ‚úÖ`, 'exito');
                    cargarBicisRetiradas();
                    mostrarNotificacion(`"${bici.alias}" reactivada en el garaje`, 'exito');
                }
            );
        }

        function eliminarBiciRetirada(biciId) {
            const bici = datosUsuario.garaje.find(b => b.id === biciId);
            if (!bici) return;

            confirmar(
                '¬øEliminar bici?',
                `¬øEst√°s seguro de eliminar "${bici.alias}"? Esta acci√≥n no se puede deshacer y perder√°s todo su historial.`,
                () => {
                    const index = datosUsuario.garaje.findIndex(b => b.id === biciId);
                    if (index !== -1) {
                        datosUsuario.garaje.splice(index, 1);
                        guardarDatosUsuario();
                        cargarBicisRetiradas();
                        mostrarNotificacion(`"${bici.alias}" eliminada correctamente`, 'exito');
                    }
                }
            );
        }

        function crearBicicleta() {
            const alias = document.getElementById('nueva-alias').value.trim();
            const marca = document.getElementById('nueva-marca').value;
            const modelo = document.getElementById('nueva-modelo').value.trim();
            const disciplina = document.getElementById('nueva-disciplina').value;
            const fechaCompra = document.getElementById('nueva-fecha').value;
            const kmIniciales = parseFloat(document.getElementById('nueva-km').value) || 0;

            if (!alias || !marca || !modelo) {
                mostrarNotificacion('Por favor, completa alias, marca y modelo', 'error');
                return;
            }

            if (!fechaCompra) {
                mostrarNotificacion('Por favor, indica la fecha de compra', 'error');
                return;
            }

            const nuevaBici = {
                id: Date.now().toString(),
                alias: alias,
                marca: marca,
                modelo: modelo,
                disciplina: disciplina,
                fechaCompra: fechaCompra,
                kmTotales: kmIniciales,
                pesoGramos: 0,
                inversion: 0,
                componentes: [],
                historial: [],
                activa: true,
                fechaCreacion: new Date().toISOString()
            };

            datosUsuario.garaje.push(nuevaBici);
            guardarDatosUsuario();

            // Limpiar formulario
            document.getElementById('nueva-alias').value = '';
            document.getElementById('nueva-marca').value = '';
            document.getElementById('nueva-modelo').value = '';
            document.getElementById('nueva-fecha').value = '';
            document.getElementById('nueva-km').value = '0';

            mostrarNotificacion('¬°Bicicleta creada correctamente!', 'exito');
            navegar('sec-garaje');
        }

        function abrirTaller(biciId) {
            biciActual = datosUsuario.garaje.find(b => b.id === biciId);
            if (!biciActual) {
                mostrarNotificacion('Error: No se encontr√≥ la bici', 'error');
                return;
            }
            navegar('sec-taller');
        }

        function cargarTaller() {
            if (!biciActual) return;

            document.getElementById('taller-nombre-bici').textContent = biciActual.alias;
            document.getElementById('taller-alias').textContent = biciActual.alias;
            document.getElementById('taller-modelo').textContent = `${biciActual.marca} ${biciActual.modelo}`;
            document.getElementById('taller-disciplina').textContent = biciActual.disciplina;
            document.getElementById('taller-km').textContent = `${biciActual.kmTotales || 0} km`;
            
            // Calcular peso total ‚Äî excluir secci√≥n 'Ruedas' antigua
            let pesoTotal = 0;
            if (biciActual.componentesV2) {
                Object.keys(biciActual.componentesV2).forEach(seccion => {
                    if (seccion === 'Ruedas') return; // excluir antigua secci√≥n ruedas
                    biciActual.componentesV2[seccion].forEach(comp => {
                        pesoTotal += comp.peso || 0;
                        if (comp.subpiezas) {
                            Object.values(comp.subpiezas).forEach(sub => {
                                pesoTotal += sub.peso || 0;
                            });
                        }
                    });
                });
            }
            // Sumar pesos solo del juego activo
            if (biciActual.juegosRuedas) {
                const juegoActivo = biciActual.juegosRuedas.find(j => j.activo && !j.retirado);
                if (juegoActivo && juegoActivo.ruedas) {
                    Object.values(juegoActivo.ruedas).forEach(rueda => {
                        pesoTotal += rueda.peso || 0;
                        if (rueda.piezas) {
                            rueda.piezas.forEach(pieza => {
                                pesoTotal += pieza.peso || 0;
                            });
                        }
                    });
                }
            }
            
            const pesoKg = (pesoTotal / 1000).toFixed(2);
            document.getElementById('taller-peso').textContent = `${pesoKg} kg`;
            document.getElementById('taller-inversion').textContent = `${biciActual.inversion || 0}‚Ç¨`;
            
            // Calcular d√≠as de uso desde fecha de compra con formato aa/mm/dd
            if (biciActual.fechaCompra) {
                const diasUso = Math.floor((new Date() - new Date(biciActual.fechaCompra)) / 86400000);
                document.getElementById('taller-uso').textContent = formatearDuracion(diasUso);
            } else {
                document.getElementById('taller-uso').textContent = '0d';
            }
            
            // Mostrar vinculaci√≥n con Strava si existe
            if (biciActual.stravaBiciId) {
                document.getElementById('taller-strava-vinculado').style.display = 'block';
                document.getElementById('taller-strava-nombre').textContent = biciActual.stravaBiciNombre || 'Bici de Strava';
                document.getElementById('btn-vincular-strava-icon').textContent = 'üîì';
                document.getElementById('btn-vincular-strava-texto').textContent = 'Desvincular';
            } else {
                document.getElementById('taller-strava-vinculado').style.display = 'none';
                document.getElementById('btn-vincular-strava-icon').textContent = 'üö¥';
                document.getElementById('btn-vincular-strava-texto').textContent = 'Vincular Strava';
            }
        }

        function volverATaller() {
            navegar('sec-taller');
        }

        function mostrarMenuBici() {
            if (!biciActual) return;

            // Crear modal din√°mico de men√∫
            const modalExistente = document.getElementById('modal-menu-bici');
            if (modalExistente) modalExistente.remove();

            const modal = document.createElement('div');
            modal.id = 'modal-menu-bici';
            modal.className = 'modal activo';
            modal.innerHTML = `
                <div class="modal-contenido" style="max-width: 320px;">
                    <div class="modal-confirmar-titulo" style="font-size: 1.1em; margin-bottom: 5px;">‚öôÔ∏è ${biciActual.alias}</div>
                    <div class="text-muted" style="font-size: 0.85em; margin-bottom: 20px; text-align: center;">${biciActual.marca} ${biciActual.modelo}</div>
                    
                    <button class="btn btn-primary" style="width:100%; margin-bottom: 10px;" onclick="cerrarMenuBici(); editarBici();">
                        ‚úèÔ∏è Editar datos
                    </button>
                    <button class="btn btn-secondary" style="width:100%; margin-bottom: 10px;" onclick="cerrarMenuBici(); retirarBici(biciActual.id);">
                        üì¶ Retirar bici
                    </button>
                    <button class="btn btn-danger" style="width:100%; margin-bottom: 15px;" onclick="cerrarMenuBici(); eliminarBici(biciActual.id);">
                        üóëÔ∏è Eliminar bici
                    </button>
                    <button class="btn btn-secondary" onclick="cerrarMenuBici();">
                        ‚Üê Cancelar
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function cerrarMenuBici() {
            const modal = document.getElementById('modal-menu-bici');
            if (modal) modal.remove();
        }

        function editarBici() {
            if (!biciActual) return;
            window._editandoBiciId = biciActual.id;

            // Modo edici√≥n: cambiar textos
            document.getElementById('titulo-nueva-bici').textContent = 'Editar Bici';
            document.getElementById('btn-guardar-bici').textContent = 'üíæ Guardar Cambios';
            document.getElementById('btn-back-nueva-bici').setAttribute('onclick', "cancelarFormBici()");

            // Rellenar formulario con datos actuales
            document.getElementById('nueva-alias').value = biciActual.alias || '';
            document.getElementById('nueva-marca').value = biciActual.marca || '';
            document.getElementById('nueva-modelo').value = biciActual.modelo || '';
            document.getElementById('nueva-disciplina').value = biciActual.disciplina || 'Carretera';
            document.getElementById('nueva-fecha').value = biciActual.fechaCompra || '';
            document.getElementById('nueva-km').value = biciActual.kmTotales || 0;

            // Cambiar label de KM
            const labelKm = document.querySelector('label[for="nueva-km"]');
            if (labelKm) labelKm.textContent = 'Kil√≥metros totales';
            else {
                const kmInput = document.getElementById('nueva-km');
                if (kmInput && kmInput.previousElementSibling) {
                    kmInput.previousElementSibling.textContent = 'Kil√≥metros totales';
                }
            }

            navegar('sec-nueva-bici');
        }

        function cancelarFormBici() {
            const editando = window._editandoBiciId;
            window._editandoBiciId = null;

            // Resetear formulario
            document.getElementById('titulo-nueva-bici').textContent = 'Nueva Bici';
            document.getElementById('btn-guardar-bici').textContent = 'Crear Bicicleta';
            document.getElementById('btn-back-nueva-bici').setAttribute('onclick', "navegar('sec-garaje')");

            // Limpiar campos
            document.getElementById('nueva-alias').value = '';
            document.getElementById('nueva-marca').value = '';
            document.getElementById('nueva-modelo').value = '';
            document.getElementById('nueva-fecha').value = '';
            document.getElementById('nueva-km').value = '0';

            navegar(editando ? 'sec-taller' : 'sec-garaje');
        }

        function guardarBici() {
            if (window._editandoBiciId) {
                guardarEdicionBici();
            } else {
                crearBicicleta();
            }
        }

        async function guardarEdicionBici() {
            const alias = document.getElementById('nueva-alias').value.trim();
            const marca = document.getElementById('nueva-marca').value;
            const modelo = document.getElementById('nueva-modelo').value.trim();
            const disciplina = document.getElementById('nueva-disciplina').value;
            const fechaCompra = document.getElementById('nueva-fecha').value;
            const kmTotales = parseFloat(document.getElementById('nueva-km').value) || 0;

            if (!alias || !marca || !modelo) {
                mostrarNotificacion('Completa alias, marca y modelo', 'error');
                return;
            }
            if (!fechaCompra) {
                mostrarNotificacion('Indica la fecha de compra', 'error');
                return;
            }

            const biciIndex = datosUsuario.garaje.findIndex(b => b.id === window._editandoBiciId);
            if (biciIndex === -1) {
                mostrarNotificacion('Error: No se encontr√≥ la bici', 'error');
                return;
            }

            // Actualizar conservando componentes, historial, etc.
            datosUsuario.garaje[biciIndex] = {
                ...datosUsuario.garaje[biciIndex],
                alias, marca, modelo, disciplina, fechaCompra, kmTotales
            };

            biciActual = datosUsuario.garaje[biciIndex];
            await guardarDatosUsuario();

            // Resetear
            window._editandoBiciId = null;
            document.getElementById('titulo-nueva-bici').textContent = 'Nueva Bici';
            document.getElementById('btn-guardar-bici').textContent = 'Crear Bicicleta';
            document.getElementById('btn-back-nueva-bici').setAttribute('onclick', "navegar('sec-garaje')");

            mostrarNotificacion('‚úÖ Bici actualizada correctamente', 'exito');
            navegar('sec-taller');
            cargarTaller();
        }

        // ========================================
        // GESTI√ìN DE KIL√ìMETROS
        // ========================================
        function abrirModalKm() {
            document.getElementById('input-km').value = '';
            abrirModal('modal-km');
        }

        function guardarKm() {
            const km = parseFloat(document.getElementById('input-km').value);
            
            if (!km || km <= 0) {
                mostrarNotificacion('Introduce un valor v√°lido de kil√≥metros', 'error');
                return;
            }

            biciActual.kmTotales = (biciActual.kmTotales || 0) + km;
            guardarDatosUsuario();
            cargarTaller();
            cerrarModal('modal-km');
            mostrarNotificacion(`¬°${km} km a√±adidos correctamente!`, 'exito');
        }

        // ========================================
        // GESTI√ìN DE COMPONENTES - SISTEMA COMPLETO V2
        // ========================================
        
        // Variables globales para componentes
        let seccionActual = null;
        let componenteActual = null;
        let modoEdicion = false;
        
        // Definici√≥n de secciones por disciplina
        const SECCIONES_COMPONENTES = {
            'Carretera': ['Cuadro', 'Transmisi√≥n', 'Frenos', 'Ruedas', 'Perif√©ricos'],
            'Gravel': ['Cuadro', 'Transmisi√≥n', 'Frenos', 'Ruedas', 'Perif√©ricos'],
            'MTB': ['Cuadro', 'Transmisi√≥n', 'Frenos', 'Ruedas', 'Perif√©ricos', 'Suspensiones'],
            'Indoor': ['Cuadro', 'Transmisi√≥n', 'Perif√©ricos'],
            'Urbana': ['Cuadro', 'Transmisi√≥n', 'Frenos', 'Ruedas', 'Perif√©ricos'],
            'El√©ctrica': ['Cuadro', 'Transmisi√≥n', 'Frenos', 'Ruedas', 'Perif√©ricos']
        };
        
        // Componentes por secci√≥n
        const COMPONENTES_POR_SECCION = {
            'Cuadro': {
                'Carretera': ['Cuadro', 'Horquilla', 'Direcci√≥n', 'Cierre Tija', 'Patilla de Cambio'],
                'Gravel': ['Cuadro', 'Horquilla', 'Direcci√≥n', 'Cierre Tija', 'Patilla de Cambio'],
                'MTB': ['Cuadro', 'Direcci√≥n', 'Cierre Tija', 'Patilla de Cambio'],
                'Indoor': ['Cuadro/Estructura', 'Manillar', 'Tija Sill√≠n'],
                'todos': ['Cuadro', 'Horquilla', 'Direcci√≥n', 'Cierre Tija', 'Patilla de Cambio']
            },
            'Transmisi√≥n': {
                'Carretera': ['Cambio Trasero', 'Desviador Delantero', 'Cassette', 'Cadena', 'Bielas', 'Eje de Pedalier', 'Pedales', 'Bater√≠a de Cambio'],
                'Gravel': ['Cambio Trasero', 'Desviador Delantero', 'Cassette', 'Cadena', 'Bielas', 'Eje de Pedalier', 'Pedales', 'Bater√≠a de Cambio'],
                'MTB': ['Cambio Trasero', 'Desviador Delantero', 'Cassette', 'Cadena', 'Bielas', 'Eje de Pedalier', 'Pedales', 'Bater√≠a de Cambio', 'Mando Cambio Delantero', 'Mando Cambio Trasero'],
                'Indoor': ['Bielas', 'Pedales', 'Volante de Inercia', 'Sistema de Resistencia', 'Correa/Cadena'],
                'todos': ['Cambio Trasero', 'Cassette', 'Cadena', 'Bielas', 'Eje de Pedalier', 'Pedales']
            },
            'Frenos': {
                'todos': ['Maneta Izquierda', 'Maneta Derecha', 'Pinza Delantera', 'Pinza Trasera', 'Disco Delantero', 'Disco Trasero']
            },
            'Ruedas': {
                'todos': ['Llanta Delantera', 'Llanta Trasera', 'Buje Delantero', 'Buje Trasero', 'Cubierta Delantera', 'Cubierta Trasera', 'Cierre Delantero', 'Cierre Trasero', 'N√∫cleo', 'C√°maras/V√°lvulas/Tubeless']
            },
            'Perif√©ricos': {
                'todos': ['Manillar', 'Potencia', 'Tija', 'Sill√≠n', 'Pu√±os/Cinta', 'Portabidones', 'Acople GPS'],
                'Indoor': ['Consola', 'Manillar', 'Tija Sill√≠n', 'Sill√≠n', 'Portabidones', 'Acople GPS/Ciclocomputador', 'Soporte Tablet/M√≥vil', 'Ventilador', 'Alfombrilla Protectora', 'Protector Anticorrosi√≥n/Sudor']
            },
            'Suspensiones': {
                'MTB': ['Horquilla', 'Amortiguador', 'Rodamientos/Casquillos', 'Mando Remoto Trasero', 'Mando Remoto Delantero']
            }
        };
        
        // Componentes con subpiezas
        const SUBPIEZAS = {
            'Cambio Trasero': ['Roldanas'],
            'Bielas': ['Plato Grande', 'Plato Peque√±o', 'Monoplato'],
            'Maneta Izquierda': ['Pila', 'Escalador'],
            'Maneta Derecha': ['Pila', 'Escalador'],
            'Pinza Delantera': ['Pastillas'],
            'Pinza Trasera': ['Pastillas']
        };
        
        // Cargar grid de secciones
        function cargarSeccionesComponentes() {
            if (!biciActual) return;
            
            const grid = document.getElementById('grid-secciones-componentes');
            const secciones = SECCIONES_COMPONENTES[biciActual.disciplina] || SECCIONES_COMPONENTES['Carretera'];
            
            grid.innerHTML = '';
            const iconos = {'Cuadro': 'üö≤', 'Transmisi√≥n': '‚öôÔ∏è', 'Frenos': 'üõë', 'Ruedas': '‚≠ï', 'Perif√©ricos': 'üéØ', 'Suspensiones': 'ü¶ò'};
            
            secciones.forEach(seccion => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                // Ruedas tiene su propio sistema de juegos
                card.onclick = () => seccion === 'Ruedas' ? abrirGarajeRuedas() : abrirSeccionComponentes(seccion);
                card.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 10px;">${iconos[seccion]}</div>
                        <div class="card-title" style="font-size: 1em;">${seccion}</div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        // ========================================
        // SISTEMA DE JUEGOS DE RUEDAS
        // ========================================
        let juegosRuedasActual = null; // juego de ruedas seleccionado

        function abrirGarajeRuedas() {
            navegar('sec-garaje-ruedas');
        }

        function cargarGarajeRuedas() {
            if (!biciActual) return;
            if (!biciActual.juegosRuedas) biciActual.juegosRuedas = [];
            if (!biciActual.juegosRuedasRetiradas) biciActual.juegosRuedasRetiradas = [];

            document.getElementById('garaje-ruedas-nombre-bici').textContent = biciActual.alias;
            const container = document.getElementById('lista-juegos-ruedas');

            // Juegos activos e inactivos (no retirados)
            const juegosActivos = biciActual.juegosRuedas.filter(j => !j.retirado);

            // Bot√≥n ver retiradas
            const btnRetiradas = document.getElementById('btn-ver-ruedas-retiradas');
            if (btnRetiradas) {
                const numRetiradas = biciActual.juegosRuedas.filter(j => j.retirado).length;
                btnRetiradas.style.display = numRetiradas > 0 ? 'block' : 'none';
                btnRetiradas.textContent = `üì¶ Ver Ruedas Retiradas (${numRetiradas})`;
            }

            if (juegosActivos.length === 0) {
                container.innerHTML = `
                    <div class="lista-vacia">
                        <div class="lista-vacia-icon">‚≠ï</div>
                        <p>No hay juegos de ruedas registrados</p>
                    </div>`;
                return;
            }

            container.innerHTML = '';
            juegosActivos.forEach(juego => {
                // KM acumulados: km previos + km del per√≠odo actual si est√° activo
                const kmPrevios = juego.kmAcumuladosPrevios || 0;
                const kmRef = juego.kmActivacion !== undefined && juego.kmActivacion !== null
                    ? juego.kmActivacion : (juego.kmInstalacion || 0);
                const kmPeriodoActual = juego.activo
                    ? Math.max(0, (biciActual.kmTotales || 0) - kmRef)
                    : 0;
                const kmTotalesJuego = kmPrevios + kmPeriodoActual;

                // D√≠as acumulados: d√≠as previos + d√≠as del per√≠odo actual si est√° activo
                const diasPrevios = juego.diasAcumuladosPrevios || 0;
                const fechaRef = juego.fechaActivacion || juego.fechaInstalacion;
                const diasPeriodoActual = juego.activo && fechaRef
                    ? Math.floor((new Date() - new Date(fechaRef)) / 86400000)
                    : 0;
                const diasTotales = diasPrevios + diasPeriodoActual;

                const card = document.createElement('div');
                card.className = 'card';
                card.style.borderLeftColor = juego.activo ? 'var(--primary)' : 'var(--text)';
                card.style.opacity = juego.activo ? '1' : '0.75';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${juego.marca} ${juego.modelo}</div>
                            <div class="card-subtitle">Desde: ${formatearFecha(juego.fechaInstalacion)} ¬∑ ${juego.kmInstalacion || 0} km</div>
                        </div>
                        <span class="badge ${juego.activo ? 'badge-primary' : ''}" style="${juego.activo ? '' : 'background:#e0e0e0;color:#666;'}">${juego.activo ? 'üü¢ Activo' : '‚ö™ Disponible'}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                        <div style="text-align:center; padding:8px; background:var(--light-gray); border-radius:8px;">
                            <div style="font-size:0.75em; color:var(--text); font-weight:600;">KM ACUMULADOS</div>
                            <div style="font-size:1.3em; font-weight:700; color:var(--primary);">${kmTotalesJuego}</div>
                        </div>
                        <div style="text-align:center; padding:8px; background:var(--light-gray); border-radius:8px;">
                            <div style="font-size:0.75em; color:var(--text); font-weight:600;">TIEMPO USO</div>
                            <div style="font-size:1.3em; font-weight:700; color:var(--secondary);">${formatearDuracion(diasTotales)}</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
                        <button class="btn btn-primary" style="flex:1; padding:8px; font-size:0.85em;" title="Ver ruedas de este juego" onclick="abrirDetalleJuegoRuedas('${juego.id}')">
                            üö≤
                        </button>
                        <button class="btn btn-secondary" style="flex:1; padding:8px; font-size:0.85em;" title="Editar datos del juego" onclick="editarJuegoRuedas('${juego.id}')">‚úèÔ∏è</button>
                        ${!juego.activo ? `<button class="btn btn-primary" style="flex:1; padding:8px; font-size:0.85em; background:var(--secondary);" title="Activar este juego" onclick="activarJuegoRuedas('${juego.id}')">‚ö°</button>` : ''}
                        <button class="btn btn-secondary" style="flex:1; padding:8px; font-size:0.85em; background:var(--warning); color:white;" title="Retirar a ruedas retiradas" onclick="retirarJuegoRuedas('${juego.id}')">üì¶</button>
                        <button class="btn btn-danger" style="flex:1; padding:8px; font-size:0.85em;" title="Eliminar definitivamente" onclick="eliminarJuegoRuedas('${juego.id}')">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function toggleMarcaJuegoOtra() {
            const sel = document.getElementById('juego-marca-select');
            const inp = document.getElementById('juego-marca');
            if (sel.value === 'Otra') {
                inp.style.display = 'block';
                inp.value = '';
                inp.focus();
            } else {
                inp.style.display = 'none';
                inp.value = sel.value;
            }
        }

        function abrirModalNuevoJuegoRuedas() {
            document.getElementById('juego-ruedas-modal-titulo').textContent = 'Nuevo Juego de Ruedas';
            document.getElementById('juego-marca-select').value = '';
            document.getElementById('juego-marca').value = '';
            document.getElementById('juego-marca').style.display = 'none';
            document.getElementById('juego-modelo').value = '';

            const hayJuegos = biciActual.juegosRuedas && biciActual.juegosRuedas.length > 0;
            // Si ya hay juegos: fecha hoy y km actuales. Si es el primero: fecha compra bici y 0 km
            document.getElementById('juego-fecha').value = hayJuegos
                ? new Date().toISOString().split('T')[0]
                : (biciActual.fechaCompra || new Date().toISOString().split('T')[0]);
            document.getElementById('juego-km').value = hayJuegos ? (biciActual.kmTotales || 0) : 0;

            window._editandoJuegoId = null;
            abrirModal('modal-juego-ruedas');
        }

        function guardarJuegoRuedas() {
            const marcaSel = document.getElementById('juego-marca-select').value;
            const marcaInp = document.getElementById('juego-marca').value.trim();
            const marca = marcaSel === 'Otra' ? marcaInp : marcaSel;
            const modelo = document.getElementById('juego-modelo').value.trim();
            const fecha = document.getElementById('juego-fecha').value;
            const km = parseFloat(document.getElementById('juego-km').value) || 0;

            if (!marca) {
                mostrarNotificacion('Selecciona o indica la marca', 'error');
                return;
            }
            if (!fecha) {
                mostrarNotificacion('Indica la fecha de instalaci√≥n', 'error');
                return;
            }

            if (!biciActual.juegosRuedas) biciActual.juegosRuedas = [];

            // Modo edici√≥n
            if (window._editandoJuegoId) {
                const juego = biciActual.juegosRuedas.find(j => j.id === window._editandoJuegoId);
                if (juego) {
                    juego.marca = marca;
                    juego.modelo = modelo;
                    juego.fechaInstalacion = fecha;
                    juego.kmInstalacion = km;
                }
                window._editandoJuegoId = null;
                guardarDatosUsuario();
                cargarGarajeRuedas();
                cerrarModal('modal-juego-ruedas');
                mostrarNotificacion('Juego actualizado correctamente', 'exito');
                return;
            }

            // Nuevo juego
            const juegoActivo = biciActual.juegosRuedas.find(j => j.activo);
            const nuevoJuego = {
                id: Date.now().toString(),
                marca, modelo,
                fechaInstalacion: fecha,
                kmInstalacion: km,
                activo: false,
                kmAcumuladosPrevios: 0,
                diasAcumuladosPrevios: 0
            };

            const activarNuevo = () => {
                // Congelar km y d√≠as del activo actual si lo hay
                if (juegoActivo) {
                    const kmRef = juegoActivo.kmActivacion !== undefined && juegoActivo.kmActivacion !== null
                        ? juegoActivo.kmActivacion : (juegoActivo.kmInstalacion || 0);
                    const fechaRef = juegoActivo.fechaActivacion || juegoActivo.fechaInstalacion;
                    const kmPeriodo = Math.max(0, (biciActual.kmTotales || 0) - kmRef);
                    const diasPeriodo = fechaRef
                        ? Math.floor((new Date() - new Date(fechaRef)) / 86400000) : 0;
                    juegoActivo.kmAcumuladosPrevios = (juegoActivo.kmAcumuladosPrevios || 0) + kmPeriodo;
                    juegoActivo.diasAcumuladosPrevios = (juegoActivo.diasAcumuladosPrevios || 0) + diasPeriodo;
                    juegoActivo.activo = false;
                    juegoActivo.kmActivacion = null;
                    juegoActivo.fechaActivacion = null;
                }
                nuevoJuego.activo = true;
                nuevoJuego.kmActivacion = km; // km en el momento de instalaci√≥n del nuevo juego
                nuevoJuego.fechaActivacion = fecha + 'T00:00:00.000Z';
                guardarDatosUsuario();
                cargarGarajeRuedas();
                mostrarNotificacion('‚úÖ Juego a√±adido y activado', 'exito');
            };

            biciActual.juegosRuedas.push(nuevoJuego);
            cerrarModal('modal-juego-ruedas');

            if (!juegoActivo) {
                // No hay activo ‚Üí activar directamente
                activarNuevo();
            } else {
                // Hay uno activo ‚Üí preguntar
                confirmar(
                    '¬øActivar este juego?',
                    `"${juegoActivo.marca} ${juegoActivo.modelo}" quedar√° disponible. ¬øDeseas activar el nuevo juego ahora?`,
                    activarNuevo
                );
                // Si cancela, el juego queda disponible
                guardarDatosUsuario();
                cargarGarajeRuedas();
            }
        }

        function editarJuegoRuedas(juegoId) {
            const juego = biciActual.juegosRuedas.find(j => j.id === juegoId);
            if (!juego) return;
            window._editandoJuegoId = juegoId;
            document.getElementById('juego-ruedas-modal-titulo').textContent = 'Editar Juego de Ruedas';
            const sel = document.getElementById('juego-marca-select');
            const inp = document.getElementById('juego-marca');
            const optionExists = Array.from(sel.options).some(o => o.value === juego.marca);
            if (optionExists) {
                sel.value = juego.marca;
                inp.style.display = 'none';
                inp.value = juego.marca;
            } else {
                sel.value = 'Otra';
                inp.style.display = 'block';
                inp.value = juego.marca || '';
            }
            document.getElementById('juego-modelo').value = juego.modelo;
            document.getElementById('juego-fecha').value = juego.fechaInstalacion || '';
            document.getElementById('juego-km').value = juego.kmInstalacion || 0;
            abrirModal('modal-juego-ruedas');
        }

        function activarJuegoRuedas(juegoId) {
            const juego = biciActual.juegosRuedas.find(j => j.id === juegoId && !j.retirado);
            if (!juego) return;
            const juegoActivo = biciActual.juegosRuedas.find(j => j.activo);

            const doActivar = async () => {
                if (juegoActivo) {
                    const kmPeriodo = Math.max(0, (biciActual.kmTotales || 0) - (juegoActivo.kmActivacion || juegoActivo.kmInstalacion || 0));
                    const diasPeriodo = juegoActivo.fechaActivacion
                        ? Math.floor((new Date() - new Date(juegoActivo.fechaActivacion)) / 86400000) : 0;
                    juegoActivo.kmAcumuladosPrevios = (juegoActivo.kmAcumuladosPrevios || 0) + kmPeriodo;
                    juegoActivo.diasAcumuladosPrevios = (juegoActivo.diasAcumuladosPrevios || 0) + diasPeriodo;
                    juegoActivo.activo = false;
                    juegoActivo.kmActivacion = null;
                    juegoActivo.fechaActivacion = null;
                }
                juego.activo = true;
                juego.kmActivacion = biciActual.kmTotales || 0;
                juego.fechaActivacion = new Date().toISOString();
                await guardarDatosUsuario();
                cargarGarajeRuedas();
                mostrarNotificacion(`"${juego.marca} ${juego.modelo}" activado ‚úÖ`, 'exito');
            };

            if (juegoActivo) {
                confirmar(
                    '¬øCambiar juego activo?',
                    `"${juegoActivo.marca} ${juegoActivo.modelo}" quedar√° disponible y se activar√° "${juego.marca} ${juego.modelo}".`,
                    doActivar
                );
            } else {
                doActivar();
            }
        }

        function retirarJuegoRuedas(juegoId) {
            const juego = biciActual.juegosRuedas.find(j => j.id === juegoId);
            if (!juego) return;
            confirmar(
                '¬øRetirar juego de ruedas?',
                `"${juego.marca} ${juego.modelo}" pasar√° a Ruedas Retiradas. Podr√°s reactivarlo cuando quieras.`,
                async () => {
                    if (juego.activo) {
                        const kmPeriodo = Math.max(0, (biciActual.kmTotales || 0) - (juego.kmActivacion || juego.kmInstalacion || 0));
                        const diasPeriodo = juego.fechaActivacion
                            ? Math.floor((new Date() - new Date(juego.fechaActivacion)) / 86400000) : 0;
                        juego.kmAcumuladosPrevios = (juego.kmAcumuladosPrevios || 0) + kmPeriodo;
                        juego.diasAcumuladosPrevios = (juego.diasAcumuladosPrevios || 0) + diasPeriodo;
                        juego.activo = false;
                        juego.kmActivacion = null;
                        juego.fechaActivacion = null;
                        const disponibles = biciActual.juegosRuedas.filter(j => !j.activo && !j.retirado && j.id !== juegoId);
                        if (disponibles.length === 1) {
                            disponibles[0].activo = true;
                            disponibles[0].kmActivacion = biciActual.kmTotales || 0;
                            disponibles[0].fechaActivacion = new Date().toISOString();
                            mostrarNotificacion(`"${disponibles[0].marca} ${disponibles[0].modelo}" activado autom√°ticamente`, 'info');
                        } else if (disponibles.length > 1) {
                            mostrarNotificacion('Recuerda activar otro juego de ruedas', 'info');
                        }
                    }
                    juego.retirado = true;
                    juego.fechaRetiro = new Date().toISOString();
                    await guardarDatosUsuario();
                    cargarGarajeRuedas();
                    mostrarNotificacion(`"${juego.marca} ${juego.modelo}" retirado üì¶`, 'info');
                }
            );
        }

        function eliminarJuegoRuedas(juegoId) {
            const juego = biciActual.juegosRuedas.find(j => j.id === juegoId);
            if (!juego) return;
            confirmar(
                '¬øEliminar juego de ruedas?',
                `¬øEst√°s seguro de eliminar "${juego.marca} ${juego.modelo}"? Se perder√°n todos sus datos.`,
                async () => {
                    const eraActivo = juego.activo;
                    biciActual.juegosRuedas = biciActual.juegosRuedas.filter(j => j.id !== juegoId);
                    if (eraActivo) {
                        const disponibles = biciActual.juegosRuedas.filter(j => !j.activo && !j.retirado);
                        if (disponibles.length === 1) {
                            disponibles[0].activo = true;
                            disponibles[0].kmActivacion = biciActual.kmTotales || 0;
                            disponibles[0].fechaActivacion = new Date().toISOString();
                            mostrarNotificacion(`"${disponibles[0].marca} ${disponibles[0].modelo}" activado autom√°ticamente`, 'info');
                        } else if (disponibles.length > 1) {
                            mostrarNotificacion('Recuerda activar otro juego de ruedas', 'info');
                        }
                    }
                    await guardarDatosUsuario();
                    cargarGarajeRuedas();
                    mostrarNotificacion('Juego eliminado', 'info');
                }
            );
        }

        function cargarRuedasRetiradas() {
            if (!biciActual) return;
            const retiradas = (biciActual.juegosRuedas || []).filter(j => j.retirado);
            const container = document.getElementById('lista-ruedas-retiradas');
            if (retiradas.length === 0) {
                container.innerHTML = `<div class="lista-vacia"><div class="lista-vacia-icon">üì¶</div><p>No hay ruedas retiradas</p></div>`;
                return;
            }
            container.innerHTML = '';
            retiradas.forEach(juego => {
                const kmTotales = juego.kmAcumuladosPrevios || 0;
                const diasTotales = juego.diasAcumuladosPrevios || 0;
                const card = document.createElement('div');
                card.className = 'card';
                card.style.borderLeftColor = 'var(--text)';
                card.style.opacity = '0.85';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${juego.marca} ${juego.modelo}</div>
                            <div class="card-subtitle">Instalado: ${formatearFecha(juego.fechaInstalacion)}</div>
                            <div class="text-muted" style="font-size:0.75em; margin-top:3px;">Retirado: ${formatearFecha(juego.fechaRetiro)}</div>
                        </div>
                        <span class="badge" style="background:#e0e0e0;color:#666;">üì¶ Retirado</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                        <div style="text-align:center; padding:8px; background:var(--light-gray); border-radius:8px;">
                            <div style="font-size:0.75em; color:var(--text); font-weight:600;">KM TOTALES</div>
                            <div style="font-size:1.3em; font-weight:700; color:var(--primary);">${kmTotales}</div>
                        </div>
                        <div style="text-align:center; padding:8px; background:var(--light-gray); border-radius:8px;">
                            <div style="font-size:0.75em; color:var(--text); font-weight:600;">TIEMPO USO</div>
                            <div style="font-size:1.3em; font-weight:700; color:var(--secondary);">${formatearDuracion(diasTotales)}</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="btn btn-primary" style="flex:1; padding:8px; font-size:0.85em;" title="Volver a disponible" onclick="reactivarJuegoRuedas('${juego.id}')">‚Ü©Ô∏è Reactivar</button>
                        <button class="btn btn-danger" style="flex:1; padding:8px; font-size:0.85em;" title="Eliminar definitivamente" onclick="eliminarJuegoRetirado('${juego.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function reactivarJuegoRuedas(juegoId) {
            const juego = biciActual.juegosRuedas.find(j => j.id === juegoId);
            if (!juego) return;
            confirmar(
                '¬øReactivar juego de ruedas?',
                `"${juego.marca} ${juego.modelo}" volver√° como disponible con sus km y tiempo acumulados.`,
                async () => {
                    juego.retirado = false;
                    juego.fechaRetiro = null;
                    await guardarDatosUsuario();
                    cargarRuedasRetiradas();
                    cargarGarajeRuedas();
                    mostrarNotificacion(`"${juego.marca} ${juego.modelo}" disponible ‚Ü©Ô∏è`, 'exito');
                }
            );
        }

        function eliminarJuegoRetirado(juegoId) {
            const juego = biciActual.juegosRuedas.find(j => j.id === juegoId);
            if (!juego) return;
            confirmar(
                '¬øEliminar definitivamente?',
                `¬øEst√°s seguro de eliminar "${juego.marca} ${juego.modelo}"? Esta acci√≥n no se puede deshacer.`,
                async () => {
                    biciActual.juegosRuedas = biciActual.juegosRuedas.filter(j => j.id !== juegoId);
                    await guardarDatosUsuario();
                    cargarRuedasRetiradas();
                    mostrarNotificacion('Juego eliminado definitivamente', 'info');
                }
            );
        }


        function abrirDetalleJuegoRuedas(juegoId) {
            juegosRuedasActual = biciActual.juegosRuedas.find(j => j.id === juegoId);
            if (!juegosRuedasActual) return;
            navegar('sec-detalle-juego-ruedas');
        }

        function cargarDetalleJuegoRuedas() {
            if (!juegosRuedasActual) return;
            document.getElementById('detalle-juego-ruedas-titulo').textContent = `${juegosRuedasActual.marca} ${juegosRuedasActual.modelo}`;
            const container = document.getElementById('contenido-detalle-ruedas');
            container.innerHTML = '';

            // Inicializar estructura si no existe
            if (!juegosRuedasActual.ruedas) juegosRuedasActual.ruedas = {};

            ['delantera', 'trasera'].forEach(lado => {
                const rueda = juegosRuedasActual.ruedas[lado];
                const titulo = lado === 'delantera' ? '‚¨ÜÔ∏è Rueda Delantera' : '‚¨áÔ∏è Rueda Trasera';

                const div = document.createElement('div');
                div.className = 'card';
                div.style.marginBottom = '15px';

                if (!rueda) {
                    // Sin rueda ‚Äî mostrar bot√≥n a√±adir
                    div.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${titulo}</div>
                        </div>
                        <div style="text-align:center; padding:15px 0;">
                            <div style="color:var(--text); font-size:0.9em; margin-bottom:12px;">Sin rueda registrada</div>
                            <button class="btn btn-primary" style="width:auto; padding:8px 20px;" onclick="abrirModalRueda('${lado}')">‚ûï A√±adir rueda</button>
                        </div>
                    `;
                } else {
                    // Con rueda ‚Äî mostrar tarjeta
                    const kmUso = (biciActual.kmTotales || 0) - (rueda.kmInstalacion || 0);
                    const diasUso = rueda.fechaInstalacion ? Math.floor((new Date() - new Date(rueda.fechaInstalacion)) / 86400000) : 0;
                    const numPiezas = (rueda.piezas || []).length;
                    div.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${titulo}</div>
                            <span class="badge badge-primary">${Math.max(0, kmUso)} km</span>
                        </div>
                        <div style="font-size:0.9em; margin-top:8px;">
                            <strong>${rueda.marca} ${rueda.modelo || ''}</strong>
                            ${rueda.material ? `<span style="color:var(--text); margin-left:8px;">${rueda.material}</span>` : ''}
                            ${rueda.peso ? `<span style="color:var(--text); margin-left:8px;">¬∑ ${rueda.peso}g</span>` : ''}
                        </div>
                        <div style="color:var(--text); font-size:0.8em; margin-top:4px;">
                            Desde: ${formatearFecha(rueda.fechaInstalacion)} ¬∑ ${formatearDuracion(diasUso)}
                        </div>
                        <div style="display:flex; gap:8px; margin-top:12px;">
                            <button class="btn-grid-item" style="flex:1;" title="Editar rueda" onclick="abrirModalRueda('${lado}', true)"><div class="btn-grid-item-icon">‚úèÔ∏è</div></button>
                            <button class="btn-grid-item" style="flex:1;" title="Reparar rueda" onclick="repararRueda('${lado}')"><div class="btn-grid-item-icon">üîß</div></button>
                            <button class="btn-grid-item" style="flex:1;" title="Sustituir rueda" onclick="sustituirRueda('${lado}')"><div class="btn-grid-item-icon">üîÑ</div></button>
                            <button class="btn-grid-item" style="flex:1; color:var(--danger);" title="Eliminar rueda" onclick="eliminarRueda('${lado}')"><div class="btn-grid-item-icon">üóëÔ∏è</div></button>
                        </div>
                        <button class="btn btn-secondary" style="width:100%; margin-top:10px; font-size:0.85em;" onclick="abrirDespieceRueda('${lado}')">
                            üî© Despiece ${numPiezas > 0 ? `(${numPiezas} ${numPiezas === 1 ? 'pieza' : 'piezas'})` : ''}
                        </button>
                    `;
                }
                container.appendChild(div);
            });
        }

        // ========================================
        // MODAL RUEDA (A√±adir / Editar)
        // ========================================
        function abrirModalRueda(lado, editar = false) {
            window._ladoRuedaActual = lado;
            const rueda = juegosRuedasActual.ruedas && juegosRuedasActual.ruedas[lado];
            const tituloLado = lado === 'delantera' ? 'Delantera' : 'Trasera';

            document.getElementById('modal-rueda-titulo').textContent = editar
                ? `Editar ¬∑ Rueda ${tituloLado}`
                : `A√±adir ¬∑ Rueda ${tituloLado}`;

            const sel = document.getElementById('rueda-marca-select');
            const inp = document.getElementById('rueda-marca-input');

            if (editar && rueda) {
                const optExists = Array.from(sel.options).some(o => o.value === rueda.marca);
                if (optExists) { sel.value = rueda.marca; inp.style.display = 'none'; inp.value = rueda.marca; }
                else { sel.value = 'Otra'; inp.style.display = 'block'; inp.value = rueda.marca || ''; }
                document.getElementById('rueda-modelo').value = rueda.modelo || '';
                document.getElementById('rueda-material').value = rueda.material || '';
                document.getElementById('rueda-peso').value = rueda.peso || '';
                document.getElementById('rueda-precio').value = rueda.precio || '';
                document.getElementById('rueda-fecha').value = rueda.fechaInstalacion || '';
                document.getElementById('rueda-km').value = rueda.kmInstalacion || 0;
            } else {
                // Heredar del juego de ruedas
                const marcaJuego = juegosRuedasActual.marca || '';
                const sel2 = document.getElementById('rueda-marca-select');
                const optExists = Array.from(sel2.options).some(o => o.value === marcaJuego);
                if (optExists) { sel2.value = marcaJuego; inp.style.display = 'none'; inp.value = marcaJuego; }
                else if (marcaJuego) { sel2.value = 'Otra'; inp.style.display = 'block'; inp.value = marcaJuego; }
                else { sel2.value = ''; inp.style.display = 'none'; }
                document.getElementById('rueda-modelo').value = juegosRuedasActual.modelo || '';
                document.getElementById('rueda-material').value = juegosRuedasActual.material || '';
                document.getElementById('rueda-peso').value = '';
                document.getElementById('rueda-precio').value = '';
                document.getElementById('rueda-fecha').value = juegosRuedasActual.fechaInstalacion || new Date().toISOString().split('T')[0];
                document.getElementById('rueda-km').value = juegosRuedasActual.kmInstalacion || 0;
            }
            abrirModal('modal-rueda');
        }

        function toggleMarcaRuedaModal() {
            const sel = document.getElementById('rueda-marca-select');
            const inp = document.getElementById('rueda-marca-input');
            if (sel.value === 'Otra') { inp.style.display = 'block'; inp.value = ''; inp.focus(); }
            else { inp.style.display = 'none'; inp.value = sel.value; }
        }

        function guardarRueda() {
            const lado = window._ladoRuedaActual;
            const sel = document.getElementById('rueda-marca-select');
            const inp = document.getElementById('rueda-marca-input');
            const marca = sel.value === 'Otra' ? inp.value.trim() : sel.value;
            const modelo = document.getElementById('rueda-modelo').value.trim();
            const material = document.getElementById('rueda-material').value;
            const peso = parseFloat(document.getElementById('rueda-peso').value) || 0;
            const precio = parseFloat(document.getElementById('rueda-precio').value) || 0;
            const fecha = document.getElementById('rueda-fecha').value;
            const km = parseFloat(document.getElementById('rueda-km').value) || 0;

            if (!marca) { mostrarNotificacion('Indica la marca', 'error'); return; }
            if (!fecha) { mostrarNotificacion('Indica la fecha', 'error'); return; }

            if (!juegosRuedasActual.ruedas) juegosRuedasActual.ruedas = {};
            const ruedaExistente = juegosRuedasActual.ruedas[lado];
            juegosRuedasActual.ruedas[lado] = {
                marca, modelo, material, peso, precio,
                fechaInstalacion: fecha,
                kmInstalacion: km,
                piezas: ruedaExistente ? (ruedaExistente.piezas || []) : []
            };

            guardarDatosUsuario();
            cerrarModal('modal-rueda');
            cargarDetalleJuegoRuedas();
            mostrarNotificacion(`Rueda ${lado} guardada ‚úÖ`, 'exito');
        }

        function eliminarRueda(lado) {
            const rueda = juegosRuedasActual.ruedas && juegosRuedasActual.ruedas[lado];
            if (!rueda) return;
            confirmar(
                '¬øEliminar rueda?',
                `Se eliminar√° la rueda ${lado} "${rueda.marca} ${rueda.modelo || ''}" y todo su despiece.`,
                async () => {
                    delete juegosRuedasActual.ruedas[lado];
                    await guardarDatosUsuario();
                    cargarDetalleJuegoRuedas();
                    mostrarNotificacion('Rueda eliminada', 'info');
                }
            );
        }

        function repararRueda(lado) {
            // Reutilizamos modal-reparar apuntando a la rueda
            window._repararRuedaLado = lado;
            const rueda = juegosRuedasActual.ruedas[lado];
            document.getElementById('reparar-componente-nombre').textContent = `Rueda ${lado} ¬∑ ${rueda.marca} ${rueda.modelo || ''}`;
            document.getElementById('reparar-descripcion').value = '';
            document.getElementById('reparar-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('reparar-km').value = biciActual.kmTotales || 0;
            document.getElementById('reparar-coste').value = '';
            window._repararModoRueda = true;
            abrirModal('modal-reparar');
        }

        function sustituirRueda(lado) {
            // Abrimos modal-rueda en modo edici√≥n ‚Äî la sustituci√≥n es simplemente reemplazar datos
            abrirModalRueda(lado, true);
        }

        // ========================================
        // DESPIECE DE RUEDA
        // ========================================
        const PIEZAS_CON_PESO = ['Cubierta', 'C√°mara', 'V√°lvula', 'Cierre', 'Tubeless'];
        const PIEZAS_DELANTERA = ['Llanta', 'Buje', 'Cubierta', 'Cierre', 'C√°mara', 'V√°lvula', 'Tubeless', 'Radios/Niples'];
        const PIEZAS_TRASERA = [...PIEZAS_DELANTERA, 'N√∫cleo'];

        function abrirDespieceRueda(lado) {
            window._ladoRuedaActual = lado;
            const rueda = juegosRuedasActual.ruedas && juegosRuedasActual.ruedas[lado];
            if (!rueda) return;
            document.getElementById('despiece-rueda-titulo').textContent = `üî© ${rueda.marca} ${rueda.modelo || ''} ¬∑ ${lado === 'delantera' ? 'Delantera' : 'Trasera'}`;
            navegar('sec-despiece-rueda');
        }

        function cargarDespieceRueda() {
            const lado = window._ladoRuedaActual;
            if (!lado || !juegosRuedasActual) return;
            const rueda = juegosRuedasActual.ruedas && juegosRuedasActual.ruedas[lado];
            if (!rueda) return;
            if (!rueda.piezas) rueda.piezas = [];

            const container = document.getElementById('contenido-despiece-rueda');
            container.innerHTML = '';

            if (rueda.piezas.length === 0) {
                container.innerHTML = `<div class="lista-vacia"><div class="lista-vacia-icon">üî©</div><p>Sin piezas registradas</p></div>`;
            } else {
                rueda.piezas.forEach(pieza => {
                    const kmUso = (biciActual.kmTotales || 0) - (pieza.kmInstalacion || 0);
                    const diasUso = pieza.fechaInstalacion ? Math.floor((new Date() - new Date(pieza.fechaInstalacion)) / 86400000) : 0;
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.marginBottom = '12px';
                    card.innerHTML = `
                        <div class="card-header">
                            <div>
                                <div style="font-weight:700;">${pieza.tipo}</div>
                                <div style="font-size:0.85em; color:var(--text);">${pieza.marca || '-'} ${pieza.modelo || ''}</div>
                                ${pieza.material ? `<div style="font-size:0.8em; color:var(--text);">${pieza.material}</div>` : ''}
                            ${pieza.numRadios ? `<div style="font-size:0.8em; color:var(--text);">${pieza.numRadios} radios</div>` : ''}
                            </div>
                            <div style="text-align:right;">
                                <div class="badge badge-primary">${Math.max(0, kmUso)} km</div>
                                <div style="font-size:0.75em; color:var(--text); margin-top:4px;">${formatearDuracion(diasUso)}</div>
                                ${pieza.peso ? `<div style="font-size:0.75em; color:var(--text); margin-top:2px;">${pieza.peso}g</div>` : ''}
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button class="btn-grid-item" style="flex:1;" title="Editar pieza" onclick="editarPiezaRueda('${pieza.id}')"><div class="btn-grid-item-icon">‚úèÔ∏è</div></button>
                            <button class="btn-grid-item" style="flex:1;" title="Reparar pieza" onclick="repararPiezaRueda('${pieza.id}')"><div class="btn-grid-item-icon">üîß</div></button>
                            <button class="btn-grid-item" style="flex:1;" title="Sustituir pieza" onclick="sustituirPiezaRueda('${pieza.id}')"><div class="btn-grid-item-icon">üîÑ</div></button>
                            <button class="btn-grid-item" style="flex:1; color:var(--danger);" title="Eliminar pieza" onclick="eliminarPiezaRueda('${pieza.id}')"><div class="btn-grid-item-icon">üóëÔ∏è</div></button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }

            // Bot√≥n a√±adir pieza
            const btnAdd = document.createElement('button');
            btnAdd.className = 'btn btn-primary mt-20';
            btnAdd.style.width = '100%';
            btnAdd.textContent = '‚ûï A√±adir pieza';
            btnAdd.onclick = () => abrirModalPiezaRueda();
            container.appendChild(btnAdd);
        }

        function abrirModalPiezaRueda(piezaId = null) {
            const lado = window._ladoRuedaActual;
            const opciones = lado === 'delantera' ? PIEZAS_DELANTERA : PIEZAS_TRASERA;
            window._editandoPiezaRuedaId = piezaId;

            // Poblar select de tipo
            const sel = document.getElementById('pieza-rueda-tipo');
            sel.innerHTML = '<option value="">-- Selecciona tipo --</option>';
            opciones.forEach(o => sel.add(new Option(o, o)));

            // Mostrar/ocultar peso y n¬∫ radios seg√∫n tipo seleccionado
            sel.onchange = () => {
                const conPeso = PIEZAS_CON_PESO.includes(sel.value);
                document.getElementById('pieza-rueda-peso-group').style.display = conPeso ? 'block' : 'none';
                document.getElementById('pieza-rueda-numradios-group').style.display = sel.value === 'Radios/Niples' ? 'block' : 'none';
            };

            const rueda = juegosRuedasActual.ruedas[lado];
            const pieza = piezaId ? (rueda.piezas || []).find(p => p.id === piezaId) : null;

            document.getElementById('modal-pieza-rueda-titulo').textContent = pieza ? 'Editar pieza' : 'A√±adir pieza';

            if (pieza) {
                sel.value = pieza.tipo;
                sel.onchange(); // trigger visibility
                document.getElementById('pieza-rueda-marca-select').value = pieza.marca || '';
                document.getElementById('pieza-rueda-modelo').value = pieza.modelo || '';
                document.getElementById('pieza-rueda-material').value = pieza.material || '';
                document.getElementById('pieza-rueda-peso').value = pieza.peso || '';
                document.getElementById('pieza-rueda-numradios').value = pieza.numRadios || '';
                document.getElementById('pieza-rueda-precio').value = pieza.precio || '';
                document.getElementById('pieza-rueda-fecha').value = pieza.fechaInstalacion || '';
                document.getElementById('pieza-rueda-km').value = pieza.kmInstalacion || 0;
            } else {
                const marcaRueda = rueda ? (rueda.marca || '') : '';
                const selMarca = document.getElementById('pieza-rueda-marca-select');
                const optExists = Array.from(selMarca.options).some(o => o.value === marcaRueda);
                selMarca.value = optExists ? marcaRueda : (marcaRueda ? '' : '');
                document.getElementById('pieza-rueda-modelo').value = rueda ? (rueda.modelo || '') : '';
                document.getElementById('pieza-rueda-material').value = rueda ? (rueda.material || '') : '';
                document.getElementById('pieza-rueda-peso').value = '';
                document.getElementById('pieza-rueda-numradios').value = '';
                document.getElementById('pieza-rueda-precio').value = '';
                document.getElementById('pieza-rueda-fecha').value = rueda ? (rueda.fechaInstalacion || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0];
                document.getElementById('pieza-rueda-km').value = rueda ? (rueda.kmInstalacion || 0) : (biciActual.kmTotales || 0);
                document.getElementById('pieza-rueda-peso-group').style.display = 'none';
                document.getElementById('pieza-rueda-numradios-group').style.display = 'none';
            }
            abrirModal('modal-pieza-rueda');
        }

        function guardarPiezaRueda() {
            const lado = window._ladoRuedaActual;
            const tipo = document.getElementById('pieza-rueda-tipo').value;
            const marca = document.getElementById('pieza-rueda-marca-select').value;
            const modelo = document.getElementById('pieza-rueda-modelo').value.trim();
            const material = document.getElementById('pieza-rueda-material').value;
            const peso = PIEZAS_CON_PESO.includes(tipo) ? (parseFloat(document.getElementById('pieza-rueda-peso').value) || 0) : null;
            const numRadios = tipo === 'Radios/Niples' ? (parseInt(document.getElementById('pieza-rueda-numradios').value) || null) : null;
            const precio = parseFloat(document.getElementById('pieza-rueda-precio').value) || 0;
            const fecha = document.getElementById('pieza-rueda-fecha').value;
            const km = parseFloat(document.getElementById('pieza-rueda-km').value) || 0;

            if (!tipo) { mostrarNotificacion('Selecciona el tipo de pieza', 'error'); return; }
            if (!marca) { mostrarNotificacion('Indica la marca', 'error'); return; }

            const rueda = juegosRuedasActual.ruedas[lado];
            if (!rueda.piezas) rueda.piezas = [];

            if (window._editandoPiezaRuedaId) {
                const pieza = rueda.piezas.find(p => p.id === window._editandoPiezaRuedaId);
                if (pieza) { pieza.tipo = tipo; pieza.marca = marca; pieza.modelo = modelo; pieza.material = material; pieza.peso = peso; pieza.numRadios = numRadios; pieza.precio = precio; pieza.fechaInstalacion = fecha; pieza.kmInstalacion = km; }
            } else {
                rueda.piezas.push({ id: Date.now().toString(), tipo, marca, modelo, material, peso, numRadios, precio, fechaInstalacion: fecha, kmInstalacion: km });
            }

            guardarDatosUsuario();
            cerrarModal('modal-pieza-rueda');
            cargarDespieceRueda();
            cargarDetalleJuegoRuedas();
            mostrarNotificacion('Pieza guardada ‚úÖ', 'exito');
        }

        function editarPiezaRueda(piezaId) { abrirModalPiezaRueda(piezaId); }

        function repararPiezaRueda(piezaId) {
            const lado = window._ladoRuedaActual;
            const rueda = juegosRuedasActual.ruedas[lado];
            const pieza = (rueda.piezas || []).find(p => p.id === piezaId);
            if (!pieza) return;
            window._repararPiezaRuedaId = piezaId;
            window._repararModoRueda = false;
            window._repararModoPiezaRueda = true;
            document.getElementById('reparar-componente-nombre').textContent = `${pieza.tipo} ¬∑ ${pieza.marca} ${pieza.modelo || ''}`;
            document.getElementById('reparar-descripcion').value = '';
            document.getElementById('reparar-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('reparar-km').value = biciActual.kmTotales || 0;
            document.getElementById('reparar-coste').value = '';
            abrirModal('modal-reparar');
        }

        function sustituirPiezaRueda(piezaId) {
            const lado = window._ladoRuedaActual;
            const rueda = juegosRuedasActual.ruedas[lado];
            const pieza = (rueda.piezas || []).find(p => p.id === piezaId);
            if (!pieza) return;
            window._sustituirPiezaRuedaId = piezaId;
            window._sustituirModoPiezaRueda = true;

            document.getElementById('sustituir-componente-viejo').textContent = `${pieza.marca} ${pieza.modelo || ''}`;
            document.getElementById('sustituir-km-instalacion').textContent = pieza.kmInstalacion || '0';
            document.getElementById('sustituir-km-actual').textContent = biciActual.kmTotales || '0';
            const durKm = (biciActual.kmTotales || 0) - (pieza.kmInstalacion || 0);
            document.getElementById('sustituir-duracion-km').textContent = durKm;

            document.getElementById('sustituir-marca').value = pieza.marca || '';
            document.getElementById('sustituir-modelo').value = pieza.modelo || '';
            document.getElementById('sustituir-material').value = pieza.material || '';
            document.getElementById('sustituir-peso').value = pieza.peso || '';
            document.getElementById('sustituir-precio').value = '';
            document.getElementById('sustituir-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('sustituir-km').value = biciActual.kmTotales || 0;
            document.getElementById('sustituir-campos-extra').innerHTML = '';

            abrirModal('modal-sustituir');
        }

        function eliminarPiezaRueda(piezaId) {
            confirmar('¬øEliminar pieza?', 'Esta acci√≥n no se puede deshacer.',
                async () => {
                    const rueda = juegosRuedasActual.ruedas[window._ladoRuedaActual];
                    rueda.piezas = rueda.piezas.filter(p => p.id !== piezaId);
                    await guardarDatosUsuario();
                    cargarDespieceRueda();
                    cargarDetalleJuegoRuedas();
                    mostrarNotificacion('Pieza eliminada', 'info');
                }
            );
        }

        // ========================================
        // DESGLOSE PESO E INVERSI√ìN
        // ========================================
        function _crearTarjetaDesglose(titulo, items, total, unidad, color) {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginBottom = '12px';
            const unidadTotal = unidad === 'g' ? `${(total/1000).toFixed(2)} kg` : `${parseFloat(total).toFixed(2)}‚Ç¨`;
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="font-weight:700; font-size:1em;">${titulo}</div>
                    <div style="font-weight:700; color:${color};">${unidadTotal}</div>
                </div>
                ${items.map(i => `
                    <div style="display:flex; justify-content:space-between; font-size:0.85em; padding:5px 0; border-top:1px solid var(--border);">
                        <span style="color:var(--text-dark);">${i.nombre}</span>
                        <span style="color:${color}; font-weight:600;">${unidad === 'g' ? i.valor + 'g' : parseFloat(i.valor).toFixed(2) + '‚Ç¨'}</span>
                    </div>`).join('')}
            `;
            return card;
        }

        function cargarDesglosePeso() {
            const container = document.getElementById('contenido-desglose-peso');
            container.innerHTML = '';
            let totalGeneral = 0;
            const secciones = SECCIONES_COMPONENTES[biciActual.disciplina] || SECCIONES_COMPONENTES['Carretera'];

            secciones.filter(s => s !== 'Ruedas').forEach(seccion => {
                const comps = (biciActual.componentesV2 && biciActual.componentesV2[seccion]) || [];
                const items = [];
                comps.forEach(comp => {
                    if (comp.peso) items.push({ nombre: `${comp.tipo} ¬∑ ${comp.marca}`, valor: comp.peso });
                    if (comp.subpiezas) Object.values(comp.subpiezas).forEach(sub => {
                        if (sub.peso) items.push({ nombre: `${sub.tipo} ¬∑ ${sub.marca}`, valor: sub.peso });
                    });
                });
                if (items.length === 0) return;
                const totalSeccion = items.reduce((s, i) => s + i.valor, 0);
                totalGeneral += totalSeccion;
                container.appendChild(_crearTarjetaDesglose(seccion, items, totalSeccion, 'g', 'var(--secondary)'));
            });

            // Ruedas ‚Äî juego activo
            const juegoActivo = (biciActual.juegosRuedas || []).find(j => j.activo && !j.retirado);
            if (juegoActivo && juegoActivo.ruedas) {
                const items = [];
                Object.entries(juegoActivo.ruedas).forEach(([lado, rueda]) => {
                    if (rueda.peso) items.push({ nombre: `Rueda ${lado} ¬∑ ${rueda.marca}`, valor: rueda.peso });
                    (rueda.piezas || []).forEach(p => {
                        if (p.peso) items.push({ nombre: `${p.tipo} ${lado} ¬∑ ${p.marca}`, valor: p.peso });
                    });
                });
                if (items.length > 0) {
                    const totalSeccion = items.reduce((s, i) => s + i.valor, 0);
                    totalGeneral += totalSeccion;
                    container.appendChild(_crearTarjetaDesglose('Ruedas', items, totalSeccion, 'g', 'var(--secondary)'));
                }
            }

            const totalDiv = document.createElement('div');
            totalDiv.className = 'card';
            totalDiv.style.cssText = 'margin-top:10px; background:var(--secondary); color:white;';
            totalDiv.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; font-weight:700; font-size:1.1em;">
                <span>TOTAL</span><span>${(totalGeneral/1000).toFixed(2)} kg</span></div>`;
            container.appendChild(totalDiv);
        }

        function cargarDesgloseInversion() {
            const container = document.getElementById('contenido-desglose-inversion');
            container.innerHTML = '';
            let totalGeneral = 0;
            const secciones = SECCIONES_COMPONENTES[biciActual.disciplina] || SECCIONES_COMPONENTES['Carretera'];

            secciones.filter(s => s !== 'Ruedas').forEach(seccion => {
                const comps = (biciActual.componentesV2 && biciActual.componentesV2[seccion]) || [];
                const items = [];
                comps.forEach(comp => {
                    if (comp.precio) items.push({ nombre: `${comp.tipo} ¬∑ ${comp.marca}`, valor: comp.precio });
                    if (comp.subpiezas) Object.values(comp.subpiezas).forEach(sub => {
                        if (sub.precio) items.push({ nombre: `${sub.tipo} ¬∑ ${sub.marca}`, valor: sub.precio });
                    });
                });
                if (items.length === 0) return;
                const totalSeccion = items.reduce((s, i) => s + i.valor, 0);
                totalGeneral += totalSeccion;
                container.appendChild(_crearTarjetaDesglose(seccion, items, totalSeccion, '‚Ç¨', 'var(--warning)'));
            });

            // Ruedas ‚Äî juego activo
            const juegoActivo = (biciActual.juegosRuedas || []).find(j => j.activo && !j.retirado);
            if (juegoActivo && juegoActivo.ruedas) {
                const items = [];
                Object.entries(juegoActivo.ruedas).forEach(([lado, rueda]) => {
                    if (rueda.precio) items.push({ nombre: `Rueda ${lado} ¬∑ ${rueda.marca}`, valor: rueda.precio });
                    (rueda.piezas || []).forEach(p => {
                        if (p.precio) items.push({ nombre: `${p.tipo} ${lado} ¬∑ ${p.marca}`, valor: p.precio });
                    });
                });
                if (items.length > 0) {
                    const totalSeccion = items.reduce((s, i) => s + i.valor, 0);
                    totalGeneral += totalSeccion;
                    container.appendChild(_crearTarjetaDesglose('Ruedas', items, totalSeccion, '‚Ç¨', 'var(--warning)'));
                }
            }

            // Historial ‚Äî sustituciones y mantenimientos con coste
            const historial = (biciActual.historial || []).filter(r => parseFloat(r.coste) > 0);
            if (historial.length > 0) {
                const items = historial.map(r => ({
                    nombre: `${r.tipo} ¬∑ ${r.componente || r.pieza || '-'} (${formatearFecha(r.fecha)})`,
                    valor: parseFloat(r.coste)
                }));
                const totalHistorial = items.reduce((s, i) => s + i.valor, 0);
                totalGeneral += totalHistorial;
                container.appendChild(_crearTarjetaDesglose('Historial', items, totalHistorial, '‚Ç¨', 'var(--warning)'));
            }

            const totalDiv = document.createElement('div');
            totalDiv.className = 'card';
            totalDiv.style.cssText = 'margin-top:10px; background:var(--warning); color:white;';
            totalDiv.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; font-weight:700; font-size:1.1em;">
                <span>TOTAL</span><span>${parseFloat(totalGeneral).toFixed(2)}‚Ç¨</span></div>`;
            container.appendChild(totalDiv);
        }
        function abrirSeccionComponentes(seccion) {
            seccionActual = seccion;
            document.getElementById('titulo-seccion-componentes').textContent = seccion;
            cargarListaComponentesSeccion();
            navegar('sec-lista-componentes-seccion');
        }
        
        // Cargar lista de componentes de una secci√≥n
        function cargarListaComponentesSeccion() {
            if (!biciActual || !seccionActual) return;
            
            const container = document.getElementById('lista-componentes-seccion');
            
            if (!biciActual.componentesV2) biciActual.componentesV2 = {};
            if (!biciActual.componentesV2[seccionActual]) biciActual.componentesV2[seccionActual] = [];
            
            const componentes = biciActual.componentesV2[seccionActual];
            
            if (componentes.length === 0) {
                container.innerHTML = '<div class="lista-vacia"><div class="lista-vacia-icon">üîß</div><p>No hay componentes</p></div>';
                return;
            }
            
            container.innerHTML = '';
            componentes.forEach(comp => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';
                card.onclick = () => abrirDetalleComponente(comp);
                
                const kmUso = (biciActual.kmTotales || 0) - (comp.kmInstalacion || 0);
                const diasUso = comp.fechaInstalacion ? Math.floor((new Date() - new Date(comp.fechaInstalacion)) / (1000*60*60*24)) : 0;
                
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${comp.tipo}</div>
                            <div class="card-subtitle">${comp.marca || '-'} ${comp.modelo || '-'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="badge badge-primary">${kmUso} km</div>
                            <div style="font-size: 0.75em; color: var(--text); margin-top: 5px;">${formatearDuracion(diasUso)}</div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Abrir detalle componente
        function abrirDetalleComponente(comp) {
            componenteActual = comp;
            
            document.getElementById('titulo-detalle-componente').textContent = comp.tipo;
            document.getElementById('detalle-comp-nombre').textContent = comp.tipo;
            document.getElementById('detalle-comp-marca').textContent = comp.marca || '-';
            document.getElementById('detalle-comp-modelo').textContent = comp.modelo || '-';
            document.getElementById('detalle-comp-material').textContent = comp.material || '-';
            document.getElementById('detalle-comp-peso').textContent = comp.peso ? `${comp.peso}g` : '-';
            document.getElementById('detalle-comp-km').textContent = comp.kmInstalacion || '0';
            
            const kmUso = (biciActual.kmTotales || 0) - (comp.kmInstalacion || 0);
            document.getElementById('detalle-comp-km-uso').textContent = `${kmUso} km`;
            
            document.getElementById('detalle-comp-fecha').textContent = formatearFecha(comp.fechaInstalacion);
            document.getElementById('detalle-comp-precio').textContent = comp.precio ? `${comp.precio}‚Ç¨` : '-';
            
            // Subpiezas
            if (SUBPIEZAS[comp.tipo]) {
                document.getElementById('subpiezas-container').style.display = 'block';
                cargarSubpiezas();
            } else {
                document.getElementById('subpiezas-container').style.display = 'none';
            }
            
            navegar('sec-detalle-componente');
        }
        
        // Cargar subpiezas
        function cargarSubpiezas() {
            const container = document.getElementById('lista-subpiezas');
            const tipos = SUBPIEZAS[componenteActual.tipo];
            
            if (!componenteActual.subpiezas) componenteActual.subpiezas = {};
            
            container.innerHTML = '';
            tipos.forEach(tipo => {
                const sub = componenteActual.subpiezas[tipo];
                const div = document.createElement('div');
                div.style.cssText = 'padding:10px;background:var(--light-gray);border-radius:8px;margin-bottom:10px;';
                
                if (sub) {
                    const kmUso = (biciActual.kmTotales || 0) - (sub.kmInstalacion || 0);
                    div.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:bold;">${tipo}</div>
                                <div style="font-size:0.85em;color:var(--text);">${sub.marca} ${sub.modelo} - ${kmUso} km</div>
                            </div>
                            <div style="display:flex;gap:10px;">
                                <button class="btn btn-secondary" style="padding:5px 10px;font-size:0.8em;" onclick="editarSubpieza('${tipo}')">‚úèÔ∏è</button>
                                <button class="btn btn-primary" style="padding:5px 10px;font-size:0.8em;" onclick="sustituirSubpieza('${tipo}')">üîÑ</button>
                            </div>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div><div style="font-weight:bold;">${tipo}</div><div style="font-size:0.85em;color:var(--text);">No instalado</div></div>
                            <button class="btn btn-primary" style="padding:5px 10px;font-size:0.8em;" onclick="editarSubpieza('${tipo}')">‚ûï</button>
                        </div>
                    `;
                }
                container.appendChild(div);
            });
        }
        
        // Modal nuevo componente
        function abrirModalNuevoComponente() {
            if (!seccionActual) return;
            
            modoEdicion = false;
            document.getElementById('modal-componente-titulo').textContent = 'Nuevo Componente';
            
            limpiarFormComponente();
            
            const select = document.getElementById('comp-tipo');
            select.innerHTML = '<option value="">-- Selecciona --</option>';
            const comps = COMPONENTES_POR_SECCION[seccionActual][biciActual.disciplina] || COMPONENTES_POR_SECCION[seccionActual]['todos'];
            comps.forEach(c => select.add(new Option(c, c)));
            
            select.onchange = () => actualizarCamposExtra();
            
            // Pre-rellenar con datos de compra de la bici
            document.getElementById('comp-km-instalacion').value = 0;
            document.getElementById('comp-fecha-instalacion').value = biciActual.fechaCompra || new Date().toISOString().split('T')[0];
            
            abrirModal('modal-componente');
        }
        
        // Limpiar formulario
        function limpiarFormComponente() {
            ['comp-tipo','comp-marca','comp-modelo','comp-material','comp-peso','comp-precio','comp-fecha-instalacion','comp-km-instalacion'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('comp-marca-otra-container').style.display = 'none';
            document.getElementById('comp-material-otro-container').style.display = 'none';
            document.getElementById('comp-campos-extra').innerHTML = '';
        }
        
        // Campos extra
        function actualizarCamposExtra() {
            const tipo = document.getElementById('comp-tipo').value;
            const container = document.getElementById('comp-campos-extra');
            container.innerHTML = ''; // Sin campos extra por ahora
        }
        
        // Guardar componente
        function guardarComponente() {
            const tipo = document.getElementById('comp-tipo').value.trim();
            let marca = document.getElementById('comp-marca').value;
            const modelo = document.getElementById('comp-modelo').value.trim();
            let material = document.getElementById('comp-material').value;
            const peso = parseFloat(document.getElementById('comp-peso').value) || 0;
            const precio = parseFloat(document.getElementById('comp-precio').value) || 0;
            const fecha = document.getElementById('comp-fecha-instalacion').value;
            const km = parseFloat(document.getElementById('comp-km-instalacion').value) || 0;
            
            if (!tipo) return mostrarNotificacion('Selecciona el tipo', 'error');
            
            if (marca === 'Otra') marca = document.getElementById('comp-marca-otra').value.trim() || 'Otra';
            if (material === 'Otro') material = document.getElementById('comp-material-otro').value.trim() || 'Otro';
            
            const comp = {
                id: modoEdicion ? componenteActual.id : Date.now().toString(),
                tipo, marca, modelo, material, peso, precio,
                fechaInstalacion: fecha,
                kmInstalacion: km
            };
            
            // Sin campos extra en componentes principales
            
            if (SUBPIEZAS[tipo]) comp.subpiezas = {};
            
            if (!biciActual.componentesV2) biciActual.componentesV2 = {};
            if (!biciActual.componentesV2[seccionActual]) biciActual.componentesV2[seccionActual] = [];
            
            if (modoEdicion) {
                const idx = biciActual.componentesV2[seccionActual].findIndex(c => c.id === componenteActual.id);
                if (idx !== -1) {
                    comp.subpiezas = biciActual.componentesV2[seccionActual][idx].subpiezas || {};
                    biciActual.componentesV2[seccionActual][idx] = comp;
                }
            } else {
                biciActual.componentesV2[seccionActual].push(comp);
                biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
            }
            
            guardarDatosUsuario();
            cargarListaComponentesSeccion();
            cargarTaller();
            cerrarModal('modal-componente');
            mostrarNotificacion(modoEdicion ? 'Actualizado' : 'A√±adido', 'exito');
        }
        
        // Editar componente
        function editarComponenteActual() {
            if (!componenteActual) return;
            
            modoEdicion = true;
            document.getElementById('modal-componente-titulo').textContent = 'Editar Componente';
            
            const select = document.getElementById('comp-tipo');
            select.innerHTML = '';
            const comps = COMPONENTES_POR_SECCION[seccionActual][biciActual.disciplina] || COMPONENTES_POR_SECCION[seccionActual]['todos'];
            comps.forEach(c => select.add(new Option(c, c)));
            
            select.value = componenteActual.tipo;
            document.getElementById('comp-marca').value = componenteActual.marca;
            document.getElementById('comp-modelo').value = componenteActual.modelo || '';
            document.getElementById('comp-material').value = componenteActual.material;
            document.getElementById('comp-peso').value = componenteActual.peso || '';
            document.getElementById('comp-precio').value = componenteActual.precio || '';
            document.getElementById('comp-fecha-instalacion').value = componenteActual.fechaInstalacion || '';
            document.getElementById('comp-km-instalacion').value = componenteActual.kmInstalacion || '';
            
            select.onchange = () => actualizarCamposExtra();
            actualizarCamposExtra();
            
            abrirModal('modal-componente');
        }
        
        // Reparar
        function repararComponenteActual() {
            if (!componenteActual) return;
            
            document.getElementById('reparar-componente-nombre').textContent = componenteActual.tipo;
            document.getElementById('reparar-descripcion').value = '';
            document.getElementById('reparar-lugar').value = 'Taller';
            document.getElementById('reparar-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('reparar-km').value = biciActual.kmTotales || 0;
            document.getElementById('reparar-coste').value = '';
            
            abrirModal('modal-reparar');
        }
        
        // Guardar reparaci√≥n
        function guardarReparacion() {
            const desc = document.getElementById('reparar-descripcion').value.trim();
            const lugar = document.getElementById('reparar-lugar').value;
            const fecha = document.getElementById('reparar-fecha').value;
            const km = parseFloat(document.getElementById('reparar-km').value) || 0;
            const coste = parseFloat(document.getElementById('reparar-coste').value) || 0;
            
            if (!desc) return mostrarNotificacion('A√±ade descripci√≥n', 'error');
            
            if (!biciActual.historial) biciActual.historial = [];

            if (window._repararModoPiezaRueda && window._repararPiezaRuedaId) {
                // Reparar pieza del despiece
                const lado = window._ladoRuedaActual;
                const rueda = juegosRuedasActual.ruedas[lado];
                const pieza = (rueda.piezas || []).find(p => p.id === window._repararPiezaRuedaId);
                biciActual.historial.unshift({
                    id: Date.now().toString(),
                    fecha, tipo: 'Reparaci√≥n',
                    componente: pieza ? `${pieza.tipo} (${lado})` : 'Pieza rueda',
                    descripcion: `${desc} (${lugar})`,
                    km, coste,
                    fechaCreacion: new Date().toISOString()
                });
                window._repararModoPiezaRueda = false;
                window._repararPiezaRuedaId = null;
            } else if (window._repararModoRueda && window._repararRuedaLado) {
                // Reparar rueda completa
                biciActual.historial.unshift({
                    id: Date.now().toString(),
                    fecha, tipo: 'Reparaci√≥n',
                    componente: `Rueda ${window._repararRuedaLado}`,
                    descripcion: `${desc} (${lugar})`,
                    km, coste,
                    fechaCreacion: new Date().toISOString()
                });
                window._repararModoRueda = false;
            } else {
                // Reparar componente normal
                biciActual.historial.unshift({
                    id: Date.now().toString(),
                    fecha, tipo: 'Reparaci√≥n',
                    componente: componenteActual.tipo,
                    descripcion: `${desc} (${lugar})`,
                    km, coste,
                    fechaCreacion: new Date().toISOString()
                });
            }
            
            guardarDatosUsuario();
            cerrarModal('modal-reparar');
            mostrarNotificacion('Reparaci√≥n registrada', 'exito');
        }
        
        // Sustituir
        function sustituirComponenteActual() {
            if (!componenteActual) return;
            
            document.getElementById('sustituir-componente-viejo').textContent = `${componenteActual.marca} ${componenteActual.modelo}`;
            document.getElementById('sustituir-km-instalacion').textContent = componenteActual.kmInstalacion || '0';
            document.getElementById('sustituir-km-actual').textContent = biciActual.kmTotales || '0';
            const durKm = (biciActual.kmTotales || 0) - (componenteActual.kmInstalacion || 0);
            document.getElementById('sustituir-duracion-km').textContent = durKm;
            
            // Pre-rellenar con datos del viejo
            document.getElementById('sustituir-marca').value = componenteActual.marca;
            document.getElementById('sustituir-modelo').value = componenteActual.modelo || '';
            document.getElementById('sustituir-material').value = componenteActual.material;
            document.getElementById('sustituir-peso').value = componenteActual.peso || '';
            document.getElementById('sustituir-precio').value = '';
            document.getElementById('sustituir-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('sustituir-km').value = biciActual.kmTotales || 0;
            document.getElementById('sustituir-campos-extra').innerHTML = '';
            
            abrirModal('modal-sustituir');
        }
        
        // Guardar sustituci√≥n
        function guardarSustitucion(destinoViejo) {
            let marca = document.getElementById('sustituir-marca').value;
            const modelo = document.getElementById('sustituir-modelo').value.trim();
            let material = document.getElementById('sustituir-material').value;
            const peso = parseFloat(document.getElementById('sustituir-peso').value) || 0;
            const precio = parseFloat(document.getElementById('sustituir-precio').value) || 0;
            const fecha = document.getElementById('sustituir-fecha').value;
            const kmSustitucion = parseFloat(document.getElementById('sustituir-km').value) || 0;
            
            if (marca === 'Otra') marca = document.getElementById('sustituir-marca-otra').value.trim() || 'Otra';
            if (material === 'Otro') material = document.getElementById('sustituir-material-otro').value.trim() || 'Otro';

            // MODO: Sustituir pieza del despiece de rueda
            if (window._sustituirModoPiezaRueda && window._sustituirPiezaRuedaId) {
                const lado = window._ladoRuedaActual;
                const rueda = juegosRuedasActual.ruedas[lado];
                const pieza = (rueda.piezas || []).find(p => p.id === window._sustituirPiezaRuedaId);
                if (!pieza) return;

                const durKm = kmSustitucion - (pieza.kmInstalacion || 0);
                const diasUso = pieza.fechaInstalacion ? Math.floor((new Date(fecha) - new Date(pieza.fechaInstalacion)) / 86400000) : 0;

                if (!biciActual.historial) biciActual.historial = [];
                biciActual.historial.unshift({
                    id: Date.now().toString(),
                    fecha, tipo: 'Sustituci√≥n',
                    componente: `${pieza.tipo} (${lado})`,
                    descripcion: `${pieza.marca} ${pieza.modelo || ''} ‚Üí ${marca} ${modelo}`,
                    km: kmSustitucion, coste: precio,
                    duracionKm: durKm, duracionDias: diasUso,
                    fechaCreacion: new Date().toISOString()
                });

                pieza.marca = marca;
                pieza.modelo = modelo;
                pieza.material = material;
                pieza.peso = peso;
                pieza.precio = precio;
                pieza.fechaInstalacion = fecha;
                pieza.kmInstalacion = kmSustitucion;

                biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
                window._sustituirModoPiezaRueda = false;
                window._sustituirPiezaRuedaId = null;

                guardarDatosUsuario();
                cerrarModal('modal-sustituir');
                cargarDespieceRueda();
                mostrarNotificacion('Pieza sustituida ‚úÖ', 'exito');
                return;
            }

            // MODO: Sustituir componente normal
            const kmViejo = componenteActual.kmInstalacion || 0;
            const durKm = kmSustitucion - kmViejo;
            const diasUso = componenteActual.fechaInstalacion ? Math.floor((new Date(fecha) - new Date(componenteActual.fechaInstalacion)) / 86400000) : 0;
            
            if (destinoViejo === 'cajon') {
                if (!biciActual.cajonPiezas) biciActual.cajonPiezas = [];
                biciActual.cajonPiezas.push({
                    id: Date.now().toString(),
                    tipo: componenteActual.tipo,
                    marca: componenteActual.marca,
                    modelo: componenteActual.modelo || '',
                    material: componenteActual.material,
                    peso: componenteActual.peso,
                    precio: componenteActual.precio,
                    fechaInstalacion: componenteActual.fechaInstalacion,
                    kmInstalacion: componenteActual.kmInstalacion,
                    subpiezas: componenteActual.subpiezas,
                    seccion: seccionActual,
                    fechaRetiro: new Date().toISOString(),
                    kmAlRetirar: kmSustitucion,
                    diasUso: diasUso
                });
            } else {
                if (!biciActual.historial) biciActual.historial = [];
                biciActual.historial.unshift({
                    id: Date.now().toString(),
                    fecha, tipo: 'Sustituci√≥n',
                    componente: componenteActual.tipo,
                    descripcion: `${componenteActual.marca} ${componenteActual.modelo} ‚Üí ${marca} ${modelo}`,
                    km: kmSustitucion, coste: precio,
                    duracionKm: durKm, duracionDias: diasUso,
                    fechaCreacion: new Date().toISOString()
                });
            }
            
            componenteActual.marca = marca;
            componenteActual.modelo = modelo;
            componenteActual.material = material;
            componenteActual.peso = peso;
            componenteActual.precio = precio;
            componenteActual.fechaInstalacion = fecha;
            componenteActual.kmInstalacion = kmSustitucion;
            
            if (SUBPIEZAS[componenteActual.tipo]) componenteActual.subpiezas = {};
            
            biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
            
            guardarDatosUsuario();
            cerrarModal('modal-sustituir');
            actualizarBotonCajon();
            abrirDetalleComponente(componenteActual);
            mostrarNotificacion(destinoViejo === 'cajon' ? 'Pieza guardada en el caj√≥n üì¶' : 'Sustituido ‚úÖ', 'exito');
        }
        
        // Eliminar componente actual
        function eliminarComponenteActual() {
            if (!componenteActual) return;
            confirmar(
                '¬øEliminar componente?',
                `¬øEst√°s seguro de eliminar "${componenteActual.marca} ${componenteActual.modelo}"? Esta acci√≥n no se puede deshacer.`,
                async () => {
                    biciActual.componentesV2[seccionActual] = biciActual.componentesV2[seccionActual].filter(c => c.id !== componenteActual.id);
                    await guardarDatosUsuario();
                    mostrarNotificacion('Componente eliminado', 'info');
                    navegar('sec-lista-componentes-seccion');
                }
            );
        }

        // Retirar componente al caj√≥n sin sustituir
        function retirarComponenteActual() {
            if (!componenteActual) return;
            confirmar(
                '¬øRetirar al caj√≥n?',
                `"${componenteActual.marca} ${componenteActual.modelo || ''}" se guardar√° en el caj√≥n de piezas con sus km y tiempo acumulados. No se instalar√° ning√∫n componente en su lugar.`,
                async () => {
                    const kmUso = (biciActual.kmTotales || 0) - (componenteActual.kmInstalacion || 0);
                    const diasUso = componenteActual.fechaInstalacion
                        ? Math.floor((new Date() - new Date(componenteActual.fechaInstalacion)) / 86400000) : 0;
                    if (!biciActual.cajonPiezas) biciActual.cajonPiezas = [];
                    biciActual.cajonPiezas.push({
                        id: Date.now().toString(),
                        tipo: componenteActual.tipo,
                        marca: componenteActual.marca,
                        modelo: componenteActual.modelo || '',
                        material: componenteActual.material,
                        peso: componenteActual.peso,
                        precio: componenteActual.precio,
                        fechaInstalacion: componenteActual.fechaInstalacion,
                        kmInstalacion: componenteActual.kmInstalacion,
                        subpiezas: componenteActual.subpiezas,
                        seccion: seccionActual,
                        fechaRetiro: new Date().toISOString(),
                        kmAlRetirar: biciActual.kmTotales || 0,
                        diasUso: diasUso
                    });
                    biciActual.componentesV2[seccionActual] = biciActual.componentesV2[seccionActual].filter(c => c.id !== componenteActual.id);
                    await guardarDatosUsuario();
                    actualizarBotonCajon();
                    mostrarNotificacion('Pieza guardada en el caj√≥n üì¶', 'info');
                    navegar('sec-lista-componentes-seccion');
                }
            );
        }

        // ========================================
        // CAJ√ìN DE PIEZAS
        // ========================================
        function actualizarBotonCajon() {
            if (!biciActual) return;
            const cajon = biciActual.cajonPiezas || [];
            const btn = document.getElementById('btn-ver-cajon');
            const count = document.getElementById('cajon-count');
            if (btn) {
                btn.style.display = cajon.length > 0 ? 'block' : 'none';
                if (count) count.textContent = cajon.length;
            }
        }

        function cargarCajonPiezas() {
            if (!biciActual) return;
            if (!biciActual.cajonPiezas) biciActual.cajonPiezas = [];
            const container = document.getElementById('lista-cajon-piezas');
            if (biciActual.cajonPiezas.length === 0) {
                container.innerHTML = `<div class="lista-vacia"><div class="lista-vacia-icon">üì¶</div><p>El caj√≥n est√° vac√≠o</p></div>`;
                return;
            }
            container.innerHTML = '';
            biciActual.cajonPiezas.forEach(pieza => {
                const kmUso = (pieza.kmAlRetirar || 0) - (pieza.kmInstalacion || 0);
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <div>
                            <div class="card-title">${pieza.tipo}</div>
                            <div class="card-subtitle">${pieza.marca} ${pieza.modelo || ''}</div>
                            <div class="text-muted" style="font-size:0.75em; margin-top:3px;">Secci√≥n: ${pieza.seccion} ¬∑ Retirado: ${formatearFecha(pieza.fechaRetiro)}</div>
                        </div>
                        <span class="badge" style="background:#e0e0e0;color:#666;">üì¶</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                        <div style="text-align:center; padding:8px; background:var(--light-gray); border-radius:8px;">
                            <div style="font-size:0.75em; color:var(--text); font-weight:600;">KM ACUMULADOS</div>
                            <div style="font-size:1.2em; font-weight:700; color:var(--primary);">${Math.max(0, kmUso)}</div>
                        </div>
                        <div style="text-align:center; padding:8px; background:var(--light-gray); border-radius:8px;">
                            <div style="font-size:0.75em; color:var(--text); font-weight:600;">TIEMPO USO</div>
                            <div style="font-size:1.2em; font-weight:700; color:var(--secondary);">${formatearDuracion(pieza.diasUso || 0)}</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="btn btn-primary" style="flex:1; padding:8px; font-size:0.85em;" title="Reinstalar este componente" onclick="reinstalarPieza('${pieza.id}')">‚ö° Reinstalar</button>
                        <button class="btn btn-danger" style="flex:1; padding:8px; font-size:0.85em;" title="Eliminar definitivamente" onclick="eliminarPiezaCajon('${pieza.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function reinstalarPieza(piezaId) {
            if (!biciActual.cajonPiezas) return;
            const pieza = biciActual.cajonPiezas.find(p => p.id === piezaId);
            if (!pieza) return;

            // Buscar si hay un componente activo del mismo tipo en esa secci√≥n
            if (!biciActual.componentesV2) biciActual.componentesV2 = {};
            if (!biciActual.componentesV2[pieza.seccion]) biciActual.componentesV2[pieza.seccion] = [];
            const compsSeccion = biciActual.componentesV2[pieza.seccion];
            const compActivo = compsSeccion.find(c => c.tipo === pieza.tipo);

            const mensajeActivo = compActivo
                ? `"${compActivo.marca} ${compActivo.modelo || ''}" (en uso actualmente) se enviar√° al caj√≥n conservando sus datos.`
                : '';

            confirmar(
                '¬øReinstalar componente?',
                `"${pieza.marca} ${pieza.modelo || ''}" se instalar√° en ${pieza.seccion} con los km y fecha actuales. ${mensajeActivo} ¬øConfirmar?`,
                async () => {
                    // Si hay componente activo del mismo tipo, mandarlo al caj√≥n
                    if (compActivo) {
                        const kmUsoActivo = (biciActual.kmTotales || 0) - (compActivo.kmInstalacion || 0);
                        const diasUsoActivo = compActivo.fechaInstalacion
                            ? Math.floor((new Date() - new Date(compActivo.fechaInstalacion)) / 86400000) : 0;
                        if (!biciActual.cajonPiezas) biciActual.cajonPiezas = [];
                        biciActual.cajonPiezas.push({
                            id: Date.now().toString(),
                            ...compActivo,
                            seccion: pieza.seccion,
                            fechaRetiro: new Date().toISOString(),
                            kmAlRetirar: biciActual.kmTotales || 0,
                            diasUso: diasUsoActivo
                        });
                        biciActual.componentesV2[pieza.seccion] = compsSeccion.filter(c => c.id !== compActivo.id);
                    }
                    // Reinstalar la pieza del caj√≥n con km y fecha actuales
                    const nuevaInstalacion = {
                        ...pieza,
                        id: Date.now().toString() + '1',
                        fechaInstalacion: new Date().toISOString().split('T')[0],
                        kmInstalacion: biciActual.kmTotales || 0,
                        fechaRetiro: undefined,
                        kmAlRetirar: undefined,
                        diasUso: undefined,
                        seccion: undefined
                    };
                    biciActual.componentesV2[pieza.seccion].push(nuevaInstalacion);
                    // Eliminar del caj√≥n
                    biciActual.cajonPiezas = biciActual.cajonPiezas.filter(p => p.id !== piezaId);
                    await guardarDatosUsuario();
                    cargarCajonPiezas();
                    actualizarBotonCajon();
                    mostrarNotificacion(`"${pieza.marca} ${pieza.modelo || ''}" reinstalado ‚úÖ`, 'exito');
                }
            );
        }

        function eliminarPiezaCajon(piezaId) {
            confirmar(
                '¬øEliminar definitivamente?',
                '¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.',
                async () => {
                    biciActual.cajonPiezas = biciActual.cajonPiezas.filter(p => p.id !== piezaId);
                    await guardarDatosUsuario();
                    cargarCajonPiezas();
                    actualizarBotonCajon();
                    mostrarNotificacion('Pieza eliminada', 'info');
                }
            );
        }

        // Volver
        function volverAListaComponentes() {
            navegar('sec-lista-componentes-seccion');
        }
        
        // Subpiezas (placeholder)
        // Variables para subpiezas
        let subpiezaTipo = null;
        let modoSubpieza = 'a√±adir'; // 'a√±adir', 'editar', 'sustituir'
        
        // Editar/A√±adir subpieza
        function editarSubpieza(tipo) {
            if (!componenteActual) return;
            
            subpiezaTipo = tipo;
            const subpiezaExiste = componenteActual.subpiezas && componenteActual.subpiezas[tipo];
            
            modoSubpieza = subpiezaExiste ? 'editar' : 'a√±adir';
            document.getElementById('modal-subpieza-titulo').textContent = subpiezaExiste ? `Editar ${tipo}` : `A√±adir ${tipo}`;
            document.getElementById('modal-subpieza-subtitulo').textContent = `${componenteActual.tipo}`;
            
            // Mostrar datos heredados
            document.getElementById('subpieza-heredada-marca').textContent = componenteActual.marca || '-';
            document.getElementById('subpieza-heredada-modelo').textContent = componenteActual.modelo || '-';
            document.getElementById('subpieza-heredada-material').textContent = componenteActual.material || '-';
            document.getElementById('subpieza-heredada-fecha').textContent = formatearFecha(componenteActual.fechaInstalacion);
            document.getElementById('subpieza-heredada-km').textContent = componenteActual.kmInstalacion || '0';
            
            // Pre-rellenar con datos heredados o existentes
            if (subpiezaExiste) {
                const sub = componenteActual.subpiezas[tipo];
                document.getElementById('subpieza-marca').value = sub.marca;
                document.getElementById('subpieza-modelo').value = sub.modelo || '';
                document.getElementById('subpieza-material').value = sub.material;
                document.getElementById('subpieza-peso').value = sub.peso || '';
                document.getElementById('subpieza-precio').value = sub.precio || '';
                document.getElementById('subpieza-fecha').value = sub.fechaInstalacion || '';
                document.getElementById('subpieza-km').value = sub.kmInstalacion || '';
            } else {
                // Heredar del padre
                document.getElementById('subpieza-marca').value = componenteActual.marca;
                document.getElementById('subpieza-modelo').value = componenteActual.modelo || '';
                document.getElementById('subpieza-material').value = componenteActual.material;
                document.getElementById('subpieza-peso').value = '';
                document.getElementById('subpieza-precio').value = '';
                document.getElementById('subpieza-fecha').value = componenteActual.fechaInstalacion || '';
                document.getElementById('subpieza-km').value = componenteActual.kmInstalacion || '';
            }
            
            // Campos espec√≠ficos
            actualizarCamposEspecificosSubpieza(tipo, subpiezaExiste);
            
            abrirModal('modal-subpieza');
        }
        
        // Sustituir subpieza
        function sustituirSubpieza(tipo) {
            if (!componenteActual) return;
            
            subpiezaTipo = tipo;
            modoSubpieza = 'sustituir';
            
            document.getElementById('modal-subpieza-titulo').textContent = `Sustituir ${tipo}`;
            document.getElementById('modal-subpieza-subtitulo').textContent = `${componenteActual.tipo}`;
            
            const subActual = componenteActual.subpiezas[tipo];
            
            // Mostrar datos del componente padre (heredados)
            document.getElementById('subpieza-heredada-marca').textContent = componenteActual.marca || '-';
            document.getElementById('subpieza-heredada-modelo').textContent = componenteActual.modelo || '-';
            document.getElementById('subpieza-heredada-material').textContent = componenteActual.material || '-';
            document.getElementById('subpieza-heredada-fecha').textContent = formatearFecha(componenteActual.fechaInstalacion);
            document.getElementById('subpieza-heredada-km').textContent = componenteActual.kmInstalacion || '0';
            
            // Pre-rellenar con datos de la subpieza actual
            document.getElementById('subpieza-marca').value = subActual.marca;
            document.getElementById('subpieza-modelo').value = subActual.modelo || '';
            document.getElementById('subpieza-material').value = subActual.material;
            document.getElementById('subpieza-peso').value = subActual.peso || '';
            document.getElementById('subpieza-precio').value = '';
            document.getElementById('subpieza-fecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('subpieza-km').value = biciActual.kmTotales || 0;
            
            actualizarCamposEspecificosSubpieza(tipo, true);
            
            abrirModal('modal-subpieza');
        }
        
        // Actualizar campos espec√≠ficos seg√∫n tipo de subpieza
        function actualizarCamposEspecificosSubpieza(tipo, existente) {
            const container = document.getElementById('subpieza-campos-especificos');
            container.innerHTML = '';
            
            if (tipo === 'Roldanas') {
                const sub = existente && componenteActual.subpiezas[tipo];
                container.innerHTML = `
                    <div class="form-group"><label>Dientes Roldana Superior</label><input type="number" id="subpieza-dientes-sup" value="${sub?.dientesSup || 11}" step="1"></div>
                    <div class="form-group"><label>Dientes Roldana Inferior</label><input type="number" id="subpieza-dientes-inf" value="${sub?.dientesInf || 11}" step="1"></div>
                `;
            } else if (tipo.includes('Plato')) {
                const sub = existente && componenteActual.subpiezas[tipo];
                container.innerHTML = `
                    <div class="form-group"><label>N√∫mero de Dientes</label><input type="number" id="subpieza-num-dientes" value="${sub?.numDientes || 50}" step="1"></div>
                `;
            }
        }
        
        // Guardar subpieza
        function guardarSubpieza() {
            if (!componenteActual || !subpiezaTipo) return;
            
            let marca = document.getElementById('subpieza-marca').value;
            const modelo = document.getElementById('subpieza-modelo').value.trim();
            let material = document.getElementById('subpieza-material').value;
            const peso = parseFloat(document.getElementById('subpieza-peso').value) || 0;
            const precio = parseFloat(document.getElementById('subpieza-precio').value) || 0;
            const fecha = document.getElementById('subpieza-fecha').value;
            const km = parseFloat(document.getElementById('subpieza-km').value) || 0;
            
            if (marca === 'Otra') marca = document.getElementById('subpieza-marca-otra').value.trim() || 'Otra';
            if (material === 'Otro') material = document.getElementById('subpieza-material-otro').value.trim() || 'Otro';
            
            const subpieza = {
                tipo: subpiezaTipo,
                marca, modelo, material, peso, precio,
                fechaInstalacion: fecha,
                kmInstalacion: km
            };
            
            // Campos espec√≠ficos
            if (subpiezaTipo === 'Roldanas') {
                const sup = document.getElementById('subpieza-dientes-sup');
                const inf = document.getElementById('subpieza-dientes-inf');
                if (sup) subpieza.dientesSup = parseFloat(sup.value) || 0;
                if (inf) subpieza.dientesInf = parseFloat(inf.value) || 0;
            } else if (subpiezaTipo.includes('Plato')) {
                const dientes = document.getElementById('subpieza-num-dientes');
                if (dientes) subpieza.numDientes = parseFloat(dientes.value) || 0;
            }
            
            if (!componenteActual.subpiezas) componenteActual.subpiezas = {};
            
            // Si es sustituci√≥n, registrar en historial
            if (modoSubpieza === 'sustituir') {
                const subVieja = componenteActual.subpiezas[subpiezaTipo];
                const kmViejo = subVieja.kmInstalacion || 0;
                const durKm = km - kmViejo;
                const diasUso = subVieja.fechaInstalacion ? Math.floor((new Date(fecha) - new Date(subVieja.fechaInstalacion)) / 86400000) : 0;
                
                if (!biciActual.historial) biciActual.historial = [];
                biciActual.historial.unshift({
                    id: Date.now().toString(),
                    fecha, tipo: 'Sustituci√≥n',
                    componente: `${componenteActual.tipo} - ${subpiezaTipo}`,
                    descripcion: `${subVieja.marca} ${subVieja.modelo} ‚Üí ${marca} ${modelo}`,
                    km, coste: precio,
                    duracionKm: durKm, duracionDias: diasUso,
                    fechaCreacion: new Date().toISOString()
                });
                
                biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
            } else if (modoSubpieza === 'a√±adir') {
                biciActual.inversion = (parseFloat(biciActual.inversion || 0) + precio).toFixed(2);
            }
            
            componenteActual.subpiezas[subpiezaTipo] = subpieza;
            
            guardarDatosUsuario();
            cerrarModal('modal-subpieza');
            abrirDetalleComponente(componenteActual);
            mostrarNotificacion(modoSubpieza === 'sustituir' ? 'Sustituida' : modoSubpieza === 'editar' ? 'Actualizada' : 'A√±adida', 'exito');
        }
        
        // Listeners para "Otra" marca
        window.addEventListener('load', () => {
            const marcaComp = document.getElementById('comp-marca');
            if (marcaComp) marcaComp.addEventListener('change', e => {
                document.getElementById('comp-marca-otra-container').style.display = e.target.value === 'Otra' ? 'block' : 'none';
            });
            
            const materialComp = document.getElementById('comp-material');
            if (materialComp) materialComp.addEventListener('change', e => {
                document.getElementById('comp-material-otro-container').style.display = e.target.value === 'Otro' ? 'block' : 'none';
            });
            
            const marcaSust = document.getElementById('sustituir-marca');
            if (marcaSust) marcaSust.addEventListener('change', e => {
                document.getElementById('sustituir-marca-otra-container').style.display = e.target.value === 'Otra' ? 'block' : 'none';
            });
            
            const materialSust = document.getElementById('sustituir-material');
            if (materialSust) materialSust.addEventListener('change', e => {
                document.getElementById('sustituir-material-otro-container').style.display = e.target.value === 'Otro' ? 'block' : 'none';
            });
            
            // Listeners para modal de subpieza
            const marcaSubpieza = document.getElementById('subpieza-marca');
            if (marcaSubpieza) marcaSubpieza.addEventListener('change', e => {
                document.getElementById('subpieza-marca-otra-container').style.display = e.target.value === 'Otra' ? 'block' : 'none';
            });
            
            const materialSubpieza = document.getElementById('subpieza-material');
            if (materialSubpieza) materialSubpieza.addEventListener('change', e => {
                document.getElementById('subpieza-material-otro-container').style.display = e.target.value === 'Otro' ? 'block' : 'none';
            });
        });

        // ========================================
        // GESTI√ìN DE HISTORIAL
        // ========================================
        function cargarHistorial() {
            const container = document.getElementById('lista-historial');
            
            if (!biciActual.historial || biciActual.historial.length === 0) {
                container.innerHTML = `
                    <div class="lista-vacia">
                        <div class="lista-vacia-icon">üìã</div>
                        <p>No hay registros de mantenimiento</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            biciActual.historial.forEach(reg => {
                const colorTipo = reg.tipo === 'Sustituci√≥n' ? 'var(--danger)' : 
                                 reg.tipo === 'Reparaci√≥n' ? 'var(--primary)' : 'var(--secondary)';
                
                const card = document.createElement('div');
                card.className = 'card';
                card.style.borderLeft = `4px solid ${colorTipo}`;
                
                let detalleExtra = '';
                if (reg.tipo === 'Sustituci√≥n' && reg.duracionKm !== undefined) {
                    const duracionFormateada = formatearDuracion(reg.duracionDias || 0);
                    detalleExtra = `<div class="text-muted">Dur√≥: <strong>${reg.duracionKm} km</strong> (${duracionFormateada})</div>`;
                } else {
                    detalleExtra = `<div class="text-muted">KM: <strong>${reg.km || reg.kmActuales || 0}</strong></div>`;
                }
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span class="badge" style="background: ${colorTipo}20; color: ${colorTipo}; font-weight: 600;">
                            ${reg.tipo}
                        </span>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span class="text-muted" style="font-weight: 600;">${formatearFecha(reg.fecha)}</span>
                            <button onclick="eliminarRegistroHistorial('${reg.id}')" style="background:none; border:none; cursor:pointer; font-size:1em; color:var(--danger); padding:0;" title="Eliminar">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="card-title" style="font-size: 1em;">${reg.componente || reg.pieza || '-'}</div>
                    <div class="card-subtitle">${reg.descripcion}</div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                        ${detalleExtra}
                        <div class="text-muted">Coste: <strong style="color: var(--warning);">${reg.coste || 0}‚Ç¨</strong></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function eliminarRegistroHistorial(id) {
            confirmar('¬øEliminar registro?', 'Esta acci√≥n no se puede deshacer.',
                async () => {
                    const reg = biciActual.historial.find(r => r.id === id);
                    if (reg) {
                        // Restar el coste de la inversi√≥n
                        const coste = parseFloat(reg.coste) || 0;
                        if (coste > 0) {
                            biciActual.inversion = Math.max(0, parseFloat(biciActual.inversion || 0) - coste).toFixed(2);
                        }
                        biciActual.historial = biciActual.historial.filter(r => r.id !== id);
                    }
                    await guardarDatosUsuario();
                    cargarHistorial();
                    cargarTaller();
                    mostrarNotificacion('Registro eliminado', 'info');
                }
            );
        }

        function abrirModalNuevoMantenimiento() {
            document.getElementById('mant-pieza').value = '';
            document.getElementById('mant-descripcion').value = '';
            document.getElementById('mant-coste').value = '';
            abrirModal('modal-mantenimiento');
        }

        function guardarMantenimiento() {
            const tipo = document.getElementById('mant-tipo').value;
            const pieza = document.getElementById('mant-pieza').value.trim();
            const descripcion = document.getElementById('mant-descripcion').value.trim();
            const coste = parseFloat(document.getElementById('mant-coste').value) || 0;

            if (!pieza || !descripcion) {
                mostrarNotificacion('Por favor, completa al menos la pieza y descripci√≥n', 'error');
                return;
            }

            const nuevoRegistro = {
                id: Date.now().toString(),
                tipo: tipo,
                pieza: pieza,
                descripcion: descripcion,
                coste: coste,
                kmActuales: biciActual.kmTotales,
                fecha: new Date().toLocaleDateString('es-ES')
            };

            biciActual.historial.unshift(nuevoRegistro);
            biciActual.inversion = (parseFloat(biciActual.inversion) + coste).toFixed(2);
            
            guardarDatosUsuario();
            cargarHistorial();
            cargarTaller();
            cerrarModal('modal-mantenimiento');
            mostrarNotificacion('Mantenimiento registrado correctamente', 'exito');
        }

        // ========================================
        // SISTEMA DE MODALES
        // ========================================
        function abrirModal(modalId) {
            document.getElementById(modalId).classList.add('activo');
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('activo');
        }

        // Cerrar modal al hacer clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('activo');
                }
            });
        });

        // ========================================
        // INTEGRACI√ìN CON STRAVA
        // ========================================
        
        // Conectar con Strava (inicia OAuth)
        function conectarStrava() {
            const scope = 'read,activity:read_all,profile:read_all';
            const authUrl = `${STRAVA_AUTH_URL}?client_id=${STRAVA_CLIENT_ID}&response_type=code&redirect_uri=${STRAVA_REDIRECT_URI}&approval_prompt=force&scope=${scope}&state=strava_auth`;
            window.location.href = authUrl;
        }

        // Desconectar Strava
        async function desconectarStrava() {
            confirmar(
                '¬øDesconectar Strava?',
                'Se eliminar√°n todas las vinculaciones de bicis con Strava.',
                async () => {
                    // Eliminar tokens y datos de Strava
                    delete datosUsuario.stravaAccessToken;
                    delete datosUsuario.stravaRefreshToken;
                    delete datosUsuario.stravaAtletaNombre;
                    delete datosUsuario.stravaTokenExpira;
                    
                    // Desvincular todas las bicis
                    datosUsuario.garaje.forEach(bici => {
                        delete bici.stravaBiciId;
                        delete bici.stravaBiciNombre;
                    });
                    
                    await guardarDatosUsuario();
                    mostrarNotificacion('Strava desconectado', 'info');
                    cargarPerfil();
                }
            );
        }

        // Procesar el c√≥digo de autorizaci√≥n de Strava
        async function procesarCallbackStrava(code) {
            try {
                document.getElementById('strava-desconectado').style.display = 'none';
                document.getElementById('strava-conectado').style.display = 'none';
                document.getElementById('strava-cargando').style.display = 'block';

                // Intercambiar c√≥digo por tokens
                const response = await fetch(`${STRAVA_TOKEN_URL}?client_id=${STRAVA_CLIENT_ID}&client_secret=${STRAVA_CLIENT_SECRET}&code=${code}&grant_type=authorization_code`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Error al obtener tokens de Strava');
                }

                const data = await response.json();

                // Guardar tokens en Firestore
                datosUsuario.stravaAccessToken = data.access_token;
                datosUsuario.stravaRefreshToken = data.refresh_token;
                datosUsuario.stravaTokenExpira = data.expires_at;
                datosUsuario.stravaAtletaNombre = data.athlete.firstname + ' ' + data.athlete.lastname;

                await guardarDatosUsuario();
                
                mostrarNotificacion('¬°Conectado con Strava!', 'exito');
                
                // Limpiar URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                cargarPerfil();
            } catch (error) {
                console.error('Error procesando callback de Strava:', error);
                mostrarNotificacion('Error al conectar con Strava', 'error');
                document.getElementById('strava-cargando').style.display = 'none';
                document.getElementById('strava-desconectado').style.display = 'block';
            }
        }

        // Renovar token de Strava si ha expirado
        async function renovarTokenStrava() {
            if (!datosUsuario.stravaRefreshToken) return false;

            const ahora = Math.floor(Date.now() / 1000);
            if (datosUsuario.stravaTokenExpira && ahora < datosUsuario.stravaTokenExpira) {
                return true; // Token todav√≠a v√°lido
            }

            try {
                const response = await fetch(`${STRAVA_TOKEN_URL}?client_id=${STRAVA_CLIENT_ID}&client_secret=${STRAVA_CLIENT_SECRET}&refresh_token=${datosUsuario.stravaRefreshToken}&grant_type=refresh_token`, {
                    method: 'POST'
                });

                if (!response.ok) return false;

                const data = await response.json();
                datosUsuario.stravaAccessToken = data.access_token;
                datosUsuario.stravaRefreshToken = data.refresh_token;
                datosUsuario.stravaTokenExpira = data.expires_at;

                await guardarDatosUsuario();
                return true;
            } catch (error) {
                console.error('Error renovando token:', error);
                return false;
            }
        }

        // Sincronizar km desde Strava
        async function sincronizarStravaManual() {
            if (!await renovarTokenStrava()) {
                mostrarNotificacion('Error: Token de Strava expirado. Reconecta tu cuenta.', 'error');
                return;
            }

            mostrarNotificacion('Sincronizando con Strava...', 'info');

            try {
                // Obtener actividades de los √∫ltimos 30 d√≠as
                const treintaDiasAtras = Math.floor((Date.now() - 30 * 24 * 60 * 60 * 1000) / 1000);
                const response = await fetch(`${STRAVA_API_URL}/athlete/activities?after=${treintaDiasAtras}&per_page=100`, {
                    headers: {
                        'Authorization': `Bearer ${datosUsuario.stravaAccessToken}`
                    }
                });

                if (!response.ok) throw new Error('Error obteniendo actividades');

                const actividades = await response.json();
                let kmActualizados = 0;

                // Agrupar actividades por bici
                const kmPorBici = {};
                actividades.forEach(act => {
                    if (act.gear_id) {
                        if (!kmPorBici[act.gear_id]) {
                            kmPorBici[act.gear_id] = 0;
                        }
                        kmPorBici[act.gear_id] += act.distance / 1000; // Convertir a km
                    }
                });

                // Actualizar bicis vinculadas
                datosUsuario.garaje.forEach(bici => {
                    if (bici.stravaBiciId && kmPorBici[bici.stravaBiciId]) {
                        const kmNuevos = Math.round(kmPorBici[bici.stravaBiciId]);
                        if (kmNuevos > 0) {
                            bici.kmTotales += kmNuevos;
                            kmActualizados += kmNuevos;
                        }
                    }
                });

                if (kmActualizados > 0) {
                    await guardarDatosUsuario();
                    mostrarNotificacion(`‚úÖ ${kmActualizados} km sincronizados`, 'exito');
                    if (biciActual) {
                        cargarTaller();
                    }
                } else {
                    mostrarNotificacion('No hay km nuevos para sincronizar', 'info');
                }
            } catch (error) {
                console.error('Error sincronizando:', error);
                mostrarNotificacion('Error al sincronizar con Strava', 'error');
            }
        }

        // Abrir modal para vincular bici con Strava
        function accionStravaBici() {
            if (biciActual && biciActual.stravaBiciId) {
                desvinculaBiciStrava();
            } else {
                abrirModalVincularStrava();
            }
        }

        async function desvinculaBiciStrava() {
            confirmar(
                '¬øDesvincular bici de Strava?',
                `Se quitar√° la vinculaci√≥n de "${biciActual.alias}" con Strava. Los KM actuales se conservan.`,
                async () => {
                    const biciIndex = datosUsuario.garaje.findIndex(b => b.id === biciActual.id);
                    if (biciIndex !== -1) {
                        delete datosUsuario.garaje[biciIndex].stravaBiciId;
                        delete datosUsuario.garaje[biciIndex].stravaBiciNombre;
                        biciActual = datosUsuario.garaje[biciIndex];
                        await guardarDatosUsuario();
                        cargarTaller();
                        mostrarNotificacion('Bici desvinculada de Strava', 'info');
                    }
                }
            );
        }

        async function abrirModalVincularStrava() {
            if (!biciActual) return;

            // Verificar si est√° conectado con Strava
            if (!datosUsuario.stravaAccessToken) {
                document.getElementById('vincular-strava-no-conectado').style.display = 'block';
                document.getElementById('vincular-strava-conectado').style.display = 'none';
                abrirModal('modal-vincular-strava');
                return;
            }

            // Renovar token si es necesario
            if (!await renovarTokenStrava()) {
                mostrarNotificacion('Error: Token de Strava expirado. Reconecta tu cuenta.', 'error');
                return;
            }

            try {
                // Obtener bicis de Strava usando el endpoint correcto
                const response = await fetch(`${STRAVA_API_URL}/athlete`, {
                    headers: {
                        'Authorization': `Bearer ${datosUsuario.stravaAccessToken}`
                    }
                });

                if (!response.ok) {
                    console.error('Response no OK:', response.status, response.statusText);
                    throw new Error('Error obteniendo datos del atleta');
                }

                const atleta = await response.json();
                console.log('Datos del atleta:', atleta);
                
                // Obtener actividades recientes para extraer los gear_id
                const activitiesResponse = await fetch(`${STRAVA_API_URL}/athlete/activities?per_page=100`, {
                    headers: {
                        'Authorization': `Bearer ${datosUsuario.stravaAccessToken}`
                    }
                });
                
                if (!activitiesResponse.ok) {
                    throw new Error('Error obteniendo actividades');
                }
                
                const actividades = await activitiesResponse.json();
                console.log('Actividades obtenidas:', actividades.length);
                
                // Extraer gear_ids √∫nicos
                const gearIds = new Set();
                actividades.forEach(act => {
                    if (act.gear_id) {
                        gearIds.add(act.gear_id);
                    }
                });
                
                console.log('IDs de bicis √∫nicos encontrados:', Array.from(gearIds));
                
                // Obtener detalles de cada bici
                const bicis = [];
                for (const gearId of gearIds) {
                    try {
                        const gearResponse = await fetch(`${STRAVA_API_URL}/gear/${gearId}`, {
                            headers: {
                                'Authorization': `Bearer ${datosUsuario.stravaAccessToken}`
                            }
                        });
                        
                        if (gearResponse.ok) {
                            const gear = await gearResponse.json();
                            bicis.push({
                                id: gear.id,
                                name: gear.name,
                                brand_name: gear.brand_name || '',
                                model_name: gear.model_name || '',
                                distance: gear.distance || 0
                            });
                            console.log('Bici obtenida:', gear.name);
                        }
                    } catch (error) {
                        console.error('Error obteniendo detalles de gear', gearId, error);
                    }
                }
                
                console.log('Total bicis con detalles:', bicis.length);
                
                const select = document.getElementById('vincular-strava-select');
                select.innerHTML = '<option value="">-- No vincular / Desvincular --</option>';

                if (bicis.length > 0) {
                    console.log('A√±adiendo', bicis.length, 'bicis al select');
                    bicis.forEach(bici => {
                        const option = document.createElement('option');
                        option.value = bici.id;
                        const km = Math.round(bici.distance / 1000);
                        const nombreLimpio = `${bici.name}${bici.brand_name ? ' - ' + bici.brand_name + ' ' + bici.model_name : ''}`;
                        option.textContent = `${nombreLimpio} (${km} km)`;
                        option.dataset.nombre = nombreLimpio;
                        if (biciActual.stravaBiciId === bici.id) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                } else {
                    console.log('No se encontraron bicis en el perfil de Strava');
                }

                // Mostrar vinculaci√≥n actual si existe
                if (biciActual.stravaBiciId) {
                    document.getElementById('vincular-bici-actual').style.display = 'block';
                    document.getElementById('vincular-bici-actual-nombre').textContent = biciActual.stravaBiciNombre || 'Bici de Strava';
                } else {
                    document.getElementById('vincular-bici-actual').style.display = 'none';
                }

                document.getElementById('vincular-bici-nombre').textContent = biciActual.alias;
                document.getElementById('vincular-strava-no-conectado').style.display = 'none';
                document.getElementById('vincular-strava-conectado').style.display = 'block';
                abrirModal('modal-vincular-strava');
            } catch (error) {
                console.error('Error obteniendo bicis de Strava:', error);
                mostrarNotificacion('Error al obtener bicis de Strava', 'error');
            }
        }

        // Guardar vinculaci√≥n de bici con Strava
        async function guardarVinculacionStrava() {
            const select = document.getElementById('vincular-strava-select');
            const stravaBiciId = select.value;

            if (stravaBiciId) {
                const selectedOption = select.options[select.selectedIndex];
                biciActual.stravaBiciId = stravaBiciId;
                biciActual.stravaBiciNombre = selectedOption.dataset.nombre || selectedOption.textContent;
                mostrarNotificacion('Bici vinculada con Strava', 'exito');
            } else {
                delete biciActual.stravaBiciId;
                delete biciActual.stravaBiciNombre;
                mostrarNotificacion('Vinculaci√≥n eliminada', 'info');
            }

            await guardarDatosUsuario();
            cerrarModal('modal-vincular-strava');
            cargarTaller();
        }

        // Actualizar visualizaci√≥n de estado de Strava en perfil
        function actualizarEstadoStrava() {
            const conectado = datosUsuario && datosUsuario.stravaAccessToken;
            
            if (conectado) {
                document.getElementById('strava-desconectado').style.display = 'none';
                document.getElementById('strava-conectado').style.display = 'block';
                document.getElementById('strava-cargando').style.display = 'none';
                document.getElementById('strava-atleta-nombre').textContent = datosUsuario.stravaAtletaNombre || 'Atleta';
            } else {
                document.getElementById('strava-desconectado').style.display = 'block';
                document.getElementById('strava-conectado').style.display = 'none';
                document.getElementById('strava-cargando').style.display = 'none';
            }
        }

        // ========================================
        // INICIALIZACI√ìN AL CARGAR
        // ========================================
        window.onload = () => {
            // Detectar callback de Strava
            const urlParams = new URLSearchParams(window.location.search);
            const stravaCode = urlParams.get('code');
            const stravaState = urlParams.get('state');

            // Escuchar cambios en el estado de autenticaci√≥n
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Usuario autenticado
                    usuarioActual = user;
                    await cargarDatosUsuario(user.uid);
                    
                    // Procesar callback de Strava si existe
                    if (stravaCode && stravaState === 'strava_auth') {
                        await procesarCallbackStrava(stravaCode);
                        navegar('sec-perfil');
                    } else {
                        navegar('sec-dashboard');
                    }
                } else {
                    // No hay usuario autenticado
                    usuarioActual = null;
                    datosUsuario = null;
                    navegar('sec-login');
                }
            });
        };

    </script>

</body>
</html>
